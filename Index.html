<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Orion Gem Bank ‚Äî Universal</title>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    *{box-sizing:border-box;font-family:'Fredoka',sans-serif}
    :root{
      --bgA:#9ec5ff;
      --bgB:#b9d7ff;

      --card:#ffffff;
      --soft:#f6f6f6;
      --stroke:rgba(0,0,0,.10);
      --stroke2:rgba(0,0,0,.06);

      --orange:#ff9f1c;
      --blue:#4dabf7;
      --green:#3adb76;
      --red:#ff4d6d;

      --ink:#121212;
      --muted:#666;

      --shadow:0 18px 50px rgba(0,0,0,.18);
      --shadow2:0 14px 34px rgba(0,0,0,.12);

      --r1:26px;
      --r2:22px;
      --r3:18px;
      --r4:14px;

      --sidebarW: 340px;
      --maxW: 1400px;
    }

    body{
      margin:0;
      min-height:100vh;
      background:linear-gradient(135deg,var(--bgA),var(--bgB));
      color:var(--ink);
      overflow-x:hidden;
    }

    /* ====== Desktop Layout ====== */
    .layout{
      display:grid;
      grid-template-columns: var(--sidebarW) 1fr;
      min-height:100vh;
    }

    /* ====== Sidebar ====== */
    .sidebar{
      position:sticky;
      top:0;
      height:100vh;
      padding:18px 16px;
      background:rgba(255,255,255,.85);
      backdrop-filter: blur(10px);
      border-right:2px solid rgba(0,0,0,.08);
      box-shadow: 14px 0 40px rgba(0,0,0,.12);
      overflow:auto;
    }

    .brand{
      background:var(--orange);
      color:#fff;
      border-radius:22px;
      padding:14px 14px;
      font-weight:1000;
      font-size:20px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      box-shadow:0 14px 26px rgba(255,159,28,.25);
      position:relative;
      overflow:hidden;
    }
    .brand:before{
      content:"";
      position:absolute;
      width:220px;height:220px;
      right:-120px; top:-120px;
      background:rgba(255,255,255,.20);
      border-radius:70px;
      transform:rotate(18deg);
    }
    .brand span{position:relative; z-index:2}

    .sideBlock{
      margin-top:14px;
      background:#fff;
      border:1px solid var(--stroke2);
      border-radius:22px;
      padding:12px;
      box-shadow:var(--shadow2);
    }

    .sideTitle{font-weight:1000;margin:4px 0 10px;font-size:16px}
    .sideSub{font-size:12px;color:var(--muted);font-weight:900}

    .nav{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .nav button{
      width:100%;
      text-align:left;
      border:none;
      cursor:pointer;
      padding:12px 12px;
      border-radius:18px;
      font-weight:1000;
      background:#f4f4f4;
      border:1px solid rgba(0,0,0,.10);
      transition: transform .08s ease, background .2s ease, box-shadow .2s ease;
    }
    .nav button:hover{box-shadow:0 10px 20px rgba(0,0,0,.10)}
    .nav button:active{transform:translateY(1px)}
    .nav button.active{
      background:var(--blue);
      color:#fff;
      border-color: rgba(77,171,247,.45);
      box-shadow:0 14px 26px rgba(77,171,247,.22);
    }

    .nav .adminOnly{display:none}
    .nav .adminOnly.show{display:block}

    .sideActions{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }

    .btn{
      border:none;
      cursor:pointer;
      border-radius:18px;
      padding:12px 12px;
      font-weight:1000;
      box-shadow:0 14px 26px rgba(0,0,0,.12);
      transition:transform .08s ease, filter .2s ease;
    }
    .btn:active{transform:translateY(1px)}
    .btn.orange{background:var(--orange);color:#fff}
    .btn.gray{background:#f1f1f1;color:#111;border:1px solid rgba(0,0,0,.10);box-shadow:none}
    .btn.red{background:var(--red);color:#fff}
    .btn.green{background:var(--green);color:#fff}
    .btn.blue{background:var(--blue);color:#fff}
    .btn.small{padding:10px 10px;border-radius:14px;font-size:12px;box-shadow:none;border:1px solid rgba(0,0,0,.10)}
    .btn.small.blue{background:rgba(77,171,247,.16);color:#0d3a66}
    .btn.small.red{background:rgba(255,77,109,.16);color:#7a0f2a}
    .btn.small.green{background:rgba(58,219,118,.16);color:#0a5a2f}
    .btn.small.orange{background:rgba(255,159,28,.16);color:#6a3a00}

    /* ====== Main ====== */
    .main{
      padding:22px 22px 28px 22px;
      max-width: var(--maxW);
    }

    .topRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      margin-bottom:14px;
    }

    .welcomeCard{
      flex:1;
      background:rgba(255,255,255,.86);
      border:1px solid rgba(0,0,0,.08);
      border-radius:26px;
      padding:16px 16px;
      box-shadow:var(--shadow2);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .welcomeTitle{
      font-size:22px;
      font-weight:1000;
      margin:0;
      line-height:1.1;
    }
    .welcomeSub{
      margin-top:6px;
      font-size:13px;
      font-weight:900;
      color:var(--muted);
    }
    .statusPill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:999px;
      background:#fff;
      border:1px solid rgba(0,0,0,.10);
      font-weight:1000;
      white-space:nowrap;
    }

    /* Profile panel rectangle */
    .profilePanel{
      background:#fff;
      border-radius:26px;
      border:3px solid rgba(255,159,28,.55);
      box-shadow:var(--shadow);
      padding:14px;
      display:flex;
      align-items:center;
      gap:14px;
      min-width: 560px;
    }

    .avatar{
      width:74px;height:74px;
      border-radius:20px;
      background:#e9e9e9;
      border:2px solid rgba(0,0,0,.10);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      flex:0 0 auto;
      position:relative;
    }

    .avatar.placeholder{
      background:#dcdcdc;
      border:2px solid transparent;
    }
    .avatar.placeholder:before{
      content:"";
      position:absolute;
      inset:-4px;
      border-radius:24px;
      background:
        repeating-linear-gradient(90deg,
          rgba(0,0,0,.25) 0 10px,
          rgba(0,0,0,0) 10px 18px);
      -webkit-mask:
        linear-gradient(#000 0 0) content-box,
        linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      padding:6px;
      opacity:.8;
      animation: dashMove 1.2s linear infinite;
    }
    @keyframes dashMove{ to{ transform:translateX(18px); } }

    .avatar img{width:100%;height:100%;object-fit:cover;display:block}

    /* Frames */
    .frame{
      position:absolute; inset:-4px;
      border-radius:26px;
      pointer-events:none;
      border:4px solid transparent;
    }
    .frame.celestial{
      border-color: rgba(255,215,0,.9);
      filter: drop-shadow(0 0 10px rgba(255,215,0,.45));
      animation: glow 1.2s ease-in-out infinite alternate;
    }
    @keyframes glow{
      from{ filter: drop-shadow(0 0 6px rgba(255,215,0,.35)); }
      to{ filter: drop-shadow(0 0 14px rgba(255,215,0,.65)); }
    }
    .frame.cosmic{ border-color: rgba(156,61,255,.85); filter: drop-shadow(0 0 10px rgba(156,61,255,.35)); }
    .frame.master{ border-color: rgba(58,219,118,.7); }
    .frame.boss{ border-color: rgba(255,159,28,.75); }
    .frame.elite{ border-color: rgba(77,171,247,.75); }
    .frame.grinder{ border-color: rgba(77,171,247,.45); }
    .frame.starter{ border-color: rgba(0,0,0,.14); }

    .pInfo{flex:1;min-width:0}
    .pName{font-size:18px;font-weight:1000;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .pMeta{margin-top:6px;display:flex;gap:10px;flex-wrap:wrap}
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      background:var(--soft);
      border:1px solid rgba(0,0,0,.10);
      font-weight:1000;
      font-size:12px;
    }
    .pill.blue{background:rgba(77,171,247,.16);border-color:rgba(77,171,247,.30)}
    .pill.orange{background:rgba(255,159,28,.18);border-color:rgba(255,159,28,.35)}
    .pill.green{background:rgba(58,219,118,.18);border-color:rgba(58,219,118,.35)}
    .pill.red{background:rgba(255,77,109,.18);border-color:rgba(255,77,109,.35)}
    .pill.purple{background:rgba(156,61,255,.16);border-color:rgba(156,61,255,.32)}

    .balanceLine{
      margin-top:10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px 12px;
      border-radius:18px;
      background:linear-gradient(135deg, rgba(77,171,247,.16), rgba(255,159,28,.18));
      border:1px solid rgba(0,0,0,.08);
    }
    .balLabel{font-weight:1000}
    .balValue{font-weight:1000;font-size:18px}

    /* Content grid */
    .contentGrid{
      display:grid;
      grid-template-columns: 1.4fr 1fr;
      gap:16px;
      margin-top:16px;
    }

    .panel{
      background:rgba(255,255,255,.88);
      border:1px solid rgba(0,0,0,.08);
      border-radius:26px;
      box-shadow:var(--shadow2);
      padding:14px;
    }
    .panelHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
    }
    .panelTitle{font-size:18px;font-weight:1000;margin:0}
    .panelSub{font-size:12px;font-weight:900;color:var(--muted);margin-top:6px}
    .divider{height:1px;background:rgba(0,0,0,.10);margin:12px 0}

    /* Forms */
    label{font-size:13px;font-weight:1000}
    input, textarea{
      width:100%;
      border-radius:16px;
      border:1px solid rgba(0,0,0,.12);
      padding:12px 12px;
      font-weight:800;
      margin-top:8px;
      outline:none;
      background:#fff;
    }
    textarea{min-height:120px;resize:vertical}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .error{color:#b00020;font-weight:1000;font-size:12px;margin-top:8px}

    /* List items */
    .list{display:flex;flex-direction:column;gap:10px;margin-top:8px}
    .item{
      display:flex;
      align-items:center;
      gap:12px;
      background:#f1f1f1;
      border:1px solid rgba(0,0,0,.08);
      border-radius:18px;
      padding:12px;
    }
    .iIcon{
      width:46px;height:46px;
      border-radius:16px;
      background:#fff;
      border:1px solid rgba(0,0,0,.10);
      box-shadow:0 10px 20px rgba(0,0,0,.10);
      display:flex;align-items:center;justify-content:center;
      font-size:18px;
      flex:0 0 auto;
    }
    .iMain{flex:1;min-width:0}
    .iTop{font-weight:1000;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .iSub{font-size:12px;color:var(--muted);font-weight:900;margin-top:4px}
    .iAmt{font-weight:1000;white-space:nowrap}
    .pos{color:#0a7a3a}
    .neg{color:#b00020}

    /* Views */
    .view{display:none}
    .view.show{display:block}

    /* Modal */
    .modal{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.6);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:50;
    }
    .modalBox{
      width:min(860px, 100%);
      background:#fff;
      border-radius:22px;
      border:1px solid rgba(0,0,0,.10);
      box-shadow:0 18px 60px rgba(0,0,0,.30);
      padding:14px;
      position:relative;
      max-height: 86vh;
      overflow:auto;
    }
    .modalTitle{font-size:18px;font-weight:1000;text-align:center;margin:6px 0}
    .modalSub{font-size:12px;font-weight:900;color:var(--muted);text-align:center;margin-bottom:10px}
    .closeX{
      position:absolute;
      right:-12px; top:-12px;
      width:44px;height:44px;
      border-radius:16px;
      border:2px solid rgba(0,0,0,.15);
      background:var(--red);
      color:#fff;
      font-weight:1000;
      font-size:22px;
      cursor:pointer;
      box-shadow:0 12px 24px rgba(0,0,0,.20);
    }

    /* Leaderboard */
    .podium{
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:12px;
      margin-top:10px;
    }
    .pod{
      background:#fff;
      border:1px solid rgba(0,0,0,.08);
      border-radius:22px;
      box-shadow:var(--shadow2);
      padding:12px;
      display:flex;
      align-items:center;
      gap:12px;
      min-height:86px;
    }
    .pod .circle{
      width:58px;height:58px;border-radius:999px;
      background:#e9e9e9;border:2px solid rgba(0,0,0,.10);
      overflow:hidden; position:relative; flex:0 0 auto;
    }
    .pod .circle img{width:100%;height:100%;object-fit:cover}
    .pod .name{font-weight:1000;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .pod .meta{font-size:12px;font-weight:900;color:var(--muted);margin-top:4px}

    /* Blog grid */
    .blogGrid{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:12px;
      margin-top:10px;
    }
    .blogCard{
      background:#fff;
      border:1px solid rgba(0,0,0,.08);
      border-radius:22px;
      box-shadow:var(--shadow2);
      overflow:hidden;
      cursor:pointer;
      transition: transform .08s ease, box-shadow .2s ease;
    }
    .blogCard:hover{box-shadow:0 18px 30px rgba(0,0,0,.12)}
    .blogCard:active{transform:translateY(1px)}
    .blogCover{
      width:100%;
      height:130px;
      background:linear-gradient(135deg, rgba(77,171,247,.22), rgba(255,159,28,.22));
      overflow:hidden;
    }
    .blogCover img{width:100%;height:100%;object-fit:cover;display:block}
    .blogBody{padding:12px}
    .blogTitle{font-weight:1000}
    .blogPreview{margin-top:6px;font-size:12px;font-weight:900;color:var(--muted);line-height:1.35}
    .blogMeta{margin-top:10px;font-size:11px;font-weight:1000;color:#555}

    .postBanner{
      width:100%;
      height:220px;
      border-radius:18px;
      overflow:hidden;
      background:#efefef;
      border:1px solid rgba(0,0,0,.08);
    }
    .postBanner img{width:100%;height:100%;object-fit:cover;display:block}
    .postFlow{margin-top:12px;display:flex;flex-direction:column;gap:12px}
    .flowP{
      background:#fff;
      border:1px solid rgba(0,0,0,.08);
      border-radius:18px;
      padding:12px;
      font-weight:800;
      line-height:1.55;
      color:#1a1a1a;
    }
    .flowImg{
      width:100%;
      height:240px;
      border-radius:18px;
      overflow:hidden;
      border:1px solid rgba(0,0,0,.08);
      background:#f1f1f1;
    }
    .flowImg img{width:100%;height:100%;object-fit:cover;display:block}

    /* Events */
    .comingSoonBig{
      display:flex;
      align-items:center;
      justify-content:center;
      height:320px;
      border-radius:26px;
      background:rgba(255,255,255,.88);
      border:1px solid rgba(0,0,0,.08);
      box-shadow:var(--shadow2);
      font-size:44px;
      font-weight:1000;
      letter-spacing:2px;
    }
    .broadcastCard{
      display:flex;
      align-items:center;
      gap:12px;
      background:#fff;
      border:1px solid rgba(0,0,0,.08);
      border-radius:22px;
      padding:12px;
      box-shadow:var(--shadow2);
    }
    .bcAvatar{
      width:54px;height:54px;border-radius:999px;
      background:#e9e9e9;border:2px solid rgba(0,0,0,.10);
      overflow:hidden;flex:0 0 auto;
    }
    .bcAvatar img{width:100%;height:100%;object-fit:cover}
    .bcMain{flex:1;min-width:0}
    .bcTop{font-weight:1000;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .bcText{margin-top:6px;font-weight:900;color:#333;line-height:1.35}
    .bcTime{margin-top:6px;font-size:12px;font-weight:900;color:var(--muted)}

    @media (max-width: 1100px){
      :root{ --sidebarW: 300px; }
      .profilePanel{min-width:unset}
      .contentGrid{grid-template-columns:1fr;}
      .blogGrid{grid-template-columns:repeat(2,1fr);}
    }
    @media (max-width: 820px){
      .layout{grid-template-columns:1fr;}
      .sidebar{position:relative;height:auto}
      .topRow{flex-direction:column;align-items:stretch}
      .blogGrid{grid-template-columns:1fr;}
    }
  </style>
</head>

<body>
  <div class="layout">

    <!-- LEFT SIDEBAR -->
    <aside class="sidebar">
      <div class="brand">
        <span>Orion Bank üíé</span>
        <span style="font-weight:1000;opacity:.95">Universal</span>
      </div>

      <div class="sideBlock">
        <div class="sideTitle">Navigation</div>
        <div class="sideSub">All users ‚Ä¢ admin unlocks extra</div>

        <div class="nav">
          <button id="nav_dash" class="active" onclick="switchView('dash')">üè† Dashboard</button>
          <button id="nav_bank" onclick="switchView('bank')">üè¶ Bank</button>
          <button id="nav_requests" onclick="switchView('requests')">üì• Requests</button>
          <button id="nav_leaderboard" onclick="switchView('leaderboard')">üèÜ Leaderboard</button>
          <button id="nav_blogs" onclick="switchView('blogs')">üì∞ Blogs</button>
          <button id="nav_redeem" onclick="switchView('redeem')">üéÅ Redeem Codes</button>
          <button id="nav_events" onclick="switchView('events')">üî• Events</button>

          <button id="nav_admin" class="adminOnly" onclick="switchView('admin')">üõ†Ô∏è Admin Panel</button>
        </div>

        <div class="divider"></div>

        <div class="sideTitle">Account</div>
        <div class="sideActions">
          <button class="btn orange" onclick="openAuth()">Login</button>
          <button class="btn blue" onclick="openAuth(true)">Register</button>
        </div>
        <button class="btn red" style="width:100%;margin-top:10px;display:none" id="logoutBtn" onclick="logout()">Logout</button>

        <div class="divider"></div>
        <div class="sideSub" id="sideUser">Not signed in</div>
      </div>

      <div class="sideBlock">
        <div class="sideTitle">Status</div>
        <div class="sideSub" id="modeText">Guest Mode</div>
        <div class="sideSub" id="adminText" style="margin-top:6px">Admin: ‚Äî</div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">

      <!-- TOP ROW -->
      <div class="topRow">
        <div class="welcomeCard">
          <div>
            <h1 class="welcomeTitle" id="welcomeTitle">Welcome to Orion üíé</h1>
            <div class="welcomeSub" id="welcomeSub">Login to access your bank profile.</div>
          </div>
          <div class="statusPill">
            <span>üõ°Ô∏è</span>
            <span id="statusPill">Guest UI</span>
          </div>
        </div>

        <!-- PROFILE RECTANGLE PANEL -->
        <div class="profilePanel">
          <div class="avatar placeholder" id="avatarBox"></div>

          <div class="pInfo">
            <div class="pName" id="pName">Guest</div>

            <div class="pMeta">
              <span class="pill orange" id="rolePill">Role: ‚Äî</span>
              <span class="pill blue" id="idPill">ID: ‚Äî</span>
              <span class="pill purple" id="flagsPill" style="display:none">Flags</span>
            </div>

            <div class="balanceLine">
              <div class="balLabel">Balance</div>
              <div class="balValue" id="balText">0 üíé</div>
            </div>
          </div>
        </div>
      </div>

      <!-- VIEWS -->

      <!-- DASH -->
      <div class="view show" id="view_dash">
        <div class="contentGrid">
          <section class="panel">
            <div class="panelHeader">
              <div>
                <h2 class="panelTitle">Overview</h2>
                <div class="panelSub">Universal build ‚Ä¢ API connected</div>
              </div>
              <span class="pill green" id="dashReady">Ready</span>
            </div>

            <div class="row2">
              <div class="panel" style="padding:12px;border-radius:22px;background:#fff;border:1px solid rgba(0,0,0,.08)">
                <div style="font-weight:1000">Your Gems</div>
                <div style="margin-top:8px;font-size:26px;font-weight:1000" id="dashBal">0 üíé</div>
                <div class="panelSub" style="margin-top:8px">Use Requests, Send, Redeem Codes, Events.</div>
              </div>
              <div class="panel" style="padding:12px;border-radius:22px;background:#fff;border:1px solid rgba(0,0,0,.08)">
                <div style="font-weight:1000">Your Rank</div>
                <div style="margin-top:8px;font-size:22px;font-weight:1000" id="dashRole">‚Äî</div>
                <div class="panelSub" style="margin-top:8px">Frames & badges follow your role.</div>
              </div>
            </div>

            <div class="divider"></div>

            <div class="panelSub" style="font-weight:1000">Recent Activity</div>
            <div class="list" id="txList"></div>
            <div class="panelSub" id="txEmpty" style="display:none;margin-top:8px">No activity yet.</div>
          </section>

          <section class="panel">
            <div class="panelHeader">
              <div>
                <h2 class="panelTitle">Quick Actions</h2>
                <div class="panelSub">Fast controls</div>
              </div>
              <span class="pill orange">üíé</span>
            </div>

            <button class="btn green" style="width:100%" onclick="openReq('deposit')">+ Deposit Request</button>
            <button class="btn orange" style="width:100%;margin-top:10px" onclick="openReq('withdraw')">- Withdraw Request</button>
            <button class="btn blue" style="width:100%;margin-top:10px" onclick="switchView('redeem')">üéÅ Redeem Codes</button>
            <button class="btn orange" style="width:100%;margin-top:10px" onclick="switchView('events')">üî• Events</button>

            <div class="divider"></div>

            <div class="panelSub" style="font-weight:1000">Tip</div>
            <div class="panelSub">If you get ‚ÄúUnauthorized‚Äù, just Login again (tokens are per browser).</div>
          </section>
        </div>
      </div>

      <!-- BANK (Send + Wallet + Profile merged) -->
      <div class="view" id="view_bank">
        <div class="contentGrid">
          <section class="panel">
            <div class="panelHeader">
              <div>
                <h2 class="panelTitle">Send Gems</h2>
                <div class="panelSub">Transfers between registered users</div>
              </div>
              <span class="pill orange">üì§</span>
            </div>

            <div class="row2">
              <div>
                <label>To Username</label>
                <input id="sendTo" placeholder="e.g ItalyCrazyCat">
              </div>
              <div>
                <label>Amount</label>
                <input id="sendAmt" placeholder="e.g 5M / 250K / 5000000">
              </div>
            </div>

            <button class="btn blue" style="width:220px;margin-top:12px" onclick="sendGems()">Send</button>
            <div class="error" id="sendErr"></div>

            <div class="divider"></div>
            <div class="panelSub" style="font-weight:1000">Your Requests</div>
            <div class="list" id="myReqList"></div>
            <div class="panelSub" id="myReqEmpty" style="display:none">No requests yet.</div>
          </section>

          <section class="panel">
            <div class="panelHeader">
              <div>
                <h2 class="panelTitle">Profile</h2>
                <div class="panelSub">Avatar + role info</div>
              </div>
              <span class="pill blue">üë§</span>
            </div>

            <div class="panel" style="padding:12px;border-radius:22px;background:#fff;border:1px solid rgba(0,0,0,.08)">
              <div style="font-weight:1000">Avatar</div>
              <div class="panelSub" style="margin-top:8px">Use a smaller image if upload fails.</div>
              <input type="file" id="avatarInput" accept="image/*" />
              <button class="btn gray" style="width:220px;margin-top:10px" onclick="saveAvatar()">Save Avatar</button>
            </div>

            <div class="divider"></div>

            <div class="panel" style="padding:12px;border-radius:22px;background:#fff;border:1px solid rgba(0,0,0,.08)">
              <div style="font-weight:1000">Rank Rules</div>
              <div class="panelSub" style="margin-top:10px;line-height:1.6">
                0 üíé ‚Üí Starter<br>
                1M+ üíé ‚Üí Grinder<br>
                50M+ üíé ‚Üí Elite<br>
                250M+ üíé ‚Üí Boss<br>
                2B+ üíé ‚Üí Master<br>
                20B+ üíé ‚Üí Cosmic<br>
                70B+ üíé ‚Üí Celestial (shining frame)
              </div>
            </div>
          </section>
        </div>
      </div>

      <!-- REQUESTS -->
      <div class="view" id="view_requests">
        <section class="panel">
          <div class="panelHeader">
            <div>
              <h2 class="panelTitle">All Requests</h2>
              <div class="panelSub">Admins can approve/decline</div>
            </div>
            <span class="pill green">üì•</span>
          </div>

          <div class="list" id="allReqList"></div>
          <div class="panelSub" id="allReqEmpty" style="display:none">No requests yet.</div>
        </section>
      </div>

      <!-- LEADERBOARD -->
      <div class="view" id="view_leaderboard">
        <section class="panel">
          <div class="panelHeader">
            <div>
              <h2 class="panelTitle">Leaderboard</h2>
              <div class="panelSub">Top players by balance</div>
            </div>
            <span class="pill orange">üèÜ</span>
          </div>

          <div class="podium" id="podium"></div>

          <div class="divider"></div>

          <div class="list" id="lbList"></div>
          <div class="panelSub" id="lbEmpty" style="display:none">No users yet.</div>
        </section>
      </div>

      <!-- BLOGS -->
      <div class="view" id="view_blogs">
        <section class="panel">
          <div class="panelHeader">
            <div>
              <h2 class="panelTitle">Blogs & Announcements</h2>
              <div class="panelSub">3 per row ‚Ä¢ click to expand</div>
            </div>
            <div style="display:flex;gap:10px;align-items:center">
              <button class="btn blue" id="newPostBtn" style="display:none" onclick="openPostEditor()">‚ûï New Post</button>
              <span class="pill blue">üì∞</span>
            </div>
          </div>

          <div class="blogGrid" id="blogGrid"></div>
          <div class="panelSub" id="blogEmpty" style="display:none">No posts yet.</div>
        </section>
      </div>

      <!-- REDEEM -->
      <div class="view" id="view_redeem">
        <div class="contentGrid">
          <section class="panel">
            <div class="panelHeader">
              <div>
                <h2 class="panelTitle">Redeem Codes</h2>
                <div class="panelSub">Codes give gems (once per user)</div>
              </div>
              <span class="pill orange">üéÅ</span>
            </div>

            <label>Enter Code</label>
            <input id="redeemInput" placeholder="e.g ORION500M">
            <button class="btn green" style="width:220px;margin-top:12px" onclick="redeemCode()">Redeem</button>
            <div class="error" id="redeemErr"></div>

            <div class="divider"></div>
            <div class="panelSub" style="font-weight:1000">Active Codes</div>
            <div class="list" id="codesList"></div>
            <div class="panelSub" id="codesEmpty" style="display:none">No active codes.</div>
          </section>

          <section class="panel" id="redeemAdminBox" style="display:none">
            <div class="panelHeader">
              <div>
                <h2 class="panelTitle">Admin: Manage Codes</h2>
                <div class="panelSub">Create / disable</div>
              </div>
              <span class="pill purple">ADMIN</span>
            </div>

            <div class="row3">
              <div>
                <label>Code</label>
                <input id="codeNew" placeholder="ORION500M">
              </div>
              <div>
                <label>Reward (gems)</label>
                <input id="codeReward" placeholder="500000000">
              </div>
              <div>
                <label>Uses</label>
                <input id="codeUses" placeholder="50">
              </div>
            </div>

            <button class="btn blue" style="width:240px;margin-top:12px" onclick="adminCreateCode()">Create Code</button>
            <div class="error" id="codeAdminErr"></div>

            <div class="divider"></div>

            <label>Disable Code</label>
            <input id="codeDisable" placeholder="ORION500M">
            <button class="btn red" style="width:240px;margin-top:12px" onclick="adminDisableCode()">Disable</button>
          </section>
        </div>
      </div>

      <!-- EVENTS -->
      <div class="view" id="view_events">
        <section class="panel">
          <div class="panelHeader">
            <div>
              <h2 class="panelTitle">Events</h2>
              <div class="panelSub">Admin-controlled ‚Ä¢ broadcast + mini games</div>
            </div>
            <span class="pill orange">üî•</span>
          </div>

          <div id="eventsBody"></div>

          <div id="eventsAdmin" style="display:none;margin-top:14px">
            <div class="divider"></div>
            <div class="panelHeader">
              <div>
                <h2 class="panelTitle">Admin Controls</h2>
                <div class="panelSub">Coming soon / countdown / engine / broadcast / guess game</div>
              </div>
              <span class="pill purple">ADMIN</span>
            </div>

            <div class="row3">
              <button class="btn gray" onclick="evComingSoon()">‚ö´ Coming Soon</button>
              <button class="btn orange" onclick="openCountdown()">‚è≥ Countdown</button>
              <button class="btn green" onclick="evEnable()">‚úÖ Enable Engine</button>
            </div>
            <button class="btn red" style="width:100%;margin-top:10px" onclick="evDisable()">üõë Disable Engine</button>

            <div class="divider"></div>

            <label>Broadcast Message</label>
            <input id="bcText" placeholder="Type announcement for Events tab...">
            <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap">
              <button class="btn blue" onclick="evBroadcast()">Send Broadcast</button>
              <button class="btn orange" onclick="evWinner()">Winner Message</button>
            </div>

            <div class="divider"></div>

            <div class="panelSub" style="font-weight:1000">Guess The Number</div>
            <div class="row3">
              <div>
                <label>Min</label>
                <input id="ggMin" placeholder="1">
              </div>
              <div>
                <label>Max</label>
                <input id="ggMax" placeholder="100">
              </div>
              <div>
                <label>Guesses/user</label>
                <input id="ggMaxGuesses" placeholder="3">
              </div>
            </div>
            <div class="row2" style="margin-top:10px">
              <div>
                <label>Duration (seconds)</label>
                <input id="ggDuration" placeholder="120">
              </div>
              <div style="display:flex;align-items:flex-end;gap:10px">
                <button class="btn gray" style="width:100%" onclick="ggSetup()">Save Setup</button>
              </div>
            </div>

            <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap">
              <button class="btn green" onclick="ggStart()">Start Round</button>
              <button class="btn red" onclick="ggEnd()">End Round</button>
            </div>

            <div class="error" id="eventsAdminErr"></div>
          </div>
        </section>
      </div>

      <!-- ADMIN PANEL -->
      <div class="view" id="view_admin">
        <section class="panel">
          <div class="panelHeader">
            <div>
              <h2 class="panelTitle">Admin Panel</h2>
              <div class="panelSub">Manage users ‚Ä¢ beta tester ‚Ä¢ (wipe is super-only)</div>
            </div>
            <span class="pill purple">ADMIN</span>
          </div>

          <div class="panelSub" style="font-weight:1000">Registered Users</div>
          <div class="list" id="usersList"></div>
          <div class="panelSub" id="usersEmpty" style="display:none">No users found.</div>

          <div class="divider"></div>

          <div id="wipeBox" style="display:none">
            <div class="panelSub" style="font-weight:1000;color:#7a0f2a">Danger Zone (Super Admin)</div>
            <div class="panelSub">This wipes the entire system (keeps default admins only).</div>
            <button class="btn red" style="width:100%;margin-top:10px" onclick="wipeSystem()">‚ö†Ô∏è WIPE EVERYTHING</button>
          </div>

          <div class="error" id="adminErr"></div>
        </section>
      </div>

    </main>
  </div>

  <!-- AUTH MODAL -->
  <div class="modal" id="authModal">
    <div class="modalBox" style="width:min(620px,100%)">
      <button class="closeX" onclick="closeAuth()">‚úï</button>
      <div class="modalTitle" id="authTitle">Login</div>
      <div class="modalSub" id="authSub">Sign in to access your balance and profile.</div>

      <div class="row2">
        <div>
          <label>Username</label>
          <input id="authUser" placeholder="e.g JRCHESSKID">
        </div>
        <div>
          <label>Password</label>
          <input id="authPass" type="password" placeholder="your password">
        </div>
      </div>

      <div class="error" id="authErr"></div>

      <div style="display:flex;gap:10px;justify-content:center;margin-top:12px">
        <button class="btn gray" style="width:160px" onclick="closeAuth()">Cancel</button>
        <button class="btn orange" style="width:160px" id="authActionBtn" onclick="login()">Login</button>
      </div>
    </div>
  </div>

  <!-- REQUEST MODAL -->
  <div class="modal" id="reqModal">
    <div class="modalBox" style="width:min(520px,100%)">
      <button class="closeX" onclick="closeReq()">‚úï</button>
      <div class="modalTitle" id="reqTitle">Request</div>
      <div class="modalSub">Creates a pending request</div>

      <label>Amount</label>
      <input id="reqAmt" placeholder="e.g 5M / 250K / 5000000">
      <div class="error" id="reqErr"></div>

      <div style="display:flex;gap:10px;justify-content:center;margin-top:12px">
        <button class="btn gray" style="width:160px" onclick="closeReq()">Cancel</button>
        <button class="btn green" style="width:160px" onclick="submitReq()">Submit</button>
      </div>
    </div>
  </div>

  <!-- POST VIEW MODAL -->
  <div class="modal" id="postModal">
    <div class="modalBox">
      <button class="closeX" onclick="closePost()">‚úï</button>
      <div class="modalTitle" id="postTitle">Post</div>
      <div class="modalSub" id="postMeta">‚Äî</div>

      <div class="postBanner" id="postBanner" style="display:none"></div>
      <div class="postFlow" id="postFlow"></div>

      <div id="postAdminActions" style="display:none;margin-top:14px">
        <div class="divider"></div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn orange" onclick="editOpenFromPost()">‚úèÔ∏è Edit</button>
          <button class="btn red" onclick="deletePost()">üóëÔ∏è Delete</button>
        </div>
      </div>

      <div class="divider"></div>

      <div class="panelSub" style="font-weight:1000">Comments</div>
      <div class="list" id="commentList"></div>
      <div class="panelSub" id="commentEmpty" style="display:none">No comments yet.</div>

      <div style="margin-top:12px">
        <label>Add Comment</label>
        <input id="commentInput" placeholder="Write a comment...">
        <button class="btn blue" style="width:200px;margin-top:10px" onclick="sendComment()">Post Comment</button>
        <div class="error" id="commentErr"></div>
      </div>
    </div>
  </div>

  <!-- POST EDITOR MODAL (Admin only) -->
  <div class="modal" id="editorModal">
    <div class="modalBox">
      <button class="closeX" onclick="closeEditor()">‚úï</button>
      <div class="modalTitle" id="editorTitle">New Post</div>
      <div class="modalSub">Continuous flow editor (text + images + youtube)</div>

      <div class="row2">
        <div>
          <label>Title</label>
          <input id="edTitle" placeholder="Daily Update / Leak / Announcement">
        </div>
        <div>
          <label>Cover Image (optional)</label>
          <input type="file" id="edCoverFile" accept="image/*">
        </div>
      </div>

      <div class="divider"></div>

      <div class="panelSub" style="font-weight:1000">Flow Content</div>
      <div class="panelSub">Use the buttons to insert banners / YouTube into the flow. Then write normally.</div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
        <button class="btn gray" onclick="edInsertImage()">üñºÔ∏è Insert Banner Image</button>
        <button class="btn gray" onclick="edInsertYoutube()">‚ñ∂Ô∏è Insert YouTube</button>
        <button class="btn gray" onclick="edInsertDivider()">‚Äî Divider</button>
      </div>

      <textarea id="edFlow" placeholder="Write your post here..."></textarea>

      <div class="error" id="edErr"></div>

      <div style="display:flex;gap:10px;justify-content:center;margin-top:12px;flex-wrap:wrap">
        <button class="btn gray" style="width:160px" onclick="closeEditor()">Cancel</button>
        <button class="btn orange" style="width:220px" onclick="savePost()">Save Post</button>
      </div>
    </div>
  </div>

<script>
/* =========================
   CONFIG
   ========================= */

// ‚úÖ PUT YOUR REPLIT BACKEND URL HERE:
const API_BASE = "https://YOUR-REPLIT-URL.replit.app";

// Token stored per browser (that‚Äôs why Chrome needs login again)
const TOKEN_KEY = "orion_token_v2";

// You asked: logged out by default on open
const FORCE_LOGOUT_ON_OPEN = true;

/* =========================
   STATE
   ========================= */
let sessionUser = null; // { username,id,balance,avatarDataUrl,role,roles:{adminLevel,betaTester} }
let db = { requests:[], tx:[], leaderboard:[], posts:[], events:null, codes:[] };

let view = "dash";
let pendingType = "deposit";

let currentPostId = "";
let currentPostData = null;

let editingPostId = ""; // "" = new post
let editorCoverDataUrl = "";

/* =========================
   HELPERS
   ========================= */
const $ = (id)=>document.getElementById(id);
function norm(s){ return (s||"").trim(); }
function fmt(n){ return (Number(n)||0).toLocaleString("en-US"); }
function timeAgo(ts){
  const mins = Math.floor((Date.now()-ts)/60000);
  if(mins < 1) return "Just now";
  if(mins < 60) return mins + " min ago";
  const hrs = Math.floor(mins/60);
  if(hrs < 24) return hrs + "h ago";
  const d = Math.floor(hrs/24);
  return d + "d ago";
}
function parseAmount(val){
  val = (val||"").toUpperCase().trim().replace(/,/g,"");
  if(!val) return NaN;
  if(val.endsWith("K")) return Math.floor(parseFloat(val.slice(0,-1))*1000);
  if(val.endsWith("M")) return Math.floor(parseFloat(val.slice(0,-1))*1000000);
  if(val.endsWith("B")) return Math.floor(parseFloat(val.slice(0,-1))*1000000000);
  const n = Number(val);
  return Number.isFinite(n) ? Math.floor(n) : NaN;
}
function roleFromBalance(b){
  b = Number(b)||0;
  if(b >= 70000000000) return "Celestial";
  if(b >= 20000000000) return "Cosmic";
  if(b >= 2000000000) return "Master";
  if(b >= 250000000)  return "Boss";
  if(b >= 50000000)   return "Elite";
  if(b >= 1000000)    return "Grinder";
  return "Starter";
}
function rolePillClass(role){
  if(role === "Celestial") return "pill green";
  if(role === "Cosmic") return "pill purple";
  if(role === "Master") return "pill green";
  if(role === "Boss") return "pill orange";
  if(role === "Elite") return "pill blue";
  if(role === "Grinder") return "pill blue";
  return "pill orange";
}
function frameClassByRole(role){
  if(role === "Celestial") return "celestial";
  if(role === "Cosmic") return "cosmic";
  if(role === "Master") return "master";
  if(role === "Boss") return "boss";
  if(role === "Elite") return "elite";
  if(role === "Grinder") return "grinder";
  return "starter";
}
function adminLabel(){
  if(!sessionUser?.roles?.adminLevel) return "‚Äî";
  const lvl = sessionUser.roles.adminLevel;
  if(lvl === "super") return "SUPER";
  if(lvl === "team") return "TEAM";
  return "‚Äî";
}

/* =========================
   API
   ========================= */
function getToken(){ return localStorage.getItem(TOKEN_KEY) || ""; }
function setToken(t){ localStorage.setItem(TOKEN_KEY, t); }
function clearToken(){ localStorage.removeItem(TOKEN_KEY); }

async function api(path, opts={}){
  const headers = Object.assign({ "Content-Type":"application/json" }, opts.headers||{});
  const t = getToken();
  if(t) headers.Authorization = "Bearer " + t;

  const res = await fetch(API_BASE + path, { ...opts, headers });
  const data = await res.json().catch(()=>({}));
  if(!res.ok) throw new Error(data.error || "Request failed");
  return data;
}

/* =========================
   VIEWS
   ========================= */
function switchView(v){
  view = v;
  ["dash","bank","requests","leaderboard","blogs","redeem","events","admin"].forEach(x=>{
    $("view_"+x).classList.remove("show");
    const n = $("nav_"+x);
    if(n) n.classList.remove("active");
  });
  $("view_"+v).classList.add("show");
  const n = $("nav_"+v);
  if(n) n.classList.add("active");
  renderAll();
}

/* =========================
   AUTH
   ========================= */
function openAuth(registerMode=false){
  $("authErr").textContent = "";
  $("authUser").value = "";
  $("authPass").value = "";
  $("authTitle").textContent = registerMode ? "Register" : "Login";
  $("authSub").textContent = registerMode
    ? "Create your account. Balance starts at 0 üíé."
    : "Sign in to access your balance and profile.";
  $("authActionBtn").textContent = registerMode ? "Register" : "Login";
  $("authActionBtn").onclick = registerMode ? register : login;
  $("authModal").style.display = "flex";
}
function closeAuth(){ $("authModal").style.display = "none"; }

async function register(){
  const u = norm($("authUser").value);
  const p = $("authPass").value || "";
  $("authErr").textContent = "";
  if(!u || !p){ $("authErr").textContent = "Enter username + password."; return; }

  try{
    await api("/api/register", { method:"POST", body: JSON.stringify({ username:u, password:p }) });
    const loginRes = await api("/api/login", { method:"POST", body: JSON.stringify({ username:u, password:p }) });
    setToken(loginRes.token);
    closeAuth();
    await refreshAll();
  }catch(err){
    $("authErr").textContent = err.message;
  }
}

async function login(){
  const u = norm($("authUser").value);
  const p = $("authPass").value || "";
  $("authErr").textContent = "";
  if(!u || !p){ $("authErr").textContent = "Enter username + password."; return; }

  try{
    const loginRes = await api("/api/login", { method:"POST", body: JSON.stringify({ username:u, password:p }) });
    setToken(loginRes.token);
    closeAuth();
    await refreshAll();
  }catch(err){
    $("authErr").textContent = err.message;
  }
}

async function logout(){
  try{ await api("/api/logout", { method:"POST" }); } catch {}
  clearToken();
  sessionUser = null;
  db = { requests:[], tx:[], leaderboard:[], posts:[], events:null, codes:[] };
  renderAll();
  switchView("dash");
}

/* =========================
   REQUESTS
   ========================= */
function openReq(type){
  pendingType = type;
  $("reqTitle").textContent = (type === "deposit" ? "Deposit Request" : "Withdraw Request");
  $("reqAmt").value = "";
  $("reqErr").textContent = "";
  $("reqModal").style.display = "flex";
}
function closeReq(){ $("reqModal").style.display = "none"; }

async function submitReq(){
  $("reqErr").textContent = "";
  if(!sessionUser){ $("reqErr").textContent = "Login first."; return; }
  const amt = parseAmount($("reqAmt").value);
  if(!Number.isFinite(amt) || amt <= 0){ $("reqErr").textContent = "Invalid amount."; return; }

  try{
    await api("/api/request", { method:"POST", body: JSON.stringify({ type: pendingType, amount: amt }) });
    closeReq();
    await refreshAll();
  }catch(err){
    $("reqErr").textContent = err.message;
  }
}

async function adminApproveRequest(id){
  try{
    await api("/api/admin/request/"+encodeURIComponent(id)+"/approve", { method:"POST" });
    await refreshAll();
  }catch(err){
    alert(err.message);
  }
}
async function adminDeclineRequest(id){
  try{
    await api("/api/admin/request/"+encodeURIComponent(id)+"/decline", { method:"POST" });
    await refreshAll();
  }catch(err){
    alert(err.message);
  }
}

/* =========================
   SEND
   ========================= */
async function sendGems(){
  $("sendErr").textContent = "";
  if(!sessionUser){ $("sendErr").textContent = "Login first."; return; }

  const to = norm($("sendTo").value);
  const amt = parseAmount($("sendAmt").value);

  if(!to){ $("sendErr").textContent = "Enter a recipient username."; return; }
  if(!Number.isFinite(amt) || amt <= 0){ $("sendErr").textContent = "Invalid amount."; return; }

  try{
    await api("/api/send", { method:"POST", body: JSON.stringify({ to, amount: amt }) });
    $("sendTo").value = "";
    $("sendAmt").value = "";
    await refreshAll();
    switchView("dash");
  }catch(err){
    $("sendErr").textContent = err.message;
  }
}

/* =========================
   AVATAR
   ========================= */
async function saveAvatar(){
  if(!sessionUser){ alert("Login first."); return; }
  const file = $("avatarInput").files[0];
  if(!file){ alert("Choose an image first."); return; }

  // client-side safety reduce huge uploads
  if(file.size > 1_200_000){
    alert("That image is too big. Use a smaller one (under ~1MB).");
    return;
  }

  const reader = new FileReader();
  reader.onload = async () => {
    try{
      await api("/api/avatar", { method:"POST", body: JSON.stringify({ avatarDataUrl: reader.result }) });
      await refreshAll();
      alert("Avatar saved.");
    }catch(err){
      alert(err.message);
    }
  };
  reader.readAsDataURL(file);
}

/* =========================
   LEADERBOARD
   ========================= */
async function refreshLeaderboard(){
  const r = await api("/api/leaderboard");
  db.leaderboard = r.list || [];
}

/* =========================
   BLOGS
   ========================= */
async function refreshPosts(){
  const r = await api("/api/posts");
  db.posts = r.list || [];
}

function openPostEditor(post=null){
  if(!sessionUser || !isAdmin()) return;

  editingPostId = post ? post.id : "";
  editorCoverDataUrl = post ? (post.coverImage||"") : "";

  $("editorTitle").textContent = post ? "Edit Post" : "New Post";
  $("edTitle").value = post ? (post.title||"") : "";
  $("edCoverFile").value = "";
  $("edFlow").value = post ? blocksToFlow(post.blocks||[]) : "";
  $("edErr").textContent = "";

  $("editorModal").style.display = "flex";
}

function closeEditor(){
  $("editorModal").style.display = "none";
}

function blocksToFlow(blocks){
  // converts blocks to text flow tokens:
  // [[img:DATAURL]]
  // [[yt:URL]]
  // [[hr]]
  const lines = [];
  for(const b of blocks){
    if(b.type === "text"){
      lines.push((b.text||"").trim());
      lines.push("");
    } else if(b.type === "image"){
      lines.push("[[img:"+(b.src||"")+"]]");
      lines.push("");
    } else if(b.type === "youtube"){
      lines.push("[[yt:"+(b.url||"")+"]]");
      lines.push("");
    } else if(b.type === "hr"){
      lines.push("[[hr]]");
      lines.push("");
    }
  }
  return lines.join("\n").trim();
}

function flowToBlocks(flowText){
  // parse tokens in one continuous flow:
  // [[img:...]]
  // [[yt:...]]
  // [[hr]]
  const blocks = [];
  const lines = (flowText||"").split("\n");

  let buf = [];
  function flushText(){
    const t = buf.join("\n").trim();
    buf = [];
    if(t) blocks.push({ type:"text", style:"p", text:t });
  }

  for(const raw of lines){
    const line = raw.trim();
    if(line.startsWith("[[img:") && line.endsWith("]]")){
      flushText();
      const src = line.slice(6, -2);
      blocks.push({ type:"image", src });
      continue;
    }
    if(line.startsWith("[[yt:") && line.endsWith("]]")){
      flushText();
      const url = line.slice(5, -2);
      blocks.push({ type:"youtube", url });
      continue;
    }
    if(line === "[[hr]]"){
      flushText();
      blocks.push({ type:"hr" });
      continue;
    }
    buf.push(raw);
  }
  flushText();
  return blocks;
}

async function edInsertImage(){
  if(!sessionUser || !isAdmin()) return;
  const picker = document.createElement("input");
  picker.type = "file";
  picker.accept = "image/*";
  picker.onchange = () => {
    const f = picker.files[0];
    if(!f) return;
    if(f.size > 1_500_000){
      alert("Image too big. Use a smaller banner image.");
      return;
    }
    const r = new FileReader();
    r.onload = () => {
      const token = `\n\n[[img:${r.result}]]\n\n`;
      $("edFlow").value += token;
      $("edFlow").focus();
    };
    r.readAsDataURL(f);
  };
  picker.click();
}

function edInsertYoutube(){
  const url = prompt("Paste YouTube URL:");
  if(!url) return;
  $("edFlow").value += `\n\n[[yt:${url.trim()}]]\n\n`;
  $("edFlow").focus();
}

function edInsertDivider(){
  $("edFlow").value += `\n\n[[hr]]\n\n`;
  $("edFlow").focus();
}

async function savePost(){
  if(!sessionUser || !isAdmin()) return;
  $("edErr").textContent = "";

  const title = norm($("edTitle").value);
  if(!title){ $("edErr").textContent = "Title required."; return; }

  // cover optional - if file selected, convert
  const coverFile = $("edCoverFile").files[0];
  if(coverFile){
    if(coverFile.size > 1_800_000){ $("edErr").textContent = "Cover too large."; return; }
    editorCoverDataUrl = await fileToDataUrl(coverFile);
  }

  const blocks = flowToBlocks($("edFlow").value);

  try{
    if(editingPostId){
      await api("/api/admin/posts/"+encodeURIComponent(editingPostId), {
        method:"PUT",
        body: JSON.stringify({ title, coverImage: editorCoverDataUrl || "", blocks })
      });
    }else{
      await api("/api/admin/posts", {
        method:"POST",
        body: JSON.stringify({ title, coverImage: editorCoverDataUrl || "", blocks })
      });
    }
    closeEditor();
    await refreshAll();
  }catch(err){
    $("edErr").textContent = err.message;
  }
}

function fileToDataUrl(file){
  return new Promise((resolve,reject)=>{
    const r = new FileReader();
    r.onload = () => resolve(r.result);
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

async function openPost(id){
  try{
    const r = await api("/api/posts/"+encodeURIComponent(id));
    currentPostId = id;
    currentPostData = r.post;
    renderPostModal(r.post, r.comments||[]);
    $("postModal").style.display = "flex";
  }catch(err){
    alert(err.message);
  }
}
function closePost(){
  $("postModal").style.display = "none";
  currentPostId = "";
  currentPostData = null;
  $("commentErr").textContent = "";
  $("commentInput").value = "";
}

function renderPostModal(post, comments){
  $("postTitle").textContent = post.title || "Post";
  $("postMeta").textContent = `${post.author || "‚Äî"} ‚Ä¢ ${timeAgo(post.createdAt || Date.now())}`;

  const banner = $("postBanner");
  if(post.coverImage){
    banner.style.display = "block";
    banner.innerHTML = `<img alt="cover" src="${post.coverImage}">`;
  }else{
    banner.style.display = "none";
    banner.innerHTML = "";
  }

  const flow = $("postFlow");
  flow.innerHTML = "";
  const blocks = post.blocks || [];
  blocks.forEach(b=>{
    if(b.type === "text"){
      const div = document.createElement("div");
      div.className = "flowP";
      div.textContent = b.text || "";
      flow.appendChild(div);
    } else if(b.type === "image"){
      const div = document.createElement("div");
      div.className = "flowImg";
      div.innerHTML = `<img alt="image" src="${b.src}">`;
      flow.appendChild(div);
    } else if(b.type === "youtube"){
      const div = document.createElement("div");
      div.className = "flowImg";
      // simple youtube embed
      const url = (b.url||"").trim();
      div.innerHTML = `<iframe style="width:100%;height:100%;border:0" allowfullscreen src="${youtubeToEmbed(url)}"></iframe>`;
      flow.appendChild(div);
    } else if(b.type === "hr"){
      const hr = document.createElement("div");
      hr.className = "divider";
      flow.appendChild(hr);
    }
  });

  // admin actions
  const canAdmin = isAdmin();
  $("postAdminActions").style.display = canAdmin ? "block" : "none";

  // comments
  const cl = $("commentList");
  cl.innerHTML = "";
  $("commentEmpty").style.display = comments.length ? "none" : "block";
  comments.slice(-30).forEach(c=>{
    const it = document.createElement("div");
    it.className = "item";
    it.innerHTML = `
      <div class="iIcon">üí¨</div>
      <div class="iMain">
        <div class="iTop">@${c.user || "‚Äî"}</div>
        <div class="iSub">${timeAgo(c.time || Date.now())}</div>
        <div style="margin-top:8px;font-weight:900;color:#333;line-height:1.35">${escapeHtml(c.text||"")}</div>
      </div>
    `;
    cl.appendChild(it);
  });
}

function youtubeToEmbed(url){
  // supports youtube.com/watch?v=... or youtu.be/...
  try{
    const u = new URL(url);
    if(u.hostname.includes("youtu.be")){
      const id = u.pathname.replace("/","");
      return "https://www.youtube.com/embed/"+encodeURIComponent(id);
    }
    const id = u.searchParams.get("v");
    if(id) return "https://www.youtube.com/embed/"+encodeURIComponent(id);
  }catch{}
  return "https://www.youtube.com/embed/";
}

function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;");
}

async function sendComment(){
  $("commentErr").textContent = "";
  if(!sessionUser){ $("commentErr").textContent = "Login first."; return; }
  if(!currentPostId){ $("commentErr").textContent = "No post."; return; }

  const text = norm($("commentInput").value);
  if(!text){ $("commentErr").textContent = "Write something."; return; }

  try{
    await api("/api/posts/"+encodeURIComponent(currentPostId)+"/comment", {
      method:"POST",
      body: JSON.stringify({ text })
    });
    $("commentInput").value = "";
    // reload post modal
    const r = await api("/api/posts/"+encodeURIComponent(currentPostId));
    renderPostModal(r.post, r.comments||[]);
  }catch(err){
    $("commentErr").textContent = err.message;
  }
}

function editOpenFromPost(){
  if(!currentPostData) return;
  openPostEditor(currentPostData);
}

async function deletePost(){
  if(!isAdmin()) return;
  if(!currentPostId) return;
  if(!confirm("Delete this post?")) return;

  try{
    await api("/api/admin/posts/"+encodeURIComponent(currentPostId), { method:"DELETE" });
    closePost();
    await refreshAll();
  }catch(err){
    alert(err.message);
  }
}

/* =========================
   REDEEM
   ========================= */
async function refreshCodes(){
  const r = await api("/api/redeem/list").catch(()=>({codes:[]}));
  db.codes = r.codes || [];
}

async function redeemCode(){
  $("redeemErr").textContent = "";
  if(!sessionUser){ $("redeemErr").textContent = "Login first."; return; }
  const code = norm($("redeemInput").value);
  if(!code){ $("redeemErr").textContent = "Enter a code."; return; }

  try{
    const r = await api("/api/redeem", { method:"POST", body: JSON.stringify({ code }) });
    $("redeemInput").value = "";
    await refreshAll();
    alert("Redeemed! +" + fmt(r.reward || 0) + " üíé");
  }catch(err){
    $("redeemErr").textContent = err.message;
  }
}

async function adminCreateCode(){
  $("codeAdminErr").textContent = "";
  if(!isAdmin()) return;

  const code = norm($("codeNew").value);
  const reward = parseAmount($("codeReward").value);
  const usesLeft = Number(norm($("codeUses").value));

  if(!code){ $("codeAdminErr").textContent = "Code required."; return; }
  if(!Number.isFinite(reward) || reward <= 0){ $("codeAdminErr").textContent = "Reward invalid."; return; }
  if(!Number.isFinite(usesLeft) || usesLeft <= 0){ $("codeAdminErr").textContent = "Uses invalid."; return; }

  try{
    await api("/api/admin/redeem/create", {
      method:"POST",
      body: JSON.stringify({ code, reward, usesLeft })
    });
    $("codeNew").value = "";
    $("codeReward").value = "";
    $("codeUses").value = "";
    await refreshAll();
  }catch(err){
    $("codeAdminErr").textContent = err.message;
  }
}
async function adminDisableCode(){
  if(!isAdmin()) return;
  const code = norm($("codeDisable").value);
  if(!code){ alert("Enter a code to disable."); return; }
  try{
    await api("/api/admin/redeem/disable", { method:"POST", body: JSON.stringify({ code }) });
    $("codeDisable").value = "";
    await refreshAll();
  }catch(err){
    alert(err.message);
  }
}

/* =========================
   EVENTS
   ========================= */
async function refreshEvents(){
  const r = await api("/api/events/state").catch(()=>null);
  db.events = r;
}

function isAdmin(){
  const lvl = sessionUser?.roles?.adminLevel || "none";
  return (lvl === "team" || lvl === "super");
}
function isSuper(){
  return (sessionUser?.roles?.adminLevel === "super");
}

function renderEvents(){
  const box = $("eventsBody");
  const ev = db.events;

  if(!ev){
    box.innerHTML = `<div class="panelSub">Events server not available.</div>`;
    return;
  }

  const mode = ev.mode || "coming_soon";

  if(mode === "coming_soon"){
    box.innerHTML = `<div class="comingSoonBig">‚ö´ COMING SOON</div>`;
  } else if(mode === "countdown"){
    const ends = ev.countdownEndsAt || 0;
    box.innerHTML = `
      <div class="panel" style="background:#fff">
        <div style="font-weight:1000;font-size:20px">‚è≥ Countdown Active</div>
        <div class="panelSub" id="countdownText" style="margin-top:10px;font-size:18px">Loading...</div>
      </div>
    `;
    startCountdownTicker(ends);
  } else {
    // live or ended
    box.innerHTML = `
      <div class="broadcastCard" id="broadcastCard"></div>

      <div class="divider"></div>

      <div class="panel" style="background:#fff;border-radius:22px;border:1px solid rgba(0,0,0,.08)">
        <div style="font-weight:1000;font-size:18px">üéØ Guess The Number</div>
        <div class="panelSub" id="ggInfo" style="margin-top:8px">‚Äî</div>

        <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
          <input id="ggGuess" placeholder="Enter guess..." style="max-width:260px;margin-top:0">
          <button class="btn blue" onclick="submitGuess()">Guess</button>
          <button class="btn gray" onclick="loadPoints()">View Points</button>
        </div>
        <div class="error" id="ggErr"></div>

        <div class="divider"></div>
        <div class="panelSub" style="font-weight:1000">Recent guesses</div>
        <div class="list" id="ggLog"></div>
        <div class="panelSub" id="ggLogEmpty" style="display:none">No guesses yet.</div>
      </div>

      <div class="divider"></div>

      <div class="panelSub" style="font-weight:1000">Event Updates</div>
      <div class="panelSub">Admins will announce winners, codes, and drops here.</div>
    `;

    renderBroadcast();
    renderGuessGame();
  }

  // admin controls panel visibility
  $("eventsAdmin").style.display = (sessionUser && isAdmin()) ? "block" : "none";
}

let countdownTimer = null;
function startCountdownTicker(endsAt){
  if(countdownTimer) clearInterval(countdownTimer);
  const el = $("countdownText");
  function tick(){
    const ms = Math.max(0, endsAt - Date.now());
    const s = Math.floor(ms/1000);
    const m = Math.floor(s/60);
    const r = s%60;
    if(el) el.textContent = `Time left: ${m}m ${r}s`;
    if(ms <= 0){
      clearInterval(countdownTimer);
      countdownTimer = null;
      refreshAll(); // re-fetch state
    }
  }
  tick();
  countdownTimer = setInterval(tick, 1000);
}

function renderBroadcast(){
  const ev = db.events;
  const b = ev.broadcast || {};
  const card = $("broadcastCard");
  if(!card) return;

  const who = b.admin ? `@${b.admin}` : "SYSTEM";
  const avatar = b.avatarDataUrl || "";
  const text = b.text || "‚Äî";
  const time = b.time || Date.now();

  card.innerHTML = `
    <div class="bcAvatar">${avatar ? `<img alt="avatar" src="${avatar}">` : ""}</div>
    <div class="bcMain">
      <div class="bcTop">${escapeHtml(who)} ‚Ä¢ ${String(b.type||"update").toUpperCase()}</div>
      <div class="bcText">${escapeHtml(text)}</div>
      <div class="bcTime">${timeAgo(time)}</div>
    </div>
  `;
}

function renderGuessGame(){
  const gg = db.events.guessGame || {};
  const info = $("ggInfo");
  const log = $("ggLog");
  const empty = $("ggLogEmpty");

  if(!info || !log) return;

  if(!sessionUser){
    info.textContent = "Login to play.";
  }else if(!gg.active){
    info.textContent = "No active round right now.";
  }else{
    const ends = gg.endsAt || 0;
    const left = Math.max(0, Math.floor((ends - Date.now())/1000));
    info.textContent = `Active: Pick between ${gg.min} and ${gg.max}. Time left: ${left}s.`;
  }

  log.innerHTML = "";
  const entries = (gg.roundLog || []).slice(-20).reverse();
  if(!entries.length){
    empty.style.display = "block";
    return;
  }
  empty.style.display = "none";

  entries.forEach(e=>{
    const it = document.createElement("div");
    it.className = "item";
    const icon = e.result === "correct" ? "üèÜ" : (e.result === "too_low" ? "‚¨áÔ∏è" : "‚¨ÜÔ∏è");
    it.innerHTML = `
      <div class="iIcon">${icon}</div>
      <div class="iMain">
        <div class="iTop">@${e.username} guessed ${e.guess}</div>
        <div class="iSub">${timeAgo(e.time || Date.now())} ‚Ä¢ ${String(e.result||"").toUpperCase()}</div>
      </div>
      <div class="iAmt">‚Äî</div>
    `;
    log.appendChild(it);
  });
}

async function submitGuess(){
  $("ggErr").textContent = "";
  if(!sessionUser){ $("ggErr").textContent = "Login first."; return; }

  const guess = Number(norm($("ggGuess").value));
  if(!Number.isFinite(guess)){ $("ggErr").textContent = "Enter a number."; return; }

  try{
    const r = await api("/api/events/guess", { method:"POST", body: JSON.stringify({ guess }) });
    $("ggGuess").value = "";
    await refreshEvents();
    renderEvents();
    if(r.result === "correct") alert("YOU WON üî•");
  }catch(err){
    $("ggErr").textContent = err.message;
  }
}

async function loadPoints(){
  try{
    const r = await api("/api/events/points");
    const list = r.list || [];
    const top = list.slice(0,10).map((x,i)=>`${i+1}. ${x.username} = ${x.points}`).join("\n");
    alert(top || "No points yet.");
  }catch(err){
    alert(err.message);
  }
}

/* Admin Events Controls */
async function evComingSoon(){
  try{ await api("/api/admin/events/coming-soon", { method:"POST" }); await refreshAll(); }
  catch(err){ $("eventsAdminErr").textContent = err.message; }
}
function openCountdown(){
  const s = prompt("Countdown seconds?");
  const seconds = Number(s);
  if(!Number.isFinite(seconds) || seconds<=0) return;
  evCountdown(seconds);
}
async function evCountdown(seconds){
  try{
    await api("/api/admin/events/countdown", { method:"POST", body: JSON.stringify({ seconds }) });
    await refreshAll();
  }catch(err){
    $("eventsAdminErr").textContent = err.message;
  }
}
async function evEnable(){
  try{ await api("/api/admin/events/engine/enable", { method:"POST" }); await refreshAll(); }
  catch(err){ $("eventsAdminErr").textContent = err.message; }
}
async function evDisable(){
  try{ await api("/api/admin/events/engine/disable", { method:"POST" }); await refreshAll(); }
  catch(err){ $("eventsAdminErr").textContent = err.message; }
}
async function evBroadcast(){
  $("eventsAdminErr").textContent = "";
  const text = norm($("bcText").value);
  if(!text){ $("eventsAdminErr").textContent = "Type a message."; return; }
  try{
    await api("/api/admin/events/broadcast", { method:"POST", body: JSON.stringify({ text }) });
    $("bcText").value = "";
    await refreshAll();
  }catch(err){
    $("eventsAdminErr").textContent = err.message;
  }
}
async function evWinner(){
  $("eventsAdminErr").textContent = "";
  const text = norm($("bcText").value);
  if(!text){ $("eventsAdminErr").textContent = "Type a message."; return; }
  try{
    await api("/api/admin/events/winner", { method:"POST", body: JSON.stringify({ text }) });
    $("bcText").value = "";
    await refreshAll();
  }catch(err){
    $("eventsAdminErr").textContent = err.message;
  }
}
async function ggSetup(){
  $("eventsAdminErr").textContent = "";
  const min = Number(norm($("ggMin").value));
  const max = Number(norm($("ggMax").value));
  const maxGuessesPerUser = Number(norm($("ggMaxGuesses").value));
  const durationSeconds = Number(norm($("ggDuration").value));
  try{
    await api("/api/admin/events/guess/setup", {
      method:"POST",
      body: JSON.stringify({ min, max, maxGuessesPerUser, durationSeconds })
    });
    await refreshAll();
  }catch(err){
    $("eventsAdminErr").textContent = err.message;
  }
}
async function ggStart(){
  $("eventsAdminErr").textContent = "";
  try{
    await api("/api/admin/events/guess/start", { method:"POST" });
    await refreshAll();
  }catch(err){
    $("eventsAdminErr").textContent = err.message;
  }
}
async function ggEnd(){
  $("eventsAdminErr").textContent = "";
  try{
    await api("/api/admin/events/guess/end", { method:"POST" });
    await refreshAll();
  }catch(err){
    $("eventsAdminErr").textContent = err.message;
  }
}

/* =========================
   ADMIN PANEL (Users list + beta + wipe)
   ========================= */
async function refreshUsers(){
  // Use leaderboard as the "users list" (it includes roles + avatar + id)
  // This keeps backend minimal; later we can add /api/admin/users
  db.usersList = (db.leaderboard || []).slice();
}

async function adminSetBeta(username, value){
  try{
    await api("/api/admin/user/"+encodeURIComponent(username)+"/beta", {
      method:"POST",
      body: JSON.stringify({ value })
    });
    await refreshAll();
  }catch(err){
    alert(err.message);
  }
}

async function wipeSystem(){
  $("adminErr").textContent = "";
  if(!isSuper()){ $("adminErr").textContent = "Super admin only."; return; }

  const ok = prompt("Type WIPE to confirm:");
  if(ok !== "WIPE") return;

  try{
    await api("/api/admin/wipe", { method:"POST" });
    alert("Wiped. Please login again.");
    await logout();
  }catch(err){
    $("adminErr").textContent = err.message;
  }
}

/* =========================
   REFRESH ALL
   ========================= */
async function refreshState(){
  if(!getToken()){
    sessionUser = null;
    return;
  }
  const st = await api("/api/state");
  sessionUser = st.user;
  db.requests = st.requests || [];
  db.tx = st.tx || [];
}

async function refreshAll(){
  if(!getToken()){
    sessionUser = null;
    db = { requests:[], tx:[], leaderboard:[], posts:[], events:null, codes:[] };
    renderAll();
    return;
  }

  await refreshState();
  await Promise.allSettled([
    refreshLeaderboard(),
    refreshPosts(),
    refreshEvents(),
    refreshCodes()
  ]);
  await refreshUsers();

  renderAll();
}

/* =========================
   RENDER
   ========================= */
function renderProfilePanel(){
  const avatarBox = $("avatarBox");

  if(!sessionUser){
    $("pName").textContent = "Guest";
    $("sideUser").textContent = "Not signed in";
    $("welcomeTitle").textContent = "Welcome to Orion üíé";
    $("welcomeSub").textContent = "Login to access your bank profile.";
    $("logoutBtn").style.display = "none";
    $("flagsPill").style.display = "none";

    avatarBox.className = "avatar placeholder";
    avatarBox.innerHTML = "";

    $("rolePill").className = "pill orange";
    $("rolePill").textContent = "Role: ‚Äî";
    $("idPill").textContent = "ID: ‚Äî";

    $("balText").textContent = "0 üíé";
    $("dashBal").textContent = "0 üíé";
    $("dashRole").textContent = "‚Äî";
    $("modeText").textContent = "Guest Mode";
    $("statusPill").textContent = "Guest UI";
    $("adminText").textContent = "Admin: ‚Äî";

    // hide admin nav
    $("nav_admin").classList.remove("show");

    // hide admin-only boxes
    $("redeemAdminBox").style.display = "none";
    $("eventsAdmin").style.display = "none";
    $("newPostBtn").style.display = "none";

    return;
  }

  const bal = sessionUser.balance || 0;
  const role = sessionUser.role || roleFromBalance(bal);
  const flags = [];

  const adminLvl = sessionUser.roles?.adminLevel || "none";
  if(adminLvl === "super") flags.push("SUPER ADMIN");
  if(adminLvl === "team") flags.push("TEAM ADMIN");
  if(sessionUser.roles?.betaTester) flags.push("BETA TESTER");

  $("pName").textContent = sessionUser.username;
  $("sideUser").textContent = `${sessionUser.username} ‚Ä¢ ID ${sessionUser.id}`;
  $("welcomeTitle").textContent = `Hey ${sessionUser.username} üëã`;
  $("welcomeSub").textContent = "Universal build ‚Ä¢ backend connected.";
  $("logoutBtn").style.display = "block";

  $("idPill").textContent = "ID: " + sessionUser.id;
  $("rolePill").className = rolePillClass(role);
  $("rolePill").textContent = "Role: " + role;

  if(flags.length){
    $("flagsPill").style.display = "inline-flex";
    $("flagsPill").textContent = flags.join(" ‚Ä¢ ");
  }else{
    $("flagsPill").style.display = "none";
  }

  $("balText").textContent = `${fmt(bal)} üíé`;
  $("dashBal").textContent = `${fmt(bal)} üíé`;
  $("dashRole").textContent = role;

  $("modeText").textContent = "Backend Mode";
  $("statusPill").textContent = "Online UI";
  $("adminText").textContent = "Admin: " + adminLabel();

  // avatar + frame
  const frame = frameClassByRole(role);
  if(sessionUser.avatarDataUrl){
    avatarBox.className = "avatar";
    avatarBox.innerHTML = `<img alt="avatar" src="${sessionUser.avatarDataUrl}"><div class="frame ${frame}"></div>`;
  }else{
    avatarBox.className = "avatar placeholder";
    avatarBox.innerHTML = `<div class="frame ${frame}"></div>`;
  }

  // admin nav / boxes
  if(isAdmin()){
    $("nav_admin").classList.add("show");
    $("redeemAdminBox").style.display = "block";
    $("eventsAdmin").style.display = "block";
    $("newPostBtn").style.display = "inline-block";
  }else{
    $("nav_admin").classList.remove("show");
    $("redeemAdminBox").style.display = "none";
    $("eventsAdmin").style.display = "none";
    $("newPostBtn").style.display = "none";
  }

  // super wipe
  $("wipeBox").style.display = isSuper() ? "block" : "none";
}

function renderTx(){
  const list = $("txList");
  list.innerHTML = "";
  const tx = (db.tx || []).slice(0,6);

  if(tx.length === 0){
    $("txEmpty").style.display = "block";
    return;
  }
  $("txEmpty").style.display = "none";

  tx.forEach(t=>{
    const div = document.createElement("div");
    div.className = "item";

    let icon = "üßæ";
    let top = t.kind || "Activity";
    let sub = timeAgo(t.time || Date.now());
    let amt = `<div class="iAmt">‚Äî</div>`;

    if(t.kind === "send"){
      icon = "üì§";
      top = `Sent to @${t.to}`;
      sub = `From @${t.from} ‚Ä¢ ${timeAgo(t.time)}`;
      amt = `<div class="iAmt neg">- ${fmt(t.amount)} üíé</div>`;
    }
    if(t.kind === "redeem"){
      icon = "üéÅ";
      top = `Redeem code reward`;
      sub = `To @${t.to} ‚Ä¢ ${timeAgo(t.time)}`;
      amt = `<div class="iAmt pos">+ ${fmt(t.amount)} üíé</div>`;
    }
    if(t.kind === "deposit_approved"){
      icon = "‚úÖ";
      top = `Deposit Approved`;
      sub = `@${t.from} ‚Ä¢ ${timeAgo(t.time)}`;
      amt = `<div class="iAmt pos">+ ${fmt(t.amount)} üíé</div>`;
    }
    if(t.kind === "withdraw_approved"){
      icon = "‚úÖ";
      top = `Withdraw Approved`;
      sub = `@${t.from} ‚Ä¢ ${timeAgo(t.time)}`;
      amt = `<div class="iAmt neg">- ${fmt(t.amount)} üíé</div>`;
    }

    div.innerHTML = `
      <div class="iIcon">${icon}</div>
      <div class="iMain">
        <div class="iTop">${top}</div>
        <div class="iSub">${sub}</div>
      </div>
      ${amt}
    `;
    list.appendChild(div);
  });
}

function renderRequests(){
  const myReqList = $("myReqList");
  const allReqList = $("allReqList");
  myReqList.innerHTML = "";
  allReqList.innerHTML = "";

  const my = sessionUser ? (db.requests || []).filter(r => r.user === sessionUser.username) : [];
  const all = db.requests || [];

  $("myReqEmpty").style.display = my.length ? "none" : "block";
  $("allReqEmpty").style.display = all.length ? "none" : "block";

  const makeItem = (r, admin=false) => {
    const div = document.createElement("div");
    div.className = "item";
    const icon = r.type === "deposit" ? "‚ûï" : "‚ûñ";
    const amtClass = r.type === "deposit" ? "pos" : "neg";
    const status = String(r.status||"pending").toUpperCase();

    const actions = (admin && r.status === "pending")
      ? `
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn small green" onclick="adminApproveRequest('${r.id}')">Approve</button>
          <button class="btn small red" onclick="adminDeclineRequest('${r.id}')">Decline</button>
        </div>
      `
      : `<div class="iAmt">${status}</div>`;

    div.innerHTML = `
      <div class="iIcon">${icon}</div>
      <div class="iMain">
        <div class="iTop">@${r.user} ‚Ä¢ ${fmt(r.amount)} üíé</div>
        <div class="iSub">${status} ‚Ä¢ ${timeAgo(r.time)}</div>
      </div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px">
        <div class="iAmt ${amtClass}">${r.type === "deposit" ? "+" : "-"} ${fmt(r.amount)} üíé</div>
        ${actions}
      </div>
    `;
    return div;
  };

  my.slice(0,12).forEach(r => myReqList.appendChild(makeItem(r, false)));
  all.slice(0,24).forEach(r => allReqList.appendChild(makeItem(r, isAdmin())));
}

function renderLeaderboard(){
  const list = db.leaderboard || [];
  const podium = $("podium");
  const lbList = $("lbList");

  podium.innerHTML = "";
  lbList.innerHTML = "";

  if(!list.length){
    $("lbEmpty").style.display = "block";
    return;
  }
  $("lbEmpty").style.display = "none";

  // Top 3 podium with vacant placeholders
  const top3 = [list[0], list[1], list[2]];
  const labels = ["ü•á #1", "ü•à #2", "ü•â #3"];

  top3.forEach((u,i)=>{
    const div = document.createElement("div");
    div.className = "pod";

    if(!u){
      div.innerHTML = `
        <div class="circle"></div>
        <div style="min-width:0">
          <div class="name">-------------</div>
          <div class="meta">Vacant spot</div>
        </div>
        <div style="margin-left:auto;font-weight:1000">${labels[i]}</div>
      `;
    }else{
      div.innerHTML = `
        <div class="circle">${u.avatarDataUrl ? `<img alt="avatar" src="${u.avatarDataUrl}">` : ""}</div>
        <div style="min-width:0">
          <div class="name">${u.username}</div>
          <div class="meta">${fmt(u.balance)} üíé ‚Ä¢ ${u.role}</div>
        </div>
        <div style="margin-left:auto;font-weight:1000">${labels[i]}</div>
      `;
    }
    podium.appendChild(div);
  });

  // Rest list (show vacant lines if less than 10)
  const rest = list.slice(3, 20);
  const totalWanted = 17; // show + placeholders
  for(let i=0;i<totalWanted;i++){
    const u = rest[i];
    const div = document.createElement("div");
    div.className = "item";

    if(!u){
      div.innerHTML = `
        <div class="iIcon">‚Äî</div>
        <div class="iMain">
          <div class="iTop">-------------</div>
          <div class="iSub">Vacant spot</div>
        </div>
        <div class="iAmt">‚Äî</div>
      `;
    }else{
      div.innerHTML = `
        <div class="iIcon">#${i+4}</div>
        <div class="iMain">
          <div class="iTop">${u.username}</div>
          <div class="iSub">${u.role}</div>
        </div>
        <div class="iAmt">${fmt(u.balance)} üíé</div>
      `;
    }
    lbList.appendChild(div);
  }
}

function renderBlogs(){
  const grid = $("blogGrid");
  grid.innerHTML = "";

  const posts = db.posts || [];
  $("blogEmpty").style.display = posts.length ? "none" : "block";

  posts.forEach(p=>{
    const card = document.createElement("div");
    card.className = "blogCard";
    card.onclick = ()=>openPost(p.id);

    card.innerHTML = `
      <div class="blogCover">${p.coverImage ? `<img alt="cover" src="${p.coverImage}">` : ""}</div>
      <div class="blogBody">
        <div class="blogTitle">${escapeHtml(p.title||"Untitled")}</div>
        <div class="blogPreview">${escapeHtml(p.preview||"‚Äî")}</div>
        <div class="blogMeta">${escapeHtml(p.author||"‚Äî")} ‚Ä¢ ${timeAgo(p.createdAt||Date.now())}</div>
      </div>
    `;
    grid.appendChild(card);
  });
}

function renderCodes(){
  const list = $("codesList");
  list.innerHTML = "";

  const codes = db.codes || [];
  $("codesEmpty").style.display = codes.length ? "none" : "block";

  codes.forEach(c=>{
    const it = document.createElement("div");
    it.className = "item";
    it.innerHTML = `
      <div class="iIcon">üéüÔ∏è</div>
      <div class="iMain">
        <div class="iTop">${escapeHtml(c.code)}</div>
        <div class="iSub">${fmt(c.reward)} üíé ‚Ä¢ Uses left: ${c.usesLeft}</div>
      </div>
      <div class="iAmt">‚Äî</div>
    `;
    list.appendChild(it);
  });
}

function renderAdminUsers(){
  const list = $("usersList");
  list.innerHTML = "";
  const users = db.usersList || [];

  if(!users.length){
    $("usersEmpty").style.display = "block";
    return;
  }
  $("usersEmpty").style.display = "none";

  users.slice(0,50).forEach(u=>{
    const it = document.createElement("div");
    it.className = "item";

    const isBeta = !!u.roles?.betaTester;
    const lvl = u.roles?.adminLevel || "none";

    const badge = (lvl === "super") ? "SUPER" : (lvl === "team" ? "TEAM" : "USER");
    const betaText = isBeta ? "‚úÖ Beta" : "‚Äî";

    it.innerHTML = `
      <div class="iIcon">${u.avatarDataUrl ? `<img alt="avatar" src="${u.avatarDataUrl}" style="width:100%;height:100%;object-fit:cover;border-radius:16px">` : "üë§"}</div>
      <div class="iMain">
        <div class="iTop">${u.username} ‚Ä¢ ID ${u.id}</div>
        <div class="iSub">${fmt(u.balance)} üíé ‚Ä¢ ${u.role} ‚Ä¢ ${badge} ‚Ä¢ Beta: ${betaText}</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:8px">
        <button class="btn small ${isBeta ? "red" : "green"}" onclick="adminSetBeta('${u.username}', ${!isBeta})">
          ${isBeta ? "Remove Beta" : "Give Beta"}
        </button>
      </div>
    `;
    list.appendChild(it);
  });
}

function renderAll(){
  renderProfilePanel();
  renderTx();
  renderRequests();
  renderLeaderboard();
  renderBlogs();
  renderCodes();
  renderEvents();
  renderAdminUsers();
}

/* =========================
   INIT
   ========================= */
window.switchView = switchView;
window.openAuth = openAuth;
window.closeAuth = closeAuth;
window.register = register;
window.login = login;
window.logout = logout;

window.openReq = openReq;
window.closeReq = closeReq;
window.submitReq = submitReq;

window.sendGems = sendGems;
window.saveAvatar = saveAvatar;

window.openPost = openPost;
window.closePost = closePost;
window.sendComment = sendComment;

window.openPostEditor = openPostEditor;
window.closeEditor = closeEditor;
window.savePost = savePost;
window.edInsertImage = edInsertImage;
window.edInsertYoutube = edInsertYoutube;
window.edInsertDivider = edInsertDivider;
window.editOpenFromPost = editOpenFromPost;
window.deletePost = deletePost;

window.redeemCode = redeemCode;
window.adminCreateCode = adminCreateCode;
window.adminDisableCode = adminDisableCode;

window.evComingSoon = evComingSoon;
window.openCountdown = openCountdown;
window.evEnable = evEnable;
window.evDisable = evDisable;
window.evBroadcast = evBroadcast;
window.evWinner = evWinner;
window.ggSetup = ggSetup;
window.ggStart = ggStart;
window.ggEnd = ggEnd;

window.submitGuess = submitGuess;
window.loadPoints = loadPoints;

window.adminApproveRequest = adminApproveRequest;
window.adminDeclineRequest = adminDeclineRequest;

window.wipeSystem = wipeSystem;

(async function init(){
  // logged out by default
  if(FORCE_LOGOUT_ON_OPEN) clearToken();

  renderAll();
  switchView("dash");
  try { await refreshAll(); }
  catch (e) {
    clearToken();
    renderAll();
  }
})();
</script>

</body>
</html>
