<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Orion Gem Bank â€” Universal</title>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    *{box-sizing:border-box;font-family:'Fredoka',sans-serif}
    :root{
      --bgA:#9ec5ff;
      --bgB:#b9d7ff;

      --card:#ffffff;
      --soft:#f6f6f6;
      --stroke:rgba(0,0,0,.10);
      --stroke2:rgba(0,0,0,.06);

      --orange:#ff9f1c;
      --blue:#4dabf7;
      --green:#3adb76;
      --red:#ff4d6d;
      --purple:#845ef7;

      --ink:#121212;
      --muted:#666;

      --shadow:0 18px 50px rgba(0,0,0,.18);
      --shadow2:0 14px 34px rgba(0,0,0,.12);

      --r1:26px;
      --r2:22px;
      --r3:18px;
      --r4:14px;

      --sidebarW: 320px;
    }

    body{
      margin:0;
      min-height:100vh;
      background:linear-gradient(135deg,var(--bgA),var(--bgB));
      color:var(--ink);
      overflow-x:hidden;
    }

    /* ====== Desktop Layout ====== */
    .layout{
      display:grid;
      grid-template-columns: var(--sidebarW) 1fr;
      min-height:100vh;
    }

    /* ====== Sidebar ====== */
    .sidebar{
      position:sticky;
      top:0;
      height:100vh;
      padding:18px 16px;
      background:rgba(255,255,255,.85);
      backdrop-filter: blur(10px);
      border-right:2px solid rgba(0,0,0,.08);
      box-shadow: 14px 0 40px rgba(0,0,0,.12);
      overflow:auto;
    }

    .brand{
      background:var(--orange);
      color:#fff;
      border-radius:22px;
      padding:14px 14px;
      font-weight:1000;
      font-size:20px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      box-shadow:0 14px 26px rgba(255,159,28,.25);
      position:relative;
      overflow:hidden;
    }
    .brand:before{
      content:"";
      position:absolute;
      width:220px;height:220px;
      right:-120px; top:-120px;
      background:rgba(255,255,255,.20);
      border-radius:70px;
      transform:rotate(18deg);
    }
    .brand span{position:relative; z-index:2}

    .sideBlock{
      margin-top:14px;
      background:#fff;
      border:1px solid var(--stroke2);
      border-radius:22px;
      padding:12px;
      box-shadow:var(--shadow2);
    }

    .sideTitle{font-weight:1000;margin:4px 0 10px;font-size:16px}
    .sideSub{font-size:12px;color:var(--muted);font-weight:900}

    .nav{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .nav button{
      width:100%;
      text-align:left;
      border:none;
      cursor:pointer;
      padding:12px 12px;
      border-radius:18px;
      font-weight:1000;
      background:#f4f4f4;
      border:1px solid rgba(0,0,0,.10);
      transition: transform .08s ease, background .2s ease, box-shadow .2s ease;
    }
    .nav button:hover{box-shadow:0 10px 20px rgba(0,0,0,.10)}
    .nav button:active{transform:translateY(1px)}
    .nav button.active{
      background:var(--blue);
      color:#fff;
      border-color: rgba(77,171,247,.45);
      box-shadow:0 14px 26px rgba(77,171,247,.22);
    }

    .sideActions{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }

    .btn{
      border:none;
      cursor:pointer;
      border-radius:18px;
      padding:12px 12px;
      font-weight:1000;
      box-shadow:0 14px 26px rgba(0,0,0,.12);
      transition:transform .08s ease, filter .2s ease;
    }
    .btn:active{transform:translateY(1px)}
    .btn.orange{background:var(--orange);color:#fff}
    .btn.gray{background:#f1f1f1;color:#111;border:1px solid rgba(0,0,0,.10);box-shadow:none}
    .btn.red{background:var(--red);color:#fff}
    .btn.green{background:var(--green);color:#fff}
    .btn.blue{background:var(--blue);color:#fff}
    .btn.purple{background:var(--purple);color:#fff}

    /* ====== Main ====== */
    .main{
      padding:22px 22px 28px 22px;
      max-width: 1400px;
    }

    .topRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      margin-bottom:14px;
    }

    .welcomeCard{
      flex:1;
      background:rgba(255,255,255,.86);
      border:1px solid rgba(0,0,0,.08);
      border-radius:26px;
      padding:16px 16px;
      box-shadow:var(--shadow2);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .welcomeTitle{
      font-size:22px;
      font-weight:1000;
      margin:0;
      line-height:1.1;
    }
    .welcomeSub{
      margin-top:6px;
      font-size:13px;
      font-weight:900;
      color:var(--muted);
    }
    .statusPill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:999px;
      background:#fff;
      border:1px solid rgba(0,0,0,.10);
      font-weight:1000;
      white-space:nowrap;
    }

    /* Profile panel rectangle */
    .profilePanel{
      background:#fff;
      border-radius:26px;
      border:3px solid rgba(255,159,28,.55);
      box-shadow:var(--shadow);
      padding:14px;
      display:flex;
      align-items:center;
      gap:14px;
      min-width: 520px;
    }

    .avatar{
      width:74px;height:74px;
      border-radius:20px;
      background:#e9e9e9;
      border:2px solid rgba(0,0,0,.10);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      flex:0 0 auto;
      position:relative;
    }

    /* animated dashed placeholder when not logged in */
    .avatar.placeholder{
      background:#dcdcdc;
      border:2px solid transparent;
    }
    .avatar.placeholder:before{
      content:"";
      position:absolute;
      inset:-4px;
      border-radius:24px;
      background:
        repeating-linear-gradient(90deg,
          rgba(0,0,0,.25) 0 10px,
          rgba(0,0,0,0) 10px 18px);
      -webkit-mask:
        linear-gradient(#000 0 0) content-box,
        linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      padding:6px;
      opacity:.8;
      animation: dashMove 1.2s linear infinite;
    }
    @keyframes dashMove{
      to{ transform:translateX(18px); }
    }

    .avatar img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }

    .pInfo{flex:1;min-width:0}
    .pName{font-size:18px;font-weight:1000;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .pMeta{margin-top:6px;display:flex;gap:10px;flex-wrap:wrap}
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      background:var(--soft);
      border:1px solid rgba(0,0,0,.10);
      font-weight:1000;
      font-size:12px;
    }
    .pill.blue{background:rgba(77,171,247,.16);border-color:rgba(77,171,247,.30)}
    .pill.orange{background:rgba(255,159,28,.18);border-color:rgba(255,159,28,.35)}
    .pill.green{background:rgba(58,219,118,.18);border-color:rgba(58,219,118,.35)}
    .pill.red{background:rgba(255,77,109,.18);border-color:rgba(255,77,109,.35)}
    .pill.purple{background:rgba(132,94,247,.16);border-color:rgba(132,94,247,.30)}

    .balanceLine{
      margin-top:10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px 12px;
      border-radius:18px;
      background:linear-gradient(135deg, rgba(77,171,247,.16), rgba(255,159,28,.18));
      border:1px solid rgba(0,0,0,.08);
    }
    .balLabel{font-weight:1000}
    .balValue{font-weight:1000;font-size:18px}

    /* Content grid */
    .contentGrid{
      display:grid;
      grid-template-columns: 1.4fr 1fr;
      gap:16px;
      margin-top:16px;
    }

    .panel{
      background:rgba(255,255,255,.88);
      border:1px solid rgba(0,0,0,.08);
      border-radius:26px;
      box-shadow:var(--shadow2);
      padding:14px;
    }
    .panelHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
    }
    .panelTitle{
      font-size:18px;
      font-weight:1000;
      margin:0;
    }
    .panelSub{
      font-size:12px;
      font-weight:900;
      color:var(--muted);
      margin-top:6px;
    }

    .divider{height:1px;background:rgba(0,0,0,.10);margin:12px 0}

    /* Forms */
    label{font-size:13px;font-weight:1000}
    input, textarea, select{
      width:100%;
      border-radius:16px;
      border:1px solid rgba(0,0,0,.12);
      padding:12px 12px;
      font-weight:800;
      margin-top:8px;
      outline:none;
      background:#fff;
    }
    textarea{min-height:110px;resize:vertical}

    .row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px}
    .error{color:#b00020;font-weight:1000;font-size:12px;margin-top:8px}
    .ok{color:#0a7a3a;font-weight:1000;font-size:12px;margin-top:8px}

    /* List items */
    .list{display:flex;flex-direction:column;gap:10px;margin-top:8px}
    .item{
      display:flex;
      align-items:center;
      gap:12px;
      background:#f1f1f1;
      border:1px solid rgba(0,0,0,.08);
      border-radius:18px;
      padding:12px;
    }
    .iIcon{
      width:46px;height:46px;
      border-radius:16px;
      background:#fff;
      border:1px solid rgba(0,0,0,.10);
      box-shadow:0 10px 20px rgba(0,0,0,.10);
      display:flex;align-items:center;justify-content:center;
      font-size:18px;
      flex:0 0 auto;
    }
    .iMain{flex:1;min-width:0}
    .iTop{font-weight:1000;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .iSub{font-size:12px;color:var(--muted);font-weight:900;margin-top:4px}
    .iAmt{font-weight:1000;white-space:nowrap}
    .pos{color:#0a7a3a}
    .neg{color:#b00020}

    /* Views */
    .view{display:none}
    .view.show{display:block}

    /* Modal */
    .modal{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.6);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:50;
    }
    .modalBox{
      width:min(560px, 100%);
      background:#fff;
      border-radius:22px;
      border:1px solid rgba(0,0,0,.10);
      box-shadow:0 18px 60px rgba(0,0,0,.30);
      padding:14px;
      position:relative;
    }
    .modalTitle{font-size:18px;font-weight:1000;text-align:center;margin:6px 0}
    .modalSub{font-size:12px;font-weight:900;color:var(--muted);text-align:center;margin-bottom:10px}
    .closeX{
      position:absolute;
      right:-12px; top:-12px;
      width:44px;height:44px;
      border-radius:16px;
      border:2px solid rgba(0,0,0,.15);
      background:var(--red);
      color:#fff;
      font-weight:1000;
      font-size:22px;
      cursor:pointer;
      box-shadow:0 12px 24px rgba(0,0,0,.20);
    }

    /* Leaderboard podium */
    .podium{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:12px;
      margin-top:10px;
    }
    .podCard{
      background:#fff;
      border:1px solid rgba(0,0,0,.10);
      border-radius:22px;
      padding:12px;
      box-shadow:var(--shadow2);
      text-align:center;
      position:relative;
      overflow:hidden;
    }
    .podCard:before{
      content:"";
      position:absolute; inset:-40px;
      background:radial-gradient(circle at 30% 20%, rgba(255,159,28,.22), transparent 55%),
                 radial-gradient(circle at 70% 80%, rgba(77,171,247,.22), transparent 55%);
      transform:rotate(10deg);
    }
    .podCard > *{position:relative; z-index:2}
    .podAvatar{
      width:64px;height:64px;border-radius:999px;background:#e9e9e9;
      border:3px solid rgba(0,0,0,.10);
      margin:0 auto 8px;
      overflow:hidden;
    }
    .podAvatar img{width:100%;height:100%;object-fit:cover;display:block}
    .podPlace{font-weight:1000;font-size:12px;color:var(--muted)}
    .podName{font-weight:1000;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .podBal{font-weight:1000;margin-top:6px}
    .podRole{display:inline-flex;margin-top:8px}

    /* Blog cards grid */
    .grid3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:12px;
    }
    .blogCard{
      background:#fff;
      border:1px solid rgba(0,0,0,.10);
      border-radius:22px;
      overflow:hidden;
      box-shadow:var(--shadow2);
      cursor:pointer;
      transition: transform .08s ease;
    }
    .blogCard:active{transform:translateY(1px)}
    .blogCover{
      height:120px;
      background:#e9e9e9;
      overflow:hidden;
    }
    .blogCover img{width:100%;height:100%;object-fit:cover;display:block}
    .blogBody{padding:12px}
    .blogTitle{font-weight:1000}
    .blogMeta{font-size:12px;color:var(--muted);font-weight:900;margin-top:6px}
    .blogPrev{font-size:12px;color:#333;font-weight:800;margin-top:10px;line-height:1.35}

    /* Events panel */
    .bigSoon{
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:300px;
      border-radius:22px;
      border:2px dashed rgba(0,0,0,.22);
      background:rgba(255,255,255,.65);
      font-size:44px;
      font-weight:1000;
      letter-spacing:1px;
      opacity:.9;
    }
    .eventBar{
      background:#fff;
      border:1px solid rgba(0,0,0,.10);
      border-radius:22px;
      box-shadow:var(--shadow2);
      padding:12px;
      display:flex;
      gap:12px;
      align-items:flex-start;
    }
    .eventA{
      width:54px;height:54px;border-radius:18px;background:#e9e9e9;overflow:hidden;border:2px solid rgba(0,0,0,.10);
      flex:0 0 auto;
    }
    .eventA img{width:100%;height:100%;object-fit:cover;display:block}
    .eventT{flex:1;min-width:0}
    .eventTop{font-weight:1000}
    .eventText{margin-top:6px;color:#222;font-weight:900;font-size:12.5px;white-space:pre-wrap}
    .eventTime{margin-top:8px;color:var(--muted);font-weight:900;font-size:11px}

    /* Chest */
    .chestHero{
      background:#fff;
      border:1px solid rgba(0,0,0,.10);
      border-radius:26px;
      box-shadow:var(--shadow2);
      padding:14px;
      position:relative;
      overflow:hidden;
    }
    .chestHero:before{
      content:"";
      position:absolute; inset:-60px;
      background:radial-gradient(circle at 25% 20%, rgba(255,159,28,.22), transparent 55%),
                 radial-gradient(circle at 70% 80%, rgba(58,219,118,.18), transparent 55%),
                 radial-gradient(circle at 80% 20%, rgba(132,94,247,.16), transparent 55%);
      transform:rotate(6deg);
    }
    .chestHero > *{position:relative; z-index:2}
    .rewardRow{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;background:#f1f1f1;border:1px solid rgba(0,0,0,.08);border-radius:18px}
    .rewardLeft{display:flex;align-items:center;gap:10px;min-width:0}
    .rewardIcon{width:40px;height:40px;border-radius:14px;background:#fff;border:1px solid rgba(0,0,0,.10);display:flex;align-items:center;justify-content:center;box-shadow:0 10px 20px rgba(0,0,0,.10)}
    .rewardName{font-weight:1000;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .rewardPct{font-weight:1000;color:var(--muted);white-space:nowrap}

    /* âœ… Scrollable feed panel (fix requested) */
    .scrollPanel{
      max-height: 340px;
      overflow:auto;
      padding-right:6px;
    }
    .scrollPanel::-webkit-scrollbar{width:10px}
    .scrollPanel::-webkit-scrollbar-thumb{background:rgba(0,0,0,.18);border-radius:999px}
    .scrollPanel::-webkit-scrollbar-track{background:rgba(0,0,0,.06);border-radius:999px}

    /* Responsive */
    @media (max-width: 1200px){
      .grid3{grid-template-columns:1fr 1fr;}
    }
    @media (max-width: 1050px){
      :root{ --sidebarW: 280px; }
      .profilePanel{min-width: 420px;}
      .contentGrid{grid-template-columns:1fr; }
    }
    @media (max-width: 820px){
      .layout{grid-template-columns:1fr;}
      .sidebar{position:relative;height:auto}
      .profilePanel{min-width:unset}
      .topRow{flex-direction:column;align-items:stretch}
      .grid3{grid-template-columns:1fr;}
    }
  </style>
</head>

<body>
  <div class="layout">

    <!-- LEFT SIDEBAR -->
    <aside class="sidebar">
      <div class="brand">
        <span>Orion Bank ğŸ’</span>
        <span style="font-weight:1000;opacity:.95">Universal</span>
      </div>

      <div class="sideBlock">
        <div class="sideTitle">Navigation</div>
        <div class="sideSub">Universal app â€¢ works on any browser</div>

        <div class="nav">
          <button id="nav_dash" class="active" onclick="switchView('dash')">ğŸ  Dashboard</button>
          <button id="nav_bank" onclick="switchView('bank')">ğŸ¦ Bank</button>
          <button id="nav_requests" onclick="switchView('requests')">ğŸ“¥ Requests</button>
          <button id="nav_leaderboard" onclick="switchView('leaderboard')">ğŸ† Leaderboard</button>
          <button id="nav_redeem" onclick="switchView('redeem')">ğŸ« Redeem Codes</button>
          <button id="nav_chest" onclick="switchView('chest')">ğŸ Chest</button>
          <button id="nav_events" onclick="switchView('events')">âš¡ Events</button>
          <button id="nav_blogs" onclick="switchView('blogs')">ğŸ“° Blogs</button>
          <button id="nav_admin" style="display:none" onclick="switchView('admin')">ğŸ›¡ï¸ Admin</button>
        </div>

        <div class="divider"></div>

        <div class="sideTitle">Account</div>
        <div class="sideActions">
          <button class="btn orange" onclick="openAuth(false)">Login</button>
          <button class="btn blue" onclick="openAuth(true)">Register</button>
        </div>
        <button class="btn red" style="width:100%;margin-top:10px;display:none" id="logoutBtn" onclick="logout()">Logout</button>

        <div class="divider"></div>
        <div class="sideSub" id="sideUser">Not signed in</div>
        <div class="sideSub" id="sideNote" style="margin-top:8px">Tip: each browser is its own session (normal).</div>
      </div>

      <div class="sideBlock">
        <div class="sideTitle">Live</div>
        <div class="sideSub">Auto refresh every 3s</div>
        <div class="divider"></div>
        <div class="sideSub" id="lastSync">Last sync: â€”</div>
        <div class="sideSub" id="apiStatus">API: â€”</div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">

      <!-- TOP ROW -->
      <div class="topRow">
        <div class="welcomeCard">
          <div>
            <h1 class="welcomeTitle" id="welcomeTitle">Welcome to Orion ğŸ’</h1>
            <div class="welcomeSub" id="welcomeSub">Login to access your bank profile.</div>
          </div>
          <div class="statusPill">
            <span>ğŸ›¡ï¸</span>
            <span id="modeText">Guest Mode</span>
          </div>
        </div>

        <!-- PROFILE RECTANGLE PANEL -->
        <div class="profilePanel">
          <div class="avatar placeholder" id="avatarBox"></div>

          <div class="pInfo">
            <div class="pName" id="pName">Guest</div>

            <div class="pMeta">
              <span class="pill orange" id="rolePill">Role: â€”</span>
              <span class="pill blue" id="idPill">ID: â€”</span>
              <span class="pill purple" id="tokenPill">ğŸ¥ Tokens: â€”</span>
              <span class="pill green" id="adminPill" style="display:none">Admin</span>
            </div>

            <div class="balanceLine">
              <div class="balLabel">Balance</div>
              <div class="balValue" id="balText">0 ğŸ’</div>
            </div>
          </div>
        </div>
      </div>

      <!-- DASH -->
      <div class="view show" id="view_dash">
        <div class="contentGrid">
          <section class="panel">
            <div class="panelHeader">
              <div>
                <h2 class="panelTitle">Overview</h2>
                <div class="panelSub">Live state + activity</div>
              </div>
              <span class="pill green" id="statusPill">Ready</span>
            </div>

            <div class="row3">
              <div class="panel" style="padding:12px;border-radius:22px;background:#fff;border:1px solid rgba(0,0,0,.08)">
                <div style="font-weight:1000">Your Gems</div>
                <div style="margin-top:8px;font-size:26px;font-weight:1000" id="dashBal">0 ğŸ’</div>
                <div class="panelSub" style="margin-top:8px">Live refresh</div>
              </div>
              <div class="panel" style="padding:12px;border-radius:22px;background:#fff;border:1px solid rgba(0,0,0,.08)">
                <div style="font-weight:1000">ğŸ¥ Tokens</div>
                <div style="margin-top:8px;font-size:26px;font-weight:1000" id="dashTok">0 ğŸ¥</div>
                <div class="panelSub" style="margin-top:8px">Used for chests</div>
              </div>
              <div class="panel" style="padding:12px;border-radius:22px;background:#fff;border:1px solid rgba(0,0,0,.08)">
                <div style="font-weight:1000">Role Rank</div>
                <div style="margin-top:8px;font-size:22px;font-weight:1000" id="dashRole">â€”</div>
                <div class="panelSub" style="margin-top:8px">Based on balance</div>
              </div>
            </div>

            <div class="divider"></div>

            <div class="panelSub" style="font-weight:1000">Recent Activity</div>
            <div class="list" id="txList"></div>
            <div class="panelSub" id="txEmpty" style="display:none;margin-top:8px">No activity yet.</div>
          </section>

          <section class="panel">
            <div class="panelHeader">
              <div>
                <h2 class="panelTitle">Quick Actions</h2>
                <div class="panelSub">Requests + convert</div>
              </div>
              <span class="pill orange">âš™ï¸</span>
            </div>

            <button class="btn green" style="width:100%" onclick="openReq('deposit')">+ Deposit Request</button>
            <button class="btn orange" style="width:100%;margin-top:10px" onclick="openReq('withdraw')">- Withdraw Request</button>

            <div class="divider"></div>

            <button class="btn purple" style="width:100%" onclick="openConvert()">ğŸ¥ Convert Gems â†’ Tokens</button>
            <div class="panelSub" style="margin-top:10px">
              Conversion rate: <b>8,000,000 ğŸ’ = 500 ğŸ¥</b> (500-step only).
            </div>

            <div class="divider"></div>
            <div class="panelSub" style="font-weight:1000">Chest</div>
            <button class="btn blue" style="width:100%;margin-top:10px" onclick="switchView('chest')">Open ğŸ Chest</button>
          </section>
        </div>
      </div>

      <!-- BANK -->
      <div class="view" id="view_bank">
        <div class="contentGrid">
          <section class="panel">
            <div class="panelHeader">
              <div>
                <h2 class="panelTitle">Send ğŸ’</h2>
                <div class="panelSub">Transfer to another registered user</div>
              </div>
              <span class="pill orange">ğŸ¦</span>
            </div>

            <div class="row2">
              <div>
                <label>To Username</label>
                <input id="sendTo" placeholder="e.g ItalyCrazyCat">
              </div>
              <div>
                <label>Amount (supports K/M/B)</label>
                <input id="sendAmt" placeholder="e.g 5M / 250K / 5000000">
              </div>
            </div>

            <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px">
              <button class="btn blue" style="width:220px" onclick="sendGems()">Send ğŸ’ Gems</button>
            </div>
            <div class="error" id="sendErr"></div>

            <div class="divider"></div>
            <div class="panelSub" style="font-weight:1000">Receive</div>
            <div class="panelSub">
              Share your username: <b id="recvUser">â€”</b>
            </div>
          </section>

          <section class="panel">
            <div class="panelHeader">
              <div>
                <h2 class="panelTitle">Profile</h2>
                <div class="panelSub">Avatar + account info</div>
              </div>
              <span class="pill blue">ğŸ‘¤</span>
            </div>

            <div class="row2">
              <div>
                <div style="font-weight:1000">Avatar</div>
                <div class="panelSub" style="margin-top:8px">Small image recommended</div>
                <input type="file" id="avatarInput" accept="image/*" />
                <button class="btn gray" style="width:220px;margin-top:10px" onclick="saveAvatar()">Save Avatar</button>
                <div class="panelSub" style="margin-top:8px">Saved on backend</div>
              </div>

              <div>
                <div style="font-weight:1000">Rank Rules</div>
                <div class="panelSub" style="margin-top:10px" id="rankRules">
                  Starter â†’ 0 ğŸ’<br>
                  Grinder â†’ 1M+ ğŸ’<br>
                  Elite â†’ 50M+ ğŸ’<br>
                  Boss â†’ 250M+ ğŸ’<br>
                  Master â†’ 2B+ ğŸ’<br>
                  Cosmic â†’ 20B+ ğŸ’<br>
                  Celestial â†’ 70B+ ğŸ’
                </div>
                <div class="divider"></div>
                <div class="panelSub">More roles can be added later.</div>
              </div>
            </div>

          </section>
        </div>
      </div>

      <!-- REQUESTS -->
      <div class="view" id="view_requests">
        <div class="contentGrid">
          <section class="panel">
            <div class="panelHeader">
              <div>
                <h2 class="panelTitle">Your Requests</h2>
                <div class="panelSub">Deposit / Withdraw</div>
              </div>
              <span class="pill blue">ğŸ“¥</span>
            </div>
            <div class="list" id="myReqList"></div>
            <div class="panelSub" id="myReqEmpty" style="display:none">No requests yet.</div>
          </section>

          <section class="panel">
            <div class="panelHeader">
              <div>
                <h2 class="panelTitle">All Requests</h2>
                <div class="panelSub">Admin sees everything</div>
              </div>
              <span class="pill green">ğŸ›¡ï¸</span>
            </div>
            <div class="list" id="allReqList"></div>
            <div class="panelSub" id="allReqEmpty" style="display:none">No requests yet.</div>
          </section>
        </div>
      </div>

      <!-- LEADERBOARD -->
      <div class="view" id="view_leaderboard">
        <section class="panel">
          <div class="panelHeader">
            <div>
              <h2 class="panelTitle">Leaderboard</h2>
              <div class="panelSub">Top balances â€¢ live</div>
            </div>
            <span class="pill green">ğŸ†</span>
          </div>

          <div class="podium" id="podium"></div>

          <div class="divider"></div>

          <div class="panelSub" style="font-weight:1000">Ranks</div>
          <div class="list" id="lbList"></div>
        </section>
      </div>

      <!-- REDEEM -->
      <div class="view" id="view_redeem">
        <div class="contentGrid">
          <section class="panel">
            <div class="panelHeader">
              <div>
                <h2 class="panelTitle">Redeem Codes</h2>
                <div class="panelSub">Codes are set by admins</div>
              </div>
              <span class="pill orange">ğŸ«</span>
            </div>

            <label>Enter Code</label>
            <input id="redeemCode" placeholder="e.g ORION-BOOST-1">
            <button class="btn blue" style="width:220px;margin-top:12px" onclick="redeem()">Redeem</button>
            <div class="error" id="redeemErr"></div>
            <div class="ok" id="redeemOk"></div>

            <div class="divider"></div>
            <div class="panelSub" style="font-weight:1000">Active Drops</div>
            <div class="list" id="redeemList"></div>
            <div class="panelSub" id="redeemEmpty" style="display:none">No active codes right now.</div>
          </section>

          <section class="panel">
            <div class="panelHeader">
              <div>
                <h2 class="panelTitle">How it works</h2>
                <div class="panelSub">Simple rules</div>
              </div>
              <span class="pill green">âœ…</span>
            </div>
            <div class="panelSub">
              â€¢ Codes can reward ğŸ’ gems or ğŸ¥ tokens.<br>
              â€¢ Some codes are limited to Beta Testers / Early Access.<br>
              â€¢ Some codes expire or have max uses.<br>
            </div>
          </section>
        </div>
      </div>

      <!-- CHEST -->
      <div class="view" id="view_chest">
        <div class="contentGrid">
          <section class="panel">
            <div class="panelHeader">
              <div>
                <h2 class="panelTitle">ğŸ Chest</h2>
                <div class="panelSub">Costs ğŸ¥ tokens â€¢ rewards are RNG</div>
              </div>
              <span class="pill purple">ğŸ¥</span>
            </div>

            <div class="chestHero">
              <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
                <div>
                  <div style="font-weight:1000;font-size:18px">Open a Chest</div>
                  <div class="panelSub" id="chestMeta">Cost: â€”</div>
                  <div class="panelSub" id="chestMaxHint" style="margin-top:6px;font-weight:1000">Max opens right now: â€”</div>
                </div>

                <div style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
                  <button class="btn orange" style="min-width:220px" onclick="openChest()">Open Chest ğŸ</button>
                  <button class="btn blue" style="min-width:220px" onclick="openMultiChest()">Open Multiple âœ¨</button>
                </div>
              </div>

              <div class="divider"></div>

              <div class="panelSub" style="font-weight:1000">Possible Rewards</div>
              <div class="list" id="chestRewards"></div>
              <div class="panelSub" id="chestRewardsEmpty" style="display:none">Loading rewardsâ€¦</div>
            </div>

            <div class="divider"></div>

            <div class="panelSub" style="font-weight:1000">ğŸŒ Chest Opens Feed</div>
            <!-- âœ… scrollable panel -->
            <div class="scrollPanel">
              <div class="list" id="chestFeed"></div>
              <div class="panelSub" id="chestFeedEmpty" style="display:none">No chest opens yet.</div>
            </div>
          </section>

          <section class="panel" id="chestAdminBox" style="display:none">
            <div class="panelHeader">
              <div>
                <h2 class="panelTitle">Admin Chest Buffs</h2>
                <div class="panelSub">Only admins can change odds</div>
              </div>
              <span class="pill green">ğŸ›¡ï¸</span>
            </div>

            <div class="row2">
              <div>
                <label>Global multiplier</label>
                <input id="boostMult" placeholder="e.g 1.25">
              </div>
              <div>
                <label>Huge chance bonus (%)</label>
                <input id="boostHuge" placeholder="e.g 0.5">
              </div>
            </div>
            <div class="row2" style="margin-top:10px">
              <div>
                <label>Token bonus</label>
                <input id="boostTok" placeholder="e.g 50">
              </div>
              <div>
                <label>Duration (minutes)</label>
                <input id="boostMins" placeholder="e.g 30">
              </div>
            </div>

            <button class="btn red" style="width:240px;margin-top:12px" onclick="setChestBoost()">Apply Buff ğŸ”¥</button>
            <div class="error" id="boostErr"></div>
            <div class="ok" id="boostOk"></div>
          </section>
        </div>
      </div>

      <!-- EVENTS -->
      <div class="view" id="view_events">
        <section class="panel">
          <div class="panelHeader">
            <div>
              <h2 class="panelTitle">âš¡ Events</h2>
              <div class="panelSub">Controlled by admins â€¢ live broadcast</div>
            </div>
            <span class="pill orange">LIVE</span>
          </div>

          <div id="eventsComing" class="bigSoon">âš« COMING SOON</div>

          <div id="eventsLive" style="display:none">
            <div class="eventBar">
              <div class="eventA" id="eventAvatar"></div>
              <div class="eventT">
                <div class="eventTop" id="eventTop">ADMIN MESSAGE</div>
                <div class="eventText" id="eventText">â€”</div>
                <div class="eventTime" id="eventTime">â€”</div>
              </div>
            </div>

            <div class="divider"></div>
            <div class="panelSub">
              If a game round is not active, you will only see COMING SOON.
            </div>
          </div>
        </section>
      </div>

      <!-- BLOGS -->
      <div class="view" id="view_blogs">
        <div class="contentGrid">
          <section class="panel">
            <div class="panelHeader">
              <div>
                <h2 class="panelTitle">ğŸ“° Blogs</h2>
                <div class="panelSub">3 per row â€¢ click to read</div>
              </div>
              <span class="pill blue">NEWS</span>
            </div>

            <div class="grid3" id="blogGrid"></div>
            <div class="panelSub" id="blogEmpty" style="display:none">No posts yet.</div>
          </section>

          <section class="panel">
            <div class="panelHeader">
              <div>
                <h2 class="panelTitle">Post Viewer</h2>
                <div class="panelSub">Read + comments</div>
              </div>
              <span class="pill orange">ğŸ“Œ</span>
            </div>

            <div id="postViewer" class="panelSub">Click a post to view.</div>

            <div class="divider"></div>

            <div style="font-weight:1000">Comments</div>
            <div class="list" id="commentList"></div>
            <div class="panelSub" id="commentEmpty" style="display:none">No comments yet.</div>

            <div class="divider"></div>

            <label>Add comment</label>
            <textarea id="commentText" placeholder="Type your comment..."></textarea>
            <button class="btn green" style="width:220px;margin-top:10px" onclick="postComment()">Send Comment</button>
            <div class="error" id="commentErr"></div>
          </section>
        </div>
      </div>

      <!-- ADMIN -->
      <div class="view" id="view_admin">
        <div class="contentGrid">
          <section class="panel">
            <div class="panelHeader">
              <div>
                <h2 class="panelTitle">Admin Tools</h2>
                <div class="panelSub">Super Admin can wipe</div>
              </div>
              <span class="pill green">ğŸ›¡ï¸</span>
            </div>

            <div class="row2">
              <div>
                <label>Interest Rate (%)</label>
                <input id="interestRate" placeholder="e.g 1.5">
                <button class="btn blue" style="width:220px;margin-top:10px" onclick="setInterest()">Update Interest</button>
                <div class="error" id="interestErr"></div>
                <div class="ok" id="interestOk"></div>
              </div>
              <div>
                <label>Registered Users</label>
                <div class="panelSub">List is live</div>
                <div class="list" id="userList"></div>
              </div>
            </div>

            <div class="divider"></div>

            <div class="row2">
              <div>
                <div style="font-weight:1000">Adjust Member Balance</div>
                <div class="panelSub">Admins only</div>
                <label>Username</label>
                <input id="adjUser" placeholder="e.g someone">
                <label>Amount</label>
                <input id="adjAmt" placeholder="e.g 1000000">
                <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
                  <button class="btn green" onclick="adminAdjust(+1)">Increase</button>
                  <button class="btn red" onclick="adminAdjust(-1)">Decrease</button>
                </div>
                <div class="error" id="adjErr"></div>
                <div class="ok" id="adjOk"></div>
              </div>

              <div>
                <div style="font-weight:1000">Roles</div>
                <div class="panelSub">Assign Beta Tester / Early Access</div>
                <label>Username</label>
                <input id="roleUser" placeholder="e.g someone">
                <label>Role</label>
                <select id="rolePick">
                  <option value="beta">Beta Tester</option>
                  <option value="early">Early Access</option>
                </select>
                <button class="btn purple" style="width:220px;margin-top:10px" onclick="setRole()">Assign Role</button>
                <div class="error" id="roleErr"></div>
                <div class="ok" id="roleOk"></div>

                <div class="divider"></div>
                <div style="font-weight:1000">Danger Zone (Super Admin only)</div>
                <div class="panelSub">Wipes users/balances/posts/requests</div>
                <button class="btn red" style="width:260px;margin-top:10px" onclick="wipeAll()">WIPE EVERYTHING</button>
                <div class="error" id="wipeErr"></div>
                <div class="ok" id="wipeOk"></div>
              </div>
            </div>
          </section>

          <section class="panel">
            <div class="panelHeader">
              <div>
                <h2 class="panelTitle">Admin Blog Controls</h2>
                <div class="panelSub">Delete posts</div>
              </div>
              <span class="pill orange">ğŸ“°</span>
            </div>

            <div class="panelSub">Select a post in Blogs tab, then delete here.</div>
            <button class="btn red" style="width:220px;margin-top:12px" onclick="deletePost()">Delete Selected Post</button>
            <div class="error" id="delPostErr"></div>
            <div class="ok" id="delPostOk"></div>

            <div class="divider"></div>
            <div class="panelSub" style="font-weight:1000">Admin Redeem Code Drop</div>

            <label>Code</label>
            <input id="newCode" placeholder="e.g ORION-500TOK">
            <div class="row2">
              <div>
                <label>Reward Type</label>
                <select id="newCodeType">
                  <option value="tokens">ğŸ¥ Tokens</option>
                  <option value="gems">ğŸ’ Gems</option>
                </select>
              </div>
              <div>
                <label>Amount</label>
                <input id="newCodeAmt" placeholder="e.g 500">
              </div>
            </div>
            <div class="row2" style="margin-top:10px">
              <div>
                <label>Max uses (optional)</label>
                <input id="newCodeMax" placeholder="e.g 50">
              </div>
              <div>
                <label>Expires (minutes, optional)</label>
                <input id="newCodeExp" placeholder="e.g 60">
              </div>
            </div>

            <div class="row2" style="margin-top:10px">
              <div>
                <label>Limit to role (optional)</label>
                <select id="newCodeRole">
                  <option value="">None</option>
                  <option value="beta">Beta Tester</option>
                  <option value="early">Early Access</option>
                </select>
              </div>
              <div style="display:flex;align-items:flex-end">
                <button class="btn green" style="width:100%" onclick="createCode()">Create Code</button>
              </div>
            </div>

            <div class="error" id="codeErr"></div>
            <div class="ok" id="codeOk"></div>
          </section>
        </div>
      </div>

    </main>
  </div>

  <!-- AUTH MODAL -->
  <div class="modal" id="authModal">
    <div class="modalBox">
      <button class="closeX" onclick="closeAuth()">âœ•</button>
      <div class="modalTitle" id="authTitle">Login</div>
      <div class="modalSub" id="authSub">Sign in to access your balance and profile.</div>

      <div class="row2">
        <div>
          <label>Username</label>
          <input id="authUser" placeholder="e.g JRCHESSKID">
        </div>
        <div>
          <label>Password</label>
          <input id="authPass" type="password" placeholder="your password">
        </div>
      </div>

      <div class="error" id="authErr"></div>

      <div style="display:flex;gap:10px;justify-content:center;margin-top:12px">
        <button class="btn gray" style="width:160px" onclick="closeAuth()">Cancel</button>
        <button class="btn orange" style="width:160px" id="authActionBtn" onclick="login()">Login</button>
      </div>
    </div>
  </div>

  <!-- REQUEST MODAL -->
  <div class="modal" id="reqModal">
    <div class="modalBox">
      <button class="closeX" onclick="closeReq()">âœ•</button>
      <div class="modalTitle" id="reqTitle">Request</div>
      <div class="modalSub">Creates a pending request</div>

      <label>Amount</label>
      <input id="reqAmt" placeholder="e.g 5M / 250K / 5000000">
      <div class="error" id="reqErr"></div>

      <div style="display:flex;gap:10px;justify-content:center;margin-top:12px">
        <button class="btn gray" style="width:160px" onclick="closeReq()">Cancel</button>
        <button class="btn green" style="width:160px" onclick="submitReq()">Submit</button>
      </div>
    </div>
  </div>

  <!-- CONVERT MODAL -->
  <div class="modal" id="convModal">
    <div class="modalBox">
      <button class="closeX" onclick="closeConvert()">âœ•</button>
      <div class="modalTitle">ğŸ¥ Convert Gems â†’ Tokens</div>
      <div class="modalSub">Rate: 8,000,000 ğŸ’ = 500 ğŸ¥ â€¢ 500-step only</div>

      <label>Gems to convert</label>
      <input id="convAmt" placeholder="e.g 8000000 / 16M / 24M">

      <div class="panelSub" style="margin-top:10px" id="convPreview">You will receive: â€”</div>
      <div class="error" id="convErr"></div>
      <div class="ok" id="convOk"></div>

      <div style="display:flex;gap:10px;justify-content:center;margin-top:12px">
        <button class="btn gray" style="width:160px" onclick="closeConvert()">Cancel</button>
        <button class="btn purple" style="width:160px" onclick="convert()">Convert</button>
      </div>
    </div>
  </div>

  <!-- âœ… MULTI CHEST MODAL -->
  <div class="modal" id="multiModal">
    <div class="modalBox">
      <button class="closeX" onclick="closeMulti()">âœ•</button>
      <div class="modalTitle">Open Multiple Chests âœ¨</div>
      <div class="modalSub" id="multiSub">Select how many to open</div>

      <label>How many?</label>
      <input id="multiCount" type="number" min="1" step="1" placeholder="Max: â€”">
      <div class="panelSub" style="margin-top:10px" id="multiPreview">Cost: â€”</div>
      <div class="error" id="multiErr"></div>
      <div class="ok" id="multiOk"></div>

      <div style="display:flex;gap:10px;justify-content:center;margin-top:12px">
        <button class="btn gray" style="width:160px" onclick="closeMulti()">Cancel</button>
        <button class="btn blue" style="width:160px" id="multiGoBtn" onclick="runMulti()">Open</button>
      </div>
    </div>
  </div>

<script>
  // =========================
  // CONFIG
  // =========================
  const API_BASE = "https://4e74ae9e-afad-4327-981d-85a4a2d2c6bd-00-1v9sw5mrqqnf3.riker.replit.dev"; // <- jrchesskid change this
  const TOKEN_KEY = "orion_token_v1";

  // Convert rule (matches your backend)
  const CONV_GEMS_CHUNK = 8000000; // 8,000,000 gems
  const CONV_TOKENS_STEP = 500;    // 500 tokens per chunk

  // =========================
  // STATE
  // =========================
  let sessionUser = null;
  let isAdmin = false;
  let adminLevel = "none";

  let db = {
    requests: [],
    tx: [],
    leaderboard: [],
    posts: [],
    selectedPostId: "",
    redeem: [],
    chest: { costTokens: 500, rewards: [], boosts: null },
    eventsState: { mode:"coming_soon" },
    usersMini: []
  };

  let view = "dash";
  let pendingType = "deposit";
  let pollTimer = null;
  let lock = { state:false, lb:false, posts:false, events:false, redeem:false, chest:false, users:false };
  const $ = (id)=>document.getElementById(id);

  // =========================
  // HELPERS
  // =========================
  function norm(s){ return (s||"").trim(); }
  function fmt(n){ return (Number(n)||0).toLocaleString("en-US"); }

  function parseAmount(val){
    val = (val||"").toUpperCase().trim().replace(/,/g,"");
    if(!val) return NaN;
    if(val.endsWith("K")) return Math.floor(parseFloat(val.slice(0,-1))*1000);
    if(val.endsWith("M")) return Math.floor(parseFloat(val.slice(0,-1))*1000000);
    if(val.endsWith("B")) return Math.floor(parseFloat(val.slice(0,-1))*1000000000);
    const n = Number(val);
    return Number.isFinite(n) ? Math.floor(n) : NaN;
  }

  function roleFromBalance(b){
    b = Number(b)||0;
    if(b >= 70000000000) return "Celestial";
    if(b >= 20000000000) return "Cosmic";
    if(b >= 2000000000) return "Master";
    if(b >= 250000000)  return "Boss";
    if(b >= 50000000)   return "Elite";
    if(b >= 1000000)    return "Grinder";
    return "Starter";
  }

  function rolePillClass(role){
    if(role === "Celestial") return "pill purple";
    if(role === "Cosmic") return "pill green";
    if(role === "Master") return "pill green";
    if(role === "Boss") return "pill orange";
    if(role === "Elite") return "pill blue";
    if(role === "Grinder") return "pill blue";
    return "pill orange";
  }

  function timeAgo(ts){
    const mins = Math.floor((Date.now()-ts)/60000);
    if(mins < 1) return "Just now";
    if(mins < 60) return mins + " min ago";
    const hrs = Math.floor(mins/60);
    if(hrs < 24) return hrs + "h ago";
    const d = Math.floor(hrs/24);
    return d + "d ago";
  }

  // =========================
  // TOKEN
  // =========================
  function getToken(){ return localStorage.getItem(TOKEN_KEY) || ""; }
  function setToken(t){ localStorage.setItem(TOKEN_KEY, t); }
  function clearToken(){ localStorage.removeItem(TOKEN_KEY); }

  // =========================
  // API
  // =========================
  async function api(path, opts={}){
    const headers = Object.assign({ "Content-Type":"application/json" }, opts.headers||{});
    const t = getToken();
    if(t) headers.Authorization = "Bearer " + t;

    const res = await fetch(API_BASE + path, { ...opts, headers });
    const data = await res.json().catch(()=>({}));
    if(!res.ok) throw new Error(data.error || "Request failed");
    return data;
  }

  async function ping(){
    try{
      const r = await fetch(API_BASE + "/api/health");
      if(!r.ok) throw 0;
      $("apiStatus").textContent = "API: Online âœ…";
    }catch{
      $("apiStatus").textContent = "API: Offline âŒ";
    }
  }

  // =========================
  // NAV / VIEWS
  // =========================
  function switchView(v){
    view = v;
    const all = ["dash","bank","requests","leaderboard","redeem","chest","events","blogs","admin"];
    all.forEach(x=>{
      const vv = $("view_"+x);
      const nn = $("nav_"+x);
      if(vv) vv.classList.remove("show");
      if(nn) nn.classList.remove("active");
    });
    $("view_"+v).classList.add("show");
    $("nav_"+v).classList.add("active");
    renderAll();
  }

  // =========================
  // AUTH
  // =========================
  function openAuth(registerMode=false){
    $("authErr").textContent = "";
    $("authUser").value = "";
    $("authPass").value = "";
    $("authTitle").textContent = registerMode ? "Register" : "Login";
    $("authSub").textContent = registerMode
      ? "Create your account. Balance starts at 0 ğŸ’."
      : "Sign in to access your balance and profile.";
    $("authActionBtn").textContent = registerMode ? "Register" : "Login";
    $("authActionBtn").onclick = registerMode ? register : login;
    $("authModal").style.display = "flex";
  }
  function closeAuth(){ $("authModal").style.display = "none"; }

  async function register(){
    const u = norm($("authUser").value);
    const p = $("authPass").value || "";
    $("authErr").textContent = "";

    if(!u || !p){ $("authErr").textContent = "Enter username + password."; return; }

    try{
      await api("/api/register", { method:"POST", body: JSON.stringify({ username:u, password:p }) });
      const loginRes = await api("/api/login", { method:"POST", body: JSON.stringify({ username:u, password:p }) });
      setToken(loginRes.token);
      closeAuth();
      await refreshAll(true);
    }catch(err){
      $("authErr").textContent = err.message;
    }
  }

  async function login(){
    const u = norm($("authUser").value);
    const p = $("authPass").value || "";
    $("authErr").textContent = "";

    if(!u || !p){ $("authErr").textContent = "Enter username + password."; return; }

    try{
      const loginRes = await api("/api/login", { method:"POST", body: JSON.stringify({ username:u, password:p }) });
      setToken(loginRes.token);
      closeAuth();
      await refreshAll(true);
    }catch(err){
      $("authErr").textContent = err.message;
    }
  }

  async function logout(){
    try{ await api("/api/logout", { method:"POST" }); }catch{}
    clearToken();
    sessionUser = null;
    isAdmin = false;
    adminLevel = "none";
    db = { requests:[], tx:[], leaderboard:[], posts:[], selectedPostId:"", redeem:[], chest:{costTokens:500,rewards:[],boosts:null}, eventsState:{mode:"coming_soon"}, usersMini:[] };
    renderAll();
    switchView("dash");
  }

  // =========================
  // REQUESTS
  // =========================
  function openReq(type){
    pendingType = type;
    $("reqTitle").textContent = (type === "deposit" ? "Deposit Request" : "Withdraw Request");
    $("reqAmt").value = "";
    $("reqErr").textContent = "";
    $("reqModal").style.display = "flex";
  }
  function closeReq(){ $("reqModal").style.display = "none"; }

  async function submitReq(){
    $("reqErr").textContent = "";
    if(!sessionUser){ $("reqErr").textContent = "Register/Login first."; return; }

    const amt = parseAmount($("reqAmt").value);
    if(!Number.isFinite(amt) || amt <= 0){ $("reqErr").textContent = "Invalid amount."; return; }

    try{
      await api("/api/request", { method:"POST", body: JSON.stringify({ type: pendingType, amount: amt }) });
      closeReq();
      await refreshAll();
    }catch(err){
      $("reqErr").textContent = err.message;
    }
  }

  // =========================
  // SEND
  // =========================
  async function sendGems(){
    $("sendErr").textContent = "";
    if(!sessionUser){ $("sendErr").textContent = "Register/Login first."; return; }

    const to = norm($("sendTo").value);
    const amt = parseAmount($("sendAmt").value);

    if(!to){ $("sendErr").textContent = "Enter a recipient username."; return; }
    if(!Number.isFinite(amt) || amt <= 0){ $("sendErr").textContent = "Invalid amount."; return; }

    try{
      await api("/api/send", { method:"POST", body: JSON.stringify({ to, amount: amt }) });
      $("sendTo").value = "";
      $("sendAmt").value = "";
      await refreshAll();
    }catch(err){
      $("sendErr").textContent = err.message;
    }
  }

  // =========================
  // AVATAR
  // =========================
  async function saveAvatar(){
    if(!sessionUser){ alert("Register/Login first."); return; }
    const file = $("avatarInput").files[0];
    if(!file){ alert("Choose an image first."); return; }

    if(file.size > 2_000_000){
      alert("That image is too big. Use a smaller one (under ~2MB).");
      return;
    }

    const reader = new FileReader();
    reader.onload = async () => {
      try{
        await api("/api/avatar", { method:"POST", body: JSON.stringify({ avatarDataUrl: reader.result }) });
        await refreshAll();
        alert("Avatar saved.");
      }catch(err){
        alert(err.message);
      }
    };
    reader.readAsDataURL(file);
  }

  // =========================
  // CONVERT
  // =========================
  function openConvert(){
    $("convAmt").value = "";
    $("convErr").textContent = "";
    $("convOk").textContent = "";
    $("convPreview").textContent = "You will receive: â€”";
    $("convModal").style.display = "flex";

    $("convAmt").oninput = () => {
      const g = parseAmount($("convAmt").value);
      if(!Number.isFinite(g) || g<=0){
        $("convPreview").textContent = "You will receive: â€”";
        return;
      }
      const chunks = Math.floor(g / CONV_GEMS_CHUNK);
      if(chunks <= 0){
        $("convPreview").textContent = `Minimum: ${fmt(CONV_GEMS_CHUNK)} ğŸ’ â†’ ${fmt(CONV_TOKENS_STEP)} ğŸ¥`;
        return;
      }
      const gemsUsed = chunks * CONV_GEMS_CHUNK;
      const tokensGet = chunks * CONV_TOKENS_STEP;
      $("convPreview").textContent = `You will receive: ${fmt(tokensGet)} ğŸ¥ (uses ${fmt(gemsUsed)} ğŸ’)`;
    };
  }
  function closeConvert(){ $("convModal").style.display = "none"; }

  async function convert(){
    $("convErr").textContent = "";
    $("convOk").textContent = "";
    if(!sessionUser){ $("convErr").textContent = "Login first."; return; }

    const g = parseAmount($("convAmt").value);
    if(!Number.isFinite(g) || g<=0){ $("convErr").textContent = "Invalid amount."; return; }

    if(g % CONV_GEMS_CHUNK !== 0){
      $("convErr").textContent = `Gems must be multiples of ${fmt(CONV_GEMS_CHUNK)} (8M).`;
      return;
    }

    try{
      await api("/api/convert", { method:"POST", body: JSON.stringify({ gems: g }) });
      $("convOk").textContent = "Converted successfully âœ…";
      await refreshAll();
    }catch(e){
      $("convErr").textContent = e.message;
    }
  }

  // =========================
  // REDEEM
  // =========================
  async function redeem(){
    $("redeemErr").textContent = "";
    $("redeemOk").textContent = "";
    if(!sessionUser){ $("redeemErr").textContent = "Login first."; return; }
    const code = norm($("redeemCode").value);
    if(!code){ $("redeemErr").textContent = "Enter a code."; return; }

    try{
      await api("/api/redeem", { method:"POST", body: JSON.stringify({ code }) });
      $("redeemOk").textContent = "Redeemed âœ…";
      $("redeemCode").value = "";
      await refreshAll();
    }catch(e){
      $("redeemErr").textContent = e.message;
    }
  }

  // =========================
  // CHEST (single + multi)
  // =========================
  function maxOpensNow(){
    const cost = Number(db.chest?.costTokens ?? 500);
    const tok = Number(sessionUser?.tokens ?? 0);
    if(cost <= 0) return 0;
    return Math.max(0, Math.floor(tok / cost));
  }

  async function openChest(){
    if(!sessionUser){ alert("Login first."); return; }
    try{
      await api("/api/chest/open", { method:"POST" });
      await refreshAll();
      alert("Chest opened âœ…");
    }catch(e){
      alert(e.message);
    }
  }

  function openMultiChest(){
    if(!sessionUser){ alert("Login first."); return; }

    const cost = Number(db.chest?.costTokens ?? 500);
    const maxN = maxOpensNow();

    $("multiErr").textContent = "";
    $("multiOk").textContent = "";
    $("multiCount").value = "";
    $("multiCount").min = "1";
    $("multiCount").max = String(Math.max(1, maxN));
    $("multiCount").placeholder = "Max: " + maxN;
    $("multiSub").textContent = `Cost per chest: ${fmt(cost)} ğŸ¥ â€¢ You can open up to ${maxN}`;
    $("multiPreview").textContent = `Total cost: â€”`;

    $("multiCount").oninput = () => {
      const n = Math.floor(Number($("multiCount").value || 0));
      if(!Number.isFinite(n) || n <= 0){
        $("multiPreview").textContent = "Total cost: â€”";
        return;
      }
      const clamped = Math.min(n, maxN);
      if(n !== clamped) $("multiCount").value = String(clamped);
      $("multiPreview").textContent = `Total cost: ${fmt(clamped * cost)} ğŸ¥`;
    };

    $("multiModal").style.display = "flex";
  }
  function closeMulti(){ $("multiModal").style.display = "none"; }

  async function runMulti(){
    $("multiErr").textContent = "";
    $("multiOk").textContent = "";

    const cost = Number(db.chest?.costTokens ?? 500);
    const maxN = maxOpensNow();
    const nRaw = Math.floor(Number($("multiCount").value || 0));
    const n = Math.min(nRaw, maxN);

    if(!Number.isFinite(nRaw) || nRaw <= 0){
      $("multiErr").textContent = "Enter a valid number.";
      return;
    }
    if(n <= 0){
      $("multiErr").textContent = "Not enough tokens to open any chests.";
      return;
    }

    $("multiGoBtn").disabled = true;
    $("multiGoBtn").textContent = "Opening...";

    const got = [];
    try{
      for(let i=0;i<n;i++){
        const r = await api("/api/chest/open", { method:"POST" });
        if(r && r.reward) got.push(r.reward);
      }
      await refreshAll();

      // Tiny summary
      const counts = {};
      got.forEach(x=>{
        const key = (x.icon || "ğŸ") + " " + (x.name || x.type || "Reward");
        counts[key] = (counts[key] || 0) + 1;
      });
      const lines = Object.entries(counts).slice(0,8).map(([k,v]) => `â€¢ x${v} ${k}`).join("\n");

      $("multiOk").textContent = `Done âœ… Opened ${n} chests.`;
      alert(`Opened ${n} chests âœ…\nSpent ${fmt(n*cost)} ğŸ¥\n\nResults:\n${lines || "â€”"}`);
      closeMulti();
    }catch(e){
      $("multiErr").textContent = e.message || "Failed.";
    }finally{
      $("multiGoBtn").disabled = false;
      $("multiGoBtn").textContent = "Open";
    }
  }

  async function setChestBoost(){
    $("boostErr").textContent = "";
    $("boostOk").textContent = "";
    const mult = Number(($("boostMult").value||"").trim());
    const huge = Number(($("boostHuge").value||"").trim());
    const tok = Number(($("boostTok").value||"").trim());
    const mins = Number(($("boostMins").value||"").trim());
    try{
      await api("/api/admin/chest/boost", {
        method:"POST",
        body: JSON.stringify({ globalMultiplier: mult, hugeChanceBonus: huge, tokenBonus: tok, durationMinutes: mins })
      });
      $("boostOk").textContent = "Boost applied âœ…";
      await refreshAll();
    }catch(e){
      $("boostErr").textContent = e.message;
    }
  }

  // =========================
  // BLOGS
  // =========================
  async function openPost(id){
    db.selectedPostId = id;
    $("delPostErr").textContent = "";
    $("delPostOk").textContent = "";
    try{
      const r = await api("/api/posts/" + encodeURIComponent(id));
      renderPost(r.post, r.comments || []);
    }catch(e){
      $("postViewer").innerHTML = "Failed to load post.";
    }
  }

  function renderPost(post, comments){
    const cover = post.coverImage ? `<div class="blogCover" style="height:160px;border-radius:18px;overflow:hidden;margin-bottom:10px"><img src="${post.coverImage}"></div>` : "";
    const blocks = (post.blocks||[]).map(b=>{
      if(b.type === "image"){
        return `<div style="margin:10px 0;border-radius:18px;overflow:hidden;border:1px solid rgba(0,0,0,.10)">
                  <img src="${b.src}" style="width:100%;height:220px;object-fit:cover;display:block">
                </div>`;
      }
      if(b.type === "youtube"){
        return `<div style="margin:10px 0;border-radius:18px;overflow:hidden;border:1px solid rgba(0,0,0,.10)">
                  <iframe width="100%" height="220" src="${toYouTubeEmbed(b.url)}" frameborder="0" allowfullscreen></iframe>
                </div>`;
      }
      const text = escapeHtml(b.text||"").replace(/\n/g,"<br>");
      return `<div style="margin:10px 0;font-weight:800;color:#1a1a1a;line-height:1.45">${text}</div>`;
    }).join("");

    $("postViewer").innerHTML = `
      <div style="font-weight:1000;font-size:18px">${escapeHtml(post.title||"")}</div>
      <div class="panelSub">${escapeHtml(post.author||"")} â€¢ ${new Date(post.createdAt||Date.now()).toLocaleString()}</div>
      <div class="divider"></div>
      ${cover}
      ${blocks || "<div class='panelSub'>â€”</div>"}
    `;

    renderComments(comments);
  }

  function renderComments(comments){
    const list = $("commentList");
    list.innerHTML = "";
    $("commentEmpty").style.display = (comments && comments.length) ? "none" : "block";
    (comments||[]).slice().reverse().forEach(c=>{
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div class="iIcon">ğŸ’¬</div>
        <div class="iMain">
          <div class="iTop">@${escapeHtml(c.user||"")}</div>
          <div class="iSub">${escapeHtml(c.text||"")} â€¢ ${timeAgo(c.time||Date.now())}</div>
        </div>
        <div class="iAmt">â€”</div>
      `;
      list.appendChild(div);
    });
  }

  async function postComment(){
    $("commentErr").textContent = "";
    if(!sessionUser){ $("commentErr").textContent = "Login first."; return; }
    if(!db.selectedPostId){ $("commentErr").textContent = "Select a post first."; return; }
    const text = norm($("commentText").value);
    if(!text){ $("commentErr").textContent = "Type a comment."; return; }

    try{
      await api("/api/posts/" + encodeURIComponent(db.selectedPostId) + "/comment", {
        method:"POST",
        body: JSON.stringify({ text })
      });
      $("commentText").value = "";
      await refreshPosts(true);
    }catch(e){
      $("commentErr").textContent = e.message;
    }
  }

  function toYouTubeEmbed(url){
    try{
      const u = new URL(url);
      let id = "";
      if(u.hostname.includes("youtube.com")) id = u.searchParams.get("v") || "";
      if(u.hostname.includes("youtu.be")) id = u.pathname.replace("/","");
      if(!id) return "";
      return "https://www.youtube.com/embed/" + encodeURIComponent(id);
    }catch{
      return "";
    }
  }

  function escapeHtml(s){
    return String(s||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // =========================
  // ADMIN
  // =========================
  async function setInterest(){
    $("interestErr").textContent="";
    $("interestOk").textContent="";
    const rate = Number(($("interestRate").value||"").trim());
    try{
      await api("/api/admin/interest", { method:"POST", body: JSON.stringify({ rate }) });
      $("interestOk").textContent="Interest updated âœ…";
    }catch(e){
      $("interestErr").textContent=e.message;
    }
  }

  async function adminAdjust(dir){
    $("adjErr").textContent="";
    $("adjOk").textContent="";
    const u = norm($("adjUser").value);
    const amt = parseAmount($("adjAmt").value);
    if(!u){ $("adjErr").textContent="Enter username."; return; }
    if(!Number.isFinite(amt) || amt<=0){ $("adjErr").textContent="Invalid amount."; return; }
    try{
      await api("/api/admin/user/balance", { method:"POST", body: JSON.stringify({ username:u, amount: amt*dir }) });
      $("adjOk").textContent="Balance updated âœ…";
      await refreshAll();
    }catch(e){
      $("adjErr").textContent=e.message;
    }
  }

  async function setRole(){
    $("roleErr").textContent="";
    $("roleOk").textContent="";
    const u = norm($("roleUser").value);
    const role = $("rolePick").value;
    if(!u){ $("roleErr").textContent="Enter username."; return; }
    try{
      await api("/api/admin/user/role", { method:"POST", body: JSON.stringify({ username:u, role }) });
      $("roleOk").textContent="Role assigned âœ…";
      await refreshAll();
    }catch(e){
      $("roleErr").textContent=e.message;
    }
  }

  async function wipeAll(){
    $("wipeErr").textContent="";
    $("wipeOk").textContent="";
    if(!confirm("THIS WILL WIPE EVERYTHING. Continue?")) return;
    try{
      await api("/api/admin/wipe", { method:"POST" });
      $("wipeOk").textContent="Wiped âœ…";
      await refreshAll(true);
    }catch(e){
      $("wipeErr").textContent=e.message;
    }
  }

  async function deletePost(){
    $("delPostErr").textContent="";
    $("delPostOk").textContent="";
    if(!db.selectedPostId){ $("delPostErr").textContent="Select a post first."; return; }
    if(!confirm("Delete this post?")) return;
    try{
      await api("/api/admin/posts/" + encodeURIComponent(db.selectedPostId), { method:"DELETE" });
      $("delPostOk").textContent="Deleted âœ…";
      db.selectedPostId="";
      $("postViewer").textContent="Click a post to view.";
      await refreshPosts(true);
    }catch(e){
      $("delPostErr").textContent=e.message;
    }
  }

  async function createCode(){
    $("codeErr").textContent="";
    $("codeOk").textContent="";
    const code = norm($("newCode").value);
    const type = $("newCodeType").value;
    const amount = parseAmount($("newCodeAmt").value);
    const maxUses = Number(($("newCodeMax").value||"").trim()) || 0;
    const expMin = Number(($("newCodeExp").value||"").trim()) || 0;
    const roleLimit = $("newCodeRole").value || "";

    if(!code){ $("codeErr").textContent="Enter code."; return; }
    if(!Number.isFinite(amount) || amount<=0){ $("codeErr").textContent="Invalid amount."; return; }

    try{
      await api("/api/admin/redeem/create", {
        method:"POST",
        body: JSON.stringify({ code, type, amount, maxUses, expiresMinutes: expMin, roleLimit })
      });
      $("codeOk").textContent="Code created âœ…";
      await refreshRedeem(true);
    }catch(e){
      $("codeErr").textContent=e.message;
    }
  }

  // =========================
  // RENDER
  // =========================
  function renderProfilePanel(){
    const avatarBox = $("avatarBox");

    if(!sessionUser){
      $("pName").textContent = "Guest";
      $("sideUser").textContent = "Not signed in";
      $("welcomeTitle").textContent = "Welcome to Orion ğŸ’";
      $("welcomeSub").textContent = "Login to access your bank profile.";
      $("logoutBtn").style.display = "none";
      $("nav_admin").style.display = "none";
      $("adminPill").style.display = "none";

      avatarBox.className = "avatar placeholder";
      avatarBox.innerHTML = "";

      $("rolePill").className = "pill orange";
      $("rolePill").textContent = "Role: â€”";
      $("idPill").textContent = "ID: â€”";
      $("tokenPill").textContent = "ğŸ¥ Tokens: â€”";

      $("balText").textContent = "0 ğŸ’";
      $("dashBal").textContent = "0 ğŸ’";
      $("dashTok").textContent = "0 ğŸ¥";
      $("dashRole").textContent = "â€”";
      $("recvUser").textContent = "â€”";
      $("chestMaxHint").textContent = "Max opens right now: â€”";
      return;
    }

    const bal = sessionUser.balance || 0;
    const tok = sessionUser.tokens || 0;
    const role = sessionUser.role || roleFromBalance(bal);

    $("pName").textContent = sessionUser.username;
    $("sideUser").textContent = `${sessionUser.username} â€¢ ID ${sessionUser.id}`;
    $("welcomeTitle").textContent = `Hey ${sessionUser.username} ğŸ‘‹`;
    $("welcomeSub").textContent = "Live backend connected â€¢ universal build.";
    $("logoutBtn").style.display = "block";
    $("recvUser").textContent = sessionUser.username;

    $("idPill").textContent = "ID: " + sessionUser.id;

    $("rolePill").className = rolePillClass(role);
    $("rolePill").textContent = "Role: " + role;

    $("tokenPill").textContent = `ğŸ¥ Tokens: ${fmt(tok)}`;

    $("balText").textContent = `${fmt(bal)} ğŸ’`;
    $("dashBal").textContent = `${fmt(bal)} ğŸ’`;
    $("dashTok").textContent = `${fmt(tok)} ğŸ¥`;
    $("dashRole").textContent = role;

    if(sessionUser.avatarDataUrl){
      avatarBox.className = "avatar";
      avatarBox.innerHTML = `<img alt="avatar" src="${sessionUser.avatarDataUrl}">`;
    }else{
      avatarBox.className = "avatar placeholder";
      avatarBox.innerHTML = "";
    }

    isAdmin = !!sessionUser.isAdmin || (sessionUser.roles && sessionUser.roles.adminLevel && sessionUser.roles.adminLevel !== "none");
    adminLevel = sessionUser.roles?.adminLevel || (sessionUser.isAdmin ? "team" : "none");

    $("modeText").textContent = isAdmin ? "Admin Mode" : "User Mode";
    $("adminPill").style.display = isAdmin ? "inline-flex" : "none";
    $("nav_admin").style.display = isAdmin ? "block" : "none";
    $("chestAdminBox").style.display = isAdmin ? "block" : "none";

    // max opens hint
    $("chestMaxHint").textContent = "Max opens right now: " + fmt(maxOpensNow());
  }

  function renderTx(){
    const list = $("txList");
    list.innerHTML = "";
    const tx = (db.tx || []).slice(0,8);

    if(tx.length === 0){
      $("txEmpty").style.display = "block";
      return;
    }
    $("txEmpty").style.display = "none";

    tx.forEach(t=>{
      const div = document.createElement("div");
      div.className = "item";

      let icon = "ğŸ§¾";
      let top = t.kind || "Activity";
      let sub = timeAgo(t.time || Date.now());
      let amt = `<div class="iAmt">â€”</div>`;

      if(t.kind === "send"){
        icon = "ğŸ“¤";
        top = `Sent to @${t.to}`;
        sub = `From @${t.from} â€¢ ${timeAgo(t.time)}`;
        amt = `<div class="iAmt neg">- ${fmt(t.amount)} ğŸ’</div>`;
      }
      if(t.kind === "deposit_approved"){
        icon = "â•";
        top = `Deposit approved for @${t.from}`;
        sub = timeAgo(t.time);
        amt = `<div class="iAmt pos">+ ${fmt(t.amount)} ğŸ’</div>`;
      }
      if(t.kind === "withdraw_approved"){
        icon = "â–";
        top = `Withdraw approved for @${t.from}`;
        sub = timeAgo(t.time);
        amt = `<div class="iAmt neg">- ${fmt(t.amount)} ğŸ’</div>`;
      }
      if(t.kind === "convert"){
        icon = "ğŸ¥";
        top = `Converted gems â†’ tokens`;
        sub = timeAgo(t.time);
        amt = `<div class="iAmt neg">- ${fmt(t.amount)} ğŸ’</div>`;
      }
      if(t.kind === "chest_open"){
        icon = "ğŸ";
        top = `Chest opened`;
        sub = timeAgo(t.time);
        amt = `<div class="iAmt">- ${fmt(t.amount)} ğŸ¥</div>`;
      }
      if(t.kind === "redeem"){
        icon = "ğŸ«";
        top = `Redeemed code`;
        sub = timeAgo(t.time);
        amt = `<div class="iAmt pos">+ ${fmt(t.amount)} ${(t.meta && t.meta.type==="tokens") ? "ğŸ¥" : "ğŸ’"}</div>`;
      }

      div.innerHTML = `
        <div class="iIcon">${icon}</div>
        <div class="iMain">
          <div class="iTop">${escapeHtml(top)}</div>
          <div class="iSub">${escapeHtml(sub)}</div>
        </div>
        ${amt}
      `;
      list.appendChild(div);
    });
  }

  function renderRequests(){
    const myReqList = $("myReqList");
    const allReqList = $("allReqList");
    myReqList.innerHTML = "";
    allReqList.innerHTML = "";

    const my = sessionUser ? (db.requests || []).filter(r => r.user === sessionUser.username) : [];
    const all = db.requests || [];

    $("myReqEmpty").style.display = my.length ? "none" : "block";
    $("allReqEmpty").style.display = all.length ? "none" : "block";

    const makeItem = (r) => {
      const div = document.createElement("div");
      div.className = "item";
      const icon = r.type === "deposit" ? "â•" : "â–";
      const amtClass = r.type === "deposit" ? "pos" : "neg";
      const status = String(r.status||"pending").toUpperCase();

      const adminBtns = (isAdmin && r.status === "pending")
        ? `<div style="display:flex;gap:8px;flex-wrap:wrap">
             <button class="btn green" style="padding:8px 10px;border-radius:14px;box-shadow:none" onclick="adminApprove('${r.id}')">Approve</button>
             <button class="btn red" style="padding:8px 10px;border-radius:14px;box-shadow:none" onclick="adminDecline('${r.id}')">Decline</button>
           </div>`
        : `<div class="iAmt ${amtClass}">${r.type === "deposit" ? "+" : "-"} ${fmt(r.amount)} ğŸ’</div>`;

      div.innerHTML = `
        <div class="iIcon">${icon}</div>
        <div class="iMain">
          <div class="iTop">@${escapeHtml(r.user)} â€¢ ${fmt(r.amount)} ğŸ’</div>
          <div class="iSub">${status} â€¢ ${timeAgo(r.time)}</div>
        </div>
        ${adminBtns}
      `;
      return div;
    };

    my.slice(0,14).forEach(r => myReqList.appendChild(makeItem(r)));
    all.slice(0,20).forEach(r => allReqList.appendChild(makeItem(r)));
  }

  async function adminApprove(id){
    try{
      await api("/api/admin/request/" + encodeURIComponent(id) + "/approve", { method:"POST" });
      await refreshAll();
    }catch(e){ alert(e.message); }
  }
  async function adminDecline(id){
    try{
      await api("/api/admin/request/" + encodeURIComponent(id) + "/decline", { method:"POST" });
      await refreshAll();
    }catch(e){ alert(e.message); }
  }

  function renderLeaderboard(){
    const pod = $("podium");
    const lb = $("lbList");
    pod.innerHTML = "";
    lb.innerHTML = "";

    const list = (db.leaderboard || []).slice(0, 30);
    const top3 = list.slice(0,3);

    function podCard(place, u){
      const name = u ? u.username : "-------------";
      const bal = u ? `${fmt(u.balance)} ğŸ’` : "-------------";
      const role = u ? (u.role || roleFromBalance(u.balance||0)) : "-------------";
      const avatar = u && u.avatarDataUrl ? `<img src="${u.avatarDataUrl}">` : "";
      const pillClass = rolePillClass(role).split(" ")[1] || "orange";
      return `
        <div class="podCard">
          <div class="podPlace">${place}</div>
          <div class="podAvatar">${avatar}</div>
          <div class="podName">${escapeHtml(name)}</div>
          <div class="podBal">${escapeHtml(bal)}</div>
          <span class="pill ${pillClass} podRole">â­ ${escapeHtml(role)}</span>
        </div>
      `;
    }

    pod.innerHTML = podCard("ğŸ¥‡ #1", top3[0]) + podCard("ğŸ¥ˆ #2", top3[1]) + podCard("ğŸ¥‰ #3", top3[2]);

    list.slice(3).forEach((u, i)=>{
      const div = document.createElement("div");
      div.className = "item";
      const rank = i+4;
      const avatar = u.avatarDataUrl ? `<img src="${u.avatarDataUrl}" style="width:100%;height:100%;object-fit:cover;display:block">` : "";
      div.innerHTML = `
        <div class="iIcon">${rank}</div>
        <div class="iIcon" style="overflow:hidden">${avatar || "ğŸ‘¤"}</div>
        <div class="iMain">
          <div class="iTop">@${escapeHtml(u.username)} â€¢ ${escapeHtml(u.role||roleFromBalance(u.balance||0))}</div>
          <div class="iSub">ID ${u.id}</div>
        </div>
        <div class="iAmt">${fmt(u.balance)} ğŸ’</div>
      `;
      lb.appendChild(div);
    });
  }

  function renderRedeem(){
    const list = $("redeemList");
    list.innerHTML = "";
    const codes = db.redeem || [];
    $("redeemEmpty").style.display = codes.length ? "none" : "block";

    codes.forEach(c=>{
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div class="iIcon">ğŸ«</div>
        <div class="iMain">
          <div class="iTop">${escapeHtml(c.code || "CODE")}</div>
          <div class="iSub">${escapeHtml(c.type||"reward")} â€¢ ${c.expiresAt ? ("expires " + timeAgo(c.expiresAt)) : "no expiry"}</div>
        </div>
        <div class="iAmt">${fmt(c.amount||0)} ${c.type==="tokens"?"ğŸ¥":"ğŸ’"}</div>
      `;
      list.appendChild(div);
    });
  }

  function renderChest(){
    const cost = Number(db.chest?.costTokens ?? 500);
    $("chestMeta").textContent = `Cost: ${fmt(cost)} ğŸ¥`;

    // rewards
    const list = $("chestRewards");
    list.innerHTML = "";
    const rewards = db.chest?.rewards || [];
    $("chestRewardsEmpty").style.display = rewards.length ? "none" : "block";

    rewards.forEach(r=>{
      const div = document.createElement("div");
      div.className = "rewardRow";
      div.innerHTML = `
        <div class="rewardLeft">
          <div class="rewardIcon">${escapeHtml(r.icon||"ğŸ")}</div>
          <div style="min-width:0">
            <div class="rewardName">${escapeHtml(r.name||"Reward")}</div>
            <div class="panelSub" style="margin-top:4px">${escapeHtml(r.desc||"")}</div>
          </div>
        </div>
        <div class="rewardPct">${escapeHtml((r.chancePct!=null? (r.chancePct+"%") : "â€”"))}</div>
      `;
      list.appendChild(div);
    });

    // âœ… feed: derived from tx "chest_open" + reward meta (your backend logs reward meta)
    const feed = $("chestFeed");
    feed.innerHTML = "";

    const allTx = (db.tx || []);
    const chestTx = allTx.filter(t => t.kind === "chest_open").slice(0, 40);

    $("chestFeedEmpty").style.display = chestTx.length ? "none" : "block";

    chestTx.forEach(t=>{
      const reward = (t.meta && t.meta.reward) ? t.meta.reward : null;
      const rewardText = reward ? `${reward.name || reward.type || "Reward"}${reward.amount!=null ? (" â€¢ " + fmt(reward.amount) + (reward.type==="gems"?" ğŸ’":reward.type==="tokens"?" ğŸ¥":"")) : ""}` : "Reward logged";
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div class="iIcon">ğŸ</div>
        <div class="iMain">
          <div class="iTop">@${escapeHtml(t.from || "user")} opened a chest</div>
          <div class="iSub">${escapeHtml(rewardText)} â€¢ ${escapeHtml(timeAgo(t.time || Date.now()))}</div>
        </div>
        <div class="iAmt">-${fmt(t.amount || 0)} ğŸ¥</div>
      `;
      feed.appendChild(div);
    });

    // max opens hint stays updated
    if(sessionUser) $("chestMaxHint").textContent = "Max opens right now: " + fmt(maxOpensNow());
  }

  function renderEvents(){
    const st = db.eventsState || { mode:"coming_soon" };

    if(st.mode !== "live"){
      $("eventsComing").style.display = "flex";
      $("eventsLive").style.display = "none";
      return;
    }

    $("eventsComing").style.display = "none";
    $("eventsLive").style.display = "block";

    // Avatar
    const a = $("eventAvatar");
    a.innerHTML = "";
    if(st.avatarDataUrl){
      a.innerHTML = `<img src="${st.avatarDataUrl}" alt="event">`;
    }else{
      a.style.background = "#e9e9e9";
    }

    $("eventTop").textContent = st.title || "ADMIN MESSAGE";
    $("eventText").textContent = st.text || "â€”";
    $("eventTime").textContent = st.time
      ? ("Updated: " + new Date(st.time).toLocaleString())
      : "â€”";
  }

  function renderBlogs(){
    const grid = $("blogGrid");
    grid.innerHTML = "";

    const posts = (db.posts || []).slice(0, 60);
    $("blogEmpty").style.display = posts.length ? "none" : "block";

    posts.forEach(p=>{
      const card = document.createElement("div");
      card.className = "blogCard";
      card.onclick = () => openPost(p.id);

      const cover = p.coverImage
        ? `<img src="${p.coverImage}" alt="cover">`
        : "";

      // preview text from first text block
      let prev = "";
      const blocks = p.blocks || [];
      const tb = blocks.find(b=>b.type === "text" && (b.text||"").trim());
      if(tb) prev = (tb.text||"").trim().slice(0, 120);

      card.innerHTML = `
        <div class="blogCover">${cover}</div>
        <div class="blogBody">
          <div class="blogTitle">${escapeHtml(p.title || "Untitled")}</div>
          <div class="blogMeta">${escapeHtml(p.author || "Unknown")} â€¢ ${new Date(p.createdAt||Date.now()).toLocaleDateString()}</div>
          <div class="blogPrev">${escapeHtml(prev || "Click to readâ€¦")}</div>
        </div>
      `;
      grid.appendChild(card);
    });
  }

  function renderAdminUsers(){
    const list = $("userList");
    if(!list) return;
    list.innerHTML = "";

    const users = (db.usersMini || []).slice(0, 40);
    if(!users.length){
      const d = document.createElement("div");
      d.className = "panelSub";
      d.textContent = "No users loaded.";
      list.appendChild(d);
      return;
    }

    users.forEach(u=>{
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div class="iIcon">ğŸ‘¤</div>
        <div class="iMain">
          <div class="iTop">@${escapeHtml(u.username || "user")}</div>
          <div class="iSub">ID ${escapeHtml(String(u.id||"â€”"))} â€¢ ${escapeHtml(u.role || roleFromBalance(u.balance||0))}</div>
        </div>
        <div class="iAmt">${fmt(u.balance||0)} ğŸ’</div>
      `;
      list.appendChild(div);
    });
  }

  function renderAll(){
    renderProfilePanel();

    // If not admin, but user is on admin view, kick back
    if(view === "admin" && !isAdmin){
      switchView("dash");
      return;
    }

    renderTx();
    renderRequests();
    renderLeaderboard();
    renderRedeem();
    renderChest();
    renderEvents();
    renderBlogs();
    if(isAdmin) renderAdminUsers();
  }

  // =========================
  // REFRESH (matches your backend routes)
  // =========================
  async function refreshState(){
    if(lock.state) return;
    lock.state = true;
    try{
      const r = await api("/api/state");
      sessionUser = r.user || null;
      db.requests = r.requests || [];
      db.tx = r.tx || [];

      if(sessionUser){
        isAdmin = !!sessionUser.isAdmin || (sessionUser.roles && sessionUser.roles.adminLevel && sessionUser.roles.adminLevel !== "none");
        adminLevel = sessionUser.roles?.adminLevel || (sessionUser.isAdmin ? "team" : "none");
      }else{
        isAdmin = false;
        adminLevel = "none";
      }
    }catch(e){
      if(String(e.message||"").toLowerCase().includes("unauthorized")){
        clearToken();
      }
      sessionUser = null;
      isAdmin = false;
      adminLevel = "none";
      db.requests = [];
      db.tx = [];
    }finally{
      lock.state = false;
    }
  }

  async function refreshLeaderboard(force=false){
    if(lock.lb && !force) return;
    lock.lb = true;
    try{
      const r = await api("/api/leaderboard");
      // your backend returns { list }
      db.leaderboard = r.list || [];
    }catch{
      db.leaderboard = db.leaderboard || [];
    }finally{
      lock.lb = false;
    }
  }

  async function refreshRedeem(force=false){
    if(lock.redeem && !force) return;
    lock.redeem = true;
    try{
      const r = await api("/api/redeem/list");
      // your backend returns { list, codes } (either is fine)
      db.redeem = r.list || r.codes || [];
    }catch{
      db.redeem = db.redeem || [];
    }finally{
      lock.redeem = false;
    }
  }

  async function refreshChest(force=false){
    if(lock.chest && !force) return;
    lock.chest = true;
    try{
      // your backend returns chest state at root (not nested)
      const r = await api("/api/chest/state");
      db.chest = {
        costTokens: r.costTokens ?? 500,
        jackpotMaxGems: r.jackpotMaxGems ?? 0,
        rewards: r.rewards || [],
        boosts: r.boosts || null
      };
    }catch{
      db.chest = db.chest || { costTokens:500, rewards:[], boosts:null };
    }finally{
      lock.chest = false;
    }
  }

  async function refreshEvents(force=false){
    if(lock.events && !force) return;
    lock.events = true;
    try{
      const r = await api("/api/events/state"); // public
      // your backend returns: {mode, countdownEndsAt, broadcast, engine, guessGame}
      // we map to the old renderer structure
      const b = r.broadcast || {};
      db.eventsState = {
        mode: (r.mode === "live") ? "live" : r.mode,
        title: b.type === "winner" ? "WINNER" : "ADMIN MESSAGE",
        text: b.text || "â€”",
        time: b.time || Date.now(),
        avatarDataUrl: b.avatarDataUrl || ""
      };
      // Only show live card when broadcast isn't coming_soon
      if((r.mode || "coming_soon") === "coming_soon"){
        db.eventsState.mode = "coming_soon";
      }else{
        db.eventsState.mode = "live";
      }
    }catch{
      db.eventsState = db.eventsState || { mode:"coming_soon" };
    }finally{
      lock.events = false;
    }
  }

  async function refreshPosts(force=false){
    if(lock.posts && !force) return;
    lock.posts = true;
    try{
      const r = await api("/api/posts"); // public
      db.posts = r.list || [];
      if(db.selectedPostId){
        try{
          const rr = await api("/api/posts/" + encodeURIComponent(db.selectedPostId));
          renderPost(rr.post, rr.comments || []);
        }catch{}
      }
    }catch{
      db.posts = db.posts || [];
    }finally{
      lock.posts = false;
    }
  }

  async function refreshUsersMini(force=false){
    if(!isAdmin) return;
    if(lock.users && !force) return;
    lock.users = true;
    try{
      const r = await api("/api/admin/users");
      db.usersMini = r.list || [];
    }catch{
      db.usersMini = db.usersMini || [];
    }finally{
      lock.users = false;
    }
  }

  async function refreshAll(first=false){
    $("lastSync").textContent = "Last sync: " + new Date().toLocaleTimeString();
    await ping();

    const hasToken = !!getToken();
    if(!hasToken){
      sessionUser = null;
      isAdmin = false;
      adminLevel = "none";
      renderAll();
      return;
    }

    await refreshState();

    // If still not logged, show guest and stop
    if(!sessionUser){
      renderAll();
      return;
    }

    await Promise.allSettled([
      refreshLeaderboard(first),
      refreshRedeem(first),
      refreshChest(first),
      refreshEvents(first),
      refreshPosts(first),
      refreshUsersMini(first),
    ]);

    renderAll();
  }

  function startPolling(){
    if(pollTimer) clearInterval(pollTimer);
    pollTimer = setInterval(()=>refreshAll(false), 1000); // âœ… 3s (matches UI)
  }

  // =========================
  // BOOT
  // =========================
  (async function boot(){
    switchView("dash");
    await refreshAll(true);
    startPolling();
  })();
</script>

</body>
</html>