<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Orion Gem Bank ‚Äî Desktop UI</title>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    *{box-sizing:border-box;font-family:'Fredoka',sans-serif}
    :root{
      --bgA:#9ec5ff;
      --bgB:#b9d7ff;

      --card:#ffffff;
      --soft:#f6f6f6;
      --stroke:rgba(0,0,0,.10);
      --stroke2:rgba(0,0,0,.06);

      --orange:#ff9f1c;
      --blue:#4dabf7;
      --green:#3adb76;
      --red:#ff4d6d;
      --purple:#8b5cf6;
      --gold:#f7c948;

      --ink:#121212;
      --muted:#666;

      --shadow:0 18px 50px rgba(0,0,0,.18);
      --shadow2:0 14px 34px rgba(0,0,0,.12);

      --r1:26px;
      --r2:22px;
      --r3:18px;
      --r4:14px;

      --sidebarW: 320px;
    }

    body{
      margin:0;
      min-height:100vh;
      background:linear-gradient(135deg,var(--bgA),var(--bgB));
      color:var(--ink);
      overflow-x:hidden;
    }

    .layout{ display:grid; grid-template-columns: var(--sidebarW) 1fr; min-height:100vh; }

    .sidebar{
      position:sticky; top:0; height:100vh; padding:18px 16px;
      background:rgba(255,255,255,.85); backdrop-filter: blur(10px);
      border-right:2px solid rgba(0,0,0,.08);
      box-shadow: 14px 0 40px rgba(0,0,0,.12);
      overflow:auto;
    }

    .brand{
      background:var(--orange); color:#fff; border-radius:22px; padding:14px 14px;
      font-weight:1000; font-size:20px; display:flex; align-items:center; justify-content:space-between;
      box-shadow:0 14px 26px rgba(255,159,28,.25);
      position:relative; overflow:hidden;
    }
    .brand:before{
      content:""; position:absolute; width:220px;height:220px; right:-120px; top:-120px;
      background:rgba(255,255,255,.20); border-radius:70px; transform:rotate(18deg);
    }
    .brand span{position:relative; z-index:2}

    .sideBlock{
      margin-top:14px; background:#fff; border:1px solid var(--stroke2);
      border-radius:22px; padding:12px; box-shadow:var(--shadow2);
    }
    .sideTitle{font-weight:1000;margin:4px 0 10px;font-size:16px}
    .sideSub{font-size:12px;color:var(--muted);font-weight:900}

    .nav{ margin-top:10px; display:flex; flex-direction:column; gap:10px; }
    .nav button{
      width:100%; text-align:left; border:none; cursor:pointer;
      padding:12px 12px; border-radius:18px; font-weight:1000;
      background:#f4f4f4; border:1px solid rgba(0,0,0,.10);
      transition: transform .08s ease, background .2s ease, box-shadow .2s ease;
    }
    .nav button:hover{box-shadow:0 10px 20px rgba(0,0,0,.10)}
    .nav button:active{transform:translateY(1px)}
    .nav button.active{
      background:var(--blue); color:#fff; border-color: rgba(77,171,247,.45);
      box-shadow:0 14px 26px rgba(77,171,247,.22);
    }

    .sideActions{ margin-top:12px; display:grid; grid-template-columns: 1fr 1fr; gap:10px; }

    .btn{
      border:none; cursor:pointer; border-radius:18px; padding:12px 12px;
      font-weight:1000; box-shadow:0 14px 26px rgba(0,0,0,.12);
      transition:transform .08s ease, filter .2s ease;
    }
    .btn:active{transform:translateY(1px)}
    .btn.orange{background:var(--orange);color:#fff}
    .btn.gray{background:#f1f1f1;color:#111;border:1px solid rgba(0,0,0,.10);box-shadow:none}
    .btn.red{background:var(--red);color:#fff}
    .btn.green{background:var(--green);color:#fff}
    .btn.blue{background:var(--blue);color:#fff}
    .btn.purple{background:var(--purple);color:#fff}

    .main{ padding:22px 22px 28px 22px; max-width: 1400px; }

    .topRow{
      display:flex; align-items:center; justify-content:space-between; gap:14px; margin-bottom:14px;
    }

    .welcomeCard{
      flex:1; background:rgba(255,255,255,.86); border:1px solid rgba(0,0,0,.08);
      border-radius:26px; padding:16px 16px; box-shadow:var(--shadow2);
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .welcomeTitle{ font-size:22px; font-weight:1000; margin:0; line-height:1.1; }
    .welcomeSub{ margin-top:6px; font-size:13px; font-weight:900; color:var(--muted); }
    .statusPill{
      display:inline-flex; align-items:center; gap:8px; padding:10px 12px;
      border-radius:999px; background:#fff; border:1px solid rgba(0,0,0,.10);
      font-weight:1000; white-space:nowrap;
    }

    .profilePanel{
      background:#fff; border-radius:26px; border:3px solid rgba(255,159,28,.55);
      box-shadow:var(--shadow); padding:14px; display:flex; align-items:center; gap:14px;
      min-width: 520px;
    }

    .avatar{
      width:74px;height:74px; border-radius:20px; background:#e9e9e9;
      border:2px solid rgba(0,0,0,.10);
      display:flex; align-items:center; justify-content:center; overflow:hidden; flex:0 0 auto; position:relative;
    }

    /* Frame styles by role */
    .frame-starter{ box-shadow:none; }
    .frame-grinder{ box-shadow:0 0 0 3px rgba(77,171,247,.55) inset; }
    .frame-elite{ box-shadow:0 0 0 3px rgba(58,219,118,.55) inset; }
    .frame-boss{ box-shadow:0 0 0 3px rgba(255,159,28,.65) inset; }
    .frame-master{ box-shadow:0 0 0 3px rgba(139,92,246,.65) inset; }
    .frame-cosmic{
      box-shadow:0 0 0 3px rgba(247,201,72,.75) inset, 0 0 18px rgba(247,201,72,.35);
    }
    .frame-celestial{
      box-shadow:0 0 0 3px rgba(255,255,255,.75) inset, 0 0 22px rgba(255,255,255,.45);
      overflow:visible;
    }
    .frame-celestial:after{
      content:"";
      position:absolute; inset:-6px;
      border-radius:26px;
      background: conic-gradient(from 0deg,
        rgba(255,255,255,0),
        rgba(255,255,255,.95),
        rgba(255,255,255,0));
      filter: blur(1px);
      animation: shine 1.6s linear infinite;
      z-index:0;
      pointer-events:none;
    }
    @keyframes shine{ to{ transform:rotate(360deg);} }

    .avatar.placeholder{ background:#dcdcdc; border:2px solid transparent; }
    .avatar.placeholder:before{
      content:""; position:absolute; inset:-4px; border-radius:24px;
      background: repeating-linear-gradient(90deg, rgba(0,0,0,.25) 0 10px, rgba(0,0,0,0) 10px 18px);
      -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite: xor; mask-composite: exclude;
      padding:6px; opacity:.8; animation: dashMove 1.2s linear infinite;
    }
    @keyframes dashMove{ to{ transform:translateX(18px);} }

    .avatar img{ width:100%; height:100%; object-fit:cover; display:block; position:relative; z-index:1; }

    .pInfo{flex:1;min-width:0}
    .pName{font-size:18px;font-weight:1000;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .pMeta{margin-top:6px;display:flex;gap:10px;flex-wrap:wrap}
    .pill{
      display:inline-flex; align-items:center; gap:8px; padding:8px 10px;
      border-radius:999px; background:var(--soft); border:1px solid rgba(0,0,0,.10);
      font-weight:1000; font-size:12px;
    }
    .pill.blue{background:rgba(77,171,247,.16);border-color:rgba(77,171,247,.30)}
    .pill.orange{background:rgba(255,159,28,.18);border-color:rgba(255,159,28,.35)}
    .pill.green{background:rgba(58,219,118,.18);border-color:rgba(58,219,118,.35)}
    .pill.purple{background:rgba(139,92,246,.16);border-color:rgba(139,92,246,.30)}
    .pill.gold{background:rgba(247,201,72,.18);border-color:rgba(247,201,72,.35)}

    .balanceLine{
      margin-top:10px; display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:12px 12px; border-radius:18px;
      background:linear-gradient(135deg, rgba(77,171,247,.16), rgba(255,159,28,.18));
      border:1px solid rgba(0,0,0,.08);
    }
    .balLabel{font-weight:1000}
    .balValue{font-weight:1000;font-size:18px}

    .contentGrid{ display:grid; grid-template-columns: 1.4fr 1fr; gap:16px; margin-top:16px; }

    .panel{
      background:rgba(255,255,255,.88); border:1px solid rgba(0,0,0,.08);
      border-radius:26px; box-shadow:var(--shadow2); padding:14px;
    }

    .panelHeader{
      display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px;
    }
    .panelTitle{ font-size:18px; font-weight:1000; margin:0; }
    .panelSub{ font-size:12px; font-weight:900; color:var(--muted); margin-top:6px; }
    .divider{height:1px;background:rgba(0,0,0,.10);margin:12px 0}

    label{font-size:13px;font-weight:1000}
    input, textarea{
      width:100%;
      border-radius:16px; border:1px solid rgba(0,0,0,.12);
      padding:12px 12px; font-weight:800; margin-top:8px; outline:none; background:#fff;
    }
    textarea{ min-height:120px; resize:vertical; }

    .row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .error{color:#b00020;font-weight:1000;font-size:12px;margin-top:8px}

    .list{display:flex;flex-direction:column;gap:10px;margin-top:8px}
    .item{
      display:flex; align-items:center; gap:12px;
      background:#f1f1f1; border:1px solid rgba(0,0,0,.08);
      border-radius:18px; padding:12px;
    }
    .iIcon{
      width:46px;height:46px; border-radius:16px; background:#fff;
      border:1px solid rgba(0,0,0,.10); box-shadow:0 10px 20px rgba(0,0,0,.10);
      display:flex;align-items:center;justify-content:center;
      font-size:18px; flex:0 0 auto;
    }
    .iMain{flex:1;min-width:0}
    .iTop{font-weight:1000;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .iSub{font-size:12px;color:var(--muted);font-weight:900;margin-top:4px}
    .iAmt{font-weight:1000;white-space:nowrap}
    .pos{color:#0a7a3a}
    .neg{color:#b00020}

    .view{display:none}
    .view.show{display:block}

    .modal{
      position:fixed; inset:0; background:rgba(0,0,0,.6);
      display:none; align-items:center; justify-content:center; padding:16px; z-index:50;
    }
    .modalBox{
      width:min(560px, 100%); background:#fff; border-radius:22px;
      border:1px solid rgba(0,0,0,.10);
      box-shadow:0 18px 60px rgba(0,0,0,.30);
      padding:14px; position:relative;
    }
    .modalTitle{font-size:18px;font-weight:1000;text-align:center;margin:6px 0}
    .modalSub{font-size:12px;font-weight:900;color:var(--muted);text-align:center;margin-bottom:10px}
    .closeX{
      position:absolute; right:-12px; top:-12px;
      width:44px;height:44px; border-radius:16px;
      border:2px solid rgba(0,0,0,.15);
      background:var(--red); color:#fff;
      font-weight:1000; font-size:22px; cursor:pointer;
      box-shadow:0 12px 24px rgba(0,0,0,.20);
    }

    /* Leaderboard */
    .podium{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px; margin-top:10px; }
    .pod{
      background:#fff; border:1px solid rgba(0,0,0,.08); border-radius:22px;
      padding:12px; box-shadow:var(--shadow2);
      display:flex; flex-direction:column; align-items:center; text-align:center; gap:8px;
    }
    .pod .rankTag{
      font-weight:1000; padding:6px 10px; border-radius:999px;
      background:rgba(255,159,28,.18); border:1px solid rgba(255,159,28,.35);
    }
    .pod .pPic{
      width:72px; height:72px; border-radius:999px;
      background:#eee; border:2px solid rgba(0,0,0,.10);
      overflow:hidden; position:relative;
    }
    .pod .pPic img{ width:100%; height:100%; object-fit:cover; }
    .pod .pName{ font-weight:1000; max-width:100%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .pod .pBal{ font-weight:1000; }
    .lbList .lbRow{
      display:flex; align-items:center; gap:10px;
      background:#f1f1f1; border:1px solid rgba(0,0,0,.08);
      border-radius:18px; padding:10px; margin-top:10px;
    }
    .lbN{ width:34px; text-align:center; font-weight:1000; }
    .lbPic{ width:42px; height:42px; border-radius:999px; background:#ddd; overflow:hidden; border:1px solid rgba(0,0,0,.10); }
    .lbPic img{ width:100%; height:100%; object-fit:cover; }
    .lbMain{ flex:1; min-width:0; }
    .lbName{ font-weight:1000; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .lbMeta{ font-size:12px; font-weight:900; color:var(--muted); margin-top:3px; }
    .lbBal{ font-weight:1000; white-space:nowrap; }

    /* Blogs */
    .blogGrid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:14px;
      margin-top:12px;
    }
    .blogCard{
      background:#fff;
      border:1px solid rgba(0,0,0,.08);
      border-radius:22px;
      box-shadow:var(--shadow2);
      overflow:hidden;
      cursor:pointer;
      transition: transform .08s ease, box-shadow .2s ease;
    }
    .blogCard:hover{ box-shadow:0 18px 40px rgba(0,0,0,.14); }
    .blogCard:active{ transform:translateY(1px); }
    .blogCover{
      height:150px; background:#eaeaea; position:relative;
    }
    .blogCover img{ width:100%; height:100%; object-fit:cover; display:block; }
    .blogBody{ padding:12px; }
    .blogTitle{ font-weight:1000; font-size:16px; margin:0; }
    .blogMeta{ margin-top:6px; font-size:12px; font-weight:900; color:var(--muted); display:flex; gap:10px; flex-wrap:wrap; }
    .blogPreview{ margin-top:8px; font-size:13px; font-weight:900; color:#333; opacity:.9; }

    .blogReadBtn{
      margin-top:10px;
      width:100%;
      border:none;
      border-radius:999px;
      padding:12px;
      font-weight:1000;
      background:rgba(77,171,247,.20);
      border:1px solid rgba(77,171,247,.35);
      cursor:pointer;
    }

    .blogFullCover{
      height:280px;
      border-radius:26px;
      overflow:hidden;
      background:#eaeaea;
      border:1px solid rgba(0,0,0,.08);
      box-shadow:var(--shadow2);
    }
    .blogFullCover img{ width:100%; height:100%; object-fit:cover; }
    .blogFullTitle{ font-size:28px; font-weight:1000; margin:14px 0 6px; }
    .blogFullMeta{ font-size:13px; font-weight:900; color:var(--muted); display:flex; gap:10px; flex-wrap:wrap; }
    .blogBlock{
      background:#fff;
      border:1px solid rgba(0,0,0,.08);
      border-radius:22px;
      box-shadow:var(--shadow2);
      padding:14px;
      margin-top:12px;
    }
    .blogBlock h2{ margin:0 0 8px; }
    .blogBlock p{ margin:0; line-height:1.6; font-weight:800; color:#222; }
    .blogBlock .quote{
      border-left:5px solid rgba(255,159,28,.7);
      padding-left:12px;
      font-style:italic;
      color:#333;
    }
    .blogBlock img{ width:100%; border-radius:18px; border:1px solid rgba(0,0,0,.08); }
    .ytWrap{
      position:relative; width:100%;
      aspect-ratio: 16 / 9;
      border-radius:18px;
      overflow:hidden;
      border:1px solid rgba(0,0,0,.08);
      background:#000;
    }
    .ytWrap iframe{ position:absolute; inset:0; width:100%; height:100%; border:0; }

    /* Editor bottom toolbar */
    .editorBar{
      position:sticky;
      bottom:0;
      margin-top:12px;
      background:#111;
      color:#fff;
      border-radius:22px;
      padding:10px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      box-shadow:0 18px 50px rgba(0,0,0,.22);
    }
    .edBtn{
      border:none;
      background:rgba(255,255,255,.10);
      color:#fff;
      font-weight:1000;
      border-radius:16px;
      padding:10px 12px;
      cursor:pointer;
    }
    .edBtn:active{ transform: translateY(1px); }
    .edBtn.orange{ background: rgba(255,159,28,.95); color:#111; }
    .edBtn.blue{ background: rgba(77,171,247,.95); color:#111; }
    .edBtn.green{ background: rgba(58,219,118,.95); color:#111; }

    @media (max-width: 1050px){
      :root{ --sidebarW: 280px; }
      .profilePanel{min-width: 420px;}
      .contentGrid{grid-template-columns:1fr; }
      .blogGrid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 820px){
      .layout{grid-template-columns:1fr;}
      .sidebar{position:relative;height:auto}
      .profilePanel{min-width:unset}
      .topRow{flex-direction:column;align-items:stretch}
      .blogGrid{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="layout">

    <aside class="sidebar">
      <div class="brand">
        <span>Orion Bank üíé</span>
        <span style="font-weight:1000;opacity:.95">Desktop</span>
      </div>

      <div class="sideBlock">
        <div class="sideTitle">Navigation</div>
        <div class="sideSub">Bank ‚Ä¢ Leaderboard ‚Ä¢ Blogs</div>

        <div class="nav">
          <button id="nav_dash" class="active" onclick="switchView('dash')">üè† Dashboard</button>
          <button id="nav_wallet" onclick="switchView('wallet')">üíº Wallet</button>
          <button id="nav_send" onclick="switchView('send')">üì§ Send Gems</button>
          <button id="nav_requests" onclick="switchView('requests')">üì• Requests</button>
          <button id="nav_leaderboard" onclick="switchView('leaderboard')">üèÜ Leaderboard</button>
          <button id="nav_blogs" onclick="switchView('blogs')">üì∞ Announcements</button>
          <button id="nav_profile" onclick="switchView('profile')">üë§ Profile</button>
        </div>

        <div class="divider"></div>

        <div class="sideTitle">Account</div>
        <div class="sideActions">
          <button class="btn orange" onclick="openAuth()">Login</button>
          <button class="btn blue" onclick="openAuth(true)">Register</button>
        </div>
        <button class="btn red" style="width:100%;margin-top:10px;display:none" id="logoutBtn" onclick="logout()">Logout</button>

        <div class="divider"></div>
        <div class="sideSub" id="sideUser">Not signed in</div>
      </div>

      <div class="sideBlock">
        <div class="sideTitle">Quick Tools</div>
        <div class="sideSub">Testing & refresh</div>
        <div class="sideActions" style="grid-template-columns:1fr 1fr">
          <button class="btn gray" onclick="refreshAll()">Refresh</button>
          <button class="btn green" onclick="openReq('deposit')">+ Request</button>
        </div>
        <button class="btn orange" style="width:100%;margin-top:10px" onclick="openReq('withdraw')">- Request</button>
      </div>

      <div class="sideBlock">
        <div class="sideTitle">Badges</div>
        <div class="sideSub">
          Starter ‚Ä¢ Grinder ‚Ä¢ Elite ‚Ä¢ Boss ‚Ä¢ Master<br>
          <b>Cosmic</b> (20B+) ‚Ä¢ <b>Celestial</b> (70B+ ‚ú®)
        </div>
      </div>

    </aside>

    <main class="main">
      <div class="topRow">
        <div class="welcomeCard">
          <div>
            <h1 class="welcomeTitle" id="welcomeTitle">Welcome to Orion üíé</h1>
            <div class="welcomeSub" id="welcomeSub">Register first to create your bank profile.</div>
          </div>
          <div class="statusPill">
            <span>üõ°Ô∏è</span>
            <span id="modeText">Guest Mode</span>
          </div>
        </div>

        <div class="profilePanel">
          <div class="avatar placeholder frame-starter" id="avatarBox"></div>

          <div class="pInfo">
            <div class="pName" id="pName">Guest</div>

            <div class="pMeta">
              <span class="pill orange" id="rolePill">Role: ‚Äî</span>
              <span class="pill blue" id="idPill">ID: ‚Äî</span>
              <span class="pill purple" id="adminPill" style="display:none">Admin</span>
            </div>

            <div class="balanceLine">
              <div class="balLabel">Balance</div>
              <div class="balValue" id="balText">0 üíé</div>
            </div>
          </div>
        </div>
      </div>

      <!-- DASH -->
      <div class="view show" id="view_dash">
        <div class="contentGrid">
          <section class="panel">
            <div class="panelHeader">
              <div>
                <h2 class="panelTitle">Overview</h2>
                <div class="panelSub">Backend + JSON saving enabled</div>
              </div>
              <span class="pill green" id="statusPill">Ready</span>
            </div>

            <div class="row2">
              <div class="panel" style="padding:12px;border-radius:22px;background:#fff;border:1px solid rgba(0,0,0,.08)">
                <div style="font-weight:1000">Your Gems</div>
                <div style="margin-top:8px;font-size:26px;font-weight:1000" id="dashBal">0 üíé</div>
                <div class="panelSub" style="margin-top:8px">Balance updates after admin approves</div>
              </div>
              <div class="panel" style="padding:12px;border-radius:22px;background:#fff;border:1px solid rgba(0,0,0,.08)">
                <div style="font-weight:1000">Role Rank</div>
                <div style="margin-top:8px;font-size:22px;font-weight:1000" id="dashRole">‚Äî</div>
                <div class="panelSub" style="margin-top:8px">Badges + frames scale up</div>
              </div>
            </div>

            <div class="divider"></div>

            <div class="panelSub" style="font-weight:1000">Recent Activity</div>
            <div class="list" id="txList"></div>
            <div class="panelSub" id="txEmpty" style="display:none;margin-top:8px">No activity yet.</div>
          </section>

          <section class="panel">
            <div class="panelHeader">
              <div>
                <h2 class="panelTitle">Actions</h2>
                <div class="panelSub">Requests go pending ‚Üí admin approves</div>
              </div>
              <span class="pill orange">üíé</span>
            </div>

            <button class="btn green" style="width:100%" onclick="openReq('deposit')">+ Deposit Request</button>
            <button class="btn orange" style="width:100%;margin-top:10px" onclick="openReq('withdraw')">- Withdraw Request</button>

            <div class="divider"></div>

            <div class="panelSub" style="font-weight:1000">Admin</div>
            <div class="panelSub">
              Login as <b>JuniorCosmicLeague</b> / <b>Celestial</b> to approve/decline requests.
            </div>
          </section>
        </div>
      </div>

      <!-- WALLET -->
      <div class="view" id="view_wallet">
        <section class="panel">
          <div class="panelHeader">
            <div>
              <h2 class="panelTitle">Wallet</h2>
              <div class="panelSub">Your personal requests</div>
            </div>
            <span class="pill blue">üíº</span>
          </div>

          <div class="list" id="myReqList"></div>
          <div class="panelSub" id="myReqEmpty" style="display:none">No requests yet.</div>
        </section>
      </div>

      <!-- SEND -->
      <div class="view" id="view_send">
        <section class="panel">
          <div class="panelHeader">
            <div>
              <h2 class="panelTitle">Send Gems</h2>
              <div class="panelSub">Transfers require enough balance</div>
            </div>
            <span class="pill orange">üì§</span>
          </div>

          <div class="row2">
            <div>
              <label>To Username</label>
              <input id="sendTo" placeholder="e.g ItalyCrazyCat">
            </div>
            <div>
              <label>Amount</label>
              <input id="sendAmt" placeholder="e.g 5M / 250K / 5000000">
            </div>
          </div>

          <button class="btn blue" style="width:220px;margin-top:12px" onclick="sendGems()">Send</button>
          <div class="error" id="sendErr"></div>
        </section>
      </div>

      <!-- REQUESTS -->
      <div class="view" id="view_requests">
        <section class="panel">
          <div class="panelHeader">
            <div>
              <h2 class="panelTitle">All Requests</h2>
              <div class="panelSub">Admin can approve/decline (same UI)</div>
            </div>
            <span class="pill green">üì•</span>
          </div>

          <div class="list" id="allReqList"></div>
          <div class="panelSub" id="allReqEmpty" style="display:none">No requests yet.</div>
        </section>
      </div>

      <!-- LEADERBOARD -->
      <div class="view" id="view_leaderboard">
        <section class="panel">
          <div class="panelHeader">
            <div>
              <h2 class="panelTitle">Leaderboard</h2>
              <div class="panelSub">Top balances ‚Ä¢ avatars ‚Ä¢ rank ‚Ä¢ vacant slots show ‚Äú-------------‚Äù</div>
            </div>
            <span class="pill gold">üèÜ</span>
          </div>

          <div class="podium" id="podium"></div>

          <div class="divider"></div>

          <div class="lbList" id="lbList"></div>
        </section>
      </div>

      <!-- BLOGS -->
      <div class="view" id="view_blogs">
        <section class="panel" id="blogsHomePanel">
          <div class="panelHeader">
            <div>
              <h2 class="panelTitle">Announcements</h2>
              <div class="panelSub">3 per row ‚Ä¢ click to read full page ‚Ä¢ comments at bottom</div>
            </div>
            <div style="display:flex;gap:10px;align-items:center">
              <button class="btn purple" id="newPostBtn" style="display:none" onclick="openEditor()">+ New Post</button>
              <button class="btn gray" onclick="loadPosts()">Refresh</button>
            </div>
          </div>

          <div class="blogGrid" id="blogGrid"></div>
          <div class="panelSub" id="blogEmpty" style="display:none;margin-top:10px">No posts yet.</div>
        </section>

        <!-- Full Post View -->
        <section class="panel" id="blogReadPanel" style="display:none">
          <div style="display:flex;gap:10px;align-items:center;justify-content:space-between">
            <button class="btn gray" onclick="backToBlogs()">‚Üê Back</button>
            <div style="display:flex;gap:10px">
              <button class="btn purple" id="editPostBtn" style="display:none" onclick="editCurrentPost()">Edit</button>
              <button class="btn gray" onclick="loadCurrentPost()">Refresh</button>
            </div>
          </div>

          <div id="blogReadContent"></div>

          <div class="divider"></div>

          <div style="font-weight:1000">Comments</div>
          <div class="list" id="commentList"></div>
          <div class="panelSub" id="commentEmpty" style="display:none;margin-top:10px">No comments yet.</div>

          <div class="divider"></div>

          <div class="row2">
            <div style="grid-column:1/-1">
              <label>Add a comment</label>
              <textarea id="commentText" placeholder="Write something..."></textarea>
              <div class="error" id="commentErr"></div>
              <button class="btn blue" style="width:220px;margin-top:10px" onclick="postComment()">Post Comment</button>
            </div>
          </div>
        </section>

        <!-- Admin Editor -->
        <section class="panel" id="editorPanel" style="display:none">
          <div style="display:flex;gap:10px;align-items:center;justify-content:space-between">
            <button class="btn gray" onclick="closeEditor()">‚Üê Back</button>
            <div style="display:flex;gap:10px">
              <button class="btn gray" onclick="clearEditor()">Clear</button>
              <button class="btn green" onclick="publishPost()">Publish</button>
            </div>
          </div>

          <div class="divider"></div>

          <div class="row2">
            <div style="grid-column:1/-1">
              <label>Title</label>
              <input id="edTitle" placeholder="e.g Christmas Update!">
            </div>

            <div style="grid-column:1/-1">
              <label>Cover image</label>
              <input type="file" id="edCoverFile" accept="image/*">
              <div class="panelSub">Optional. We compress before upload.</div>
            </div>
          </div>

          <div class="divider"></div>

          <div style="font-weight:1000;margin-bottom:8px">Content (Blocks)</div>
          <div class="panelSub">Tap tools below to insert Text / Image / YouTube blocks.</div>

          <div id="edBlocks"></div>

          <div class="editorBar">
            <div style="display:flex;gap:10px;align-items:center">
              <button class="edBtn" onclick="insertTextBlock()">Aa</button>
              <button class="edBtn" onclick="insertImageBlock()">üñº Image</button>
              <button class="edBtn" onclick="insertYouTubeBlock()">‚ñ∂ YouTube</button>
            </div>
            <div style="display:flex;gap:10px;align-items:center">
              <button class="edBtn blue" onclick="previewPost()">Preview</button>
              <button class="edBtn green" onclick="publishPost()">Publish</button>
            </div>
          </div>
        </section>
      </div>

      <!-- PROFILE -->
      <div class="view" id="view_profile">
        <section class="panel">
          <div class="panelHeader">
            <div>
              <h2 class="panelTitle">Profile</h2>
              <div class="panelSub">Upload avatar (compressed) + role frame</div>
            </div>
            <span class="pill blue">üë§</span>
          </div>

          <div class="row2">
            <div class="panel" style="padding:12px;border-radius:22px;background:#fff;border:1px solid rgba(0,0,0,.08)">
              <div style="font-weight:1000">Avatar</div>
              <div class="panelSub" style="margin-top:8px">Works after login</div>
              <input type="file" id="avatarInput" accept="image/*" />
              <button class="btn gray" style="width:220px;margin-top:10px" onclick="saveAvatar()">Save Avatar</button>
              <div class="panelSub" style="margin-top:8px">Auto-compressed before upload ‚úÖ</div>
            </div>

            <div class="panel" style="padding:12px;border-radius:22px;background:#fff;border:1px solid rgba(0,0,0,.08)">
              <div style="font-weight:1000">Role Rules</div>
              <div class="panelSub" style="margin-top:10px;line-height:1.6">
                0 ‚Üí Starter<br>
                1M+ ‚Üí Grinder<br>
                50M+ ‚Üí Elite<br>
                250M+ ‚Üí Boss<br>
                2B+ ‚Üí Master<br>
                20B+ ‚Üí <b>Cosmic</b><br>
                70B+ ‚Üí <b>Celestial</b> ‚ú® (shining frame)
              </div>
            </div>
          </div>
        </section>
      </div>

    </main>
  </div>

  <!-- AUTH MODAL -->
  <div class="modal" id="authModal">
    <div class="modalBox">
      <button class="closeX" onclick="closeAuth()">‚úï</button>
      <div class="modalTitle" id="authTitle">Login</div>
      <div class="modalSub" id="authSub">Sign in to access your balance and profile.</div>

      <div class="row2">
        <div>
          <label>Username</label>
          <input id="authUser" placeholder="e.g JRCHESSKID">
        </div>
        <div>
          <label>Password</label>
          <input id="authPass" type="password" placeholder="your password">
        </div>
      </div>

      <div class="error" id="authErr"></div>

      <div style="display:flex;gap:10px;justify-content:center;margin-top:12px">
        <button class="btn gray" style="width:160px" onclick="closeAuth()">Cancel</button>
        <button class="btn orange" style="width:160px" id="authActionBtn" onclick="login()">Login</button>
      </div>
    </div>
  </div>

  <!-- REQUEST MODAL -->
  <div class="modal" id="reqModal">
    <div class="modalBox">
      <button class="closeX" onclick="closeReq()">‚úï</button>
      <div class="modalTitle" id="reqTitle">Request</div>
      <div class="modalSub">Creates a pending request</div>

      <label>Amount</label>
      <input id="reqAmt" placeholder="e.g 5M / 250K / 5000000">
      <div class="error" id="reqErr"></div>

      <div style="display:flex;gap:10px;justify-content:center;margin-top:12px">
        <button class="btn gray" style="width:160px" onclick="closeReq()">Cancel</button>
        <button class="btn green" style="width:160px" onclick="submitReq()">Submit</button>
      </div>
    </div>
  </div>

  <!-- SIMPLE INPUT MODAL (used by editor tools) -->
  <div class="modal" id="simpleModal">
    <div class="modalBox">
      <button class="closeX" onclick="closeSimple()">‚úï</button>
      <div class="modalTitle" id="simpleTitle">Input</div>
      <div class="modalSub" id="simpleSub">Enter value</div>
      <textarea id="simpleValue" style="min-height:140px"></textarea>
      <div class="error" id="simpleErr"></div>
      <div style="display:flex;gap:10px;justify-content:center;margin-top:12px">
        <button class="btn gray" style="width:160px" onclick="closeSimple()">Cancel</button>
        <button class="btn blue" style="width:160px" id="simpleOk">OK</button>
      </div>
    </div>
  </div>

<script>
  // =========================
  // CONFIG
  // =========================
  const API_BASE = "https://4e74ae9e-afad-4327-981d-85a4a2d2c6bd-00-1v9sw5mrqqnf3.riker.replit.dev";
  const TOKEN_KEY = "orion_token_v1";

  // LOG OUT EVERY TIME PAGE OPENS (your request)
  localStorage.removeItem(TOKEN_KEY);

  let sessionUser = null; // { username, id, balance, avatarDataUrl, role, isAdmin }
  let db = { requests:[], tx:[] };
  let lb = []; // leaderboard list

  let view = "dash";
  let pendingType = "deposit";

  // Blogs state
  let posts = [];
  let currentPostId = "";
  let editingPostId = ""; // "" => new post
  let editorBlocks = [];
  let editorCoverDataUrl = "";

  const $ = (id)=>document.getElementById(id);
  function norm(s){ return (s||"").trim(); }
  function fmt(n){ return (Number(n)||0).toLocaleString("en-US"); }

  function parseAmount(val){
    val = (val||"").toUpperCase().trim().replace(/,/g,"");
    if(!val) return NaN;
    if(val.endsWith("K")) return Math.floor(parseFloat(val.slice(0,-1))*1000);
    if(val.endsWith("M")) return Math.floor(parseFloat(val.slice(0,-1))*1000000);
    if(val.endsWith("B")) return Math.floor(parseFloat(val.slice(0,-1))*1000000000);
    const n = Number(val);
    return Number.isFinite(n) ? Math.floor(n) : NaN;
  }

  function roleFromBalance(b){
    b = Number(b)||0;
    if(b >= 70000000000) return "Celestial";
    if(b >= 20000000000) return "Cosmic";
    if(b >= 2000000000) return "Master";
    if(b >= 250000000) return "Boss";
    if(b >= 50000000) return "Elite";
    if(b >= 1000000) return "Grinder";
    return "Starter";
  }

  function roleBadge(role){
    if(role === "Celestial") return { cls:"pill gold", txt:"‚ú® Celestial" };
    if(role === "Cosmic") return { cls:"pill gold", txt:"üåå Cosmic" };
    if(role === "Master") return { cls:"pill purple", txt:"üü£ Master" };
    if(role === "Boss") return { cls:"pill orange", txt:"üü† Boss" };
    if(role === "Elite") return { cls:"pill green", txt:"üü¢ Elite" };
    if(role === "Grinder") return { cls:"pill blue", txt:"üîµ Grinder" };
    return { cls:"pill orange", txt:"üü† Starter" };
  }

  function frameClass(role){
    if(role === "Celestial") return "frame-celestial";
    if(role === "Cosmic") return "frame-cosmic";
    if(role === "Master") return "frame-master";
    if(role === "Boss") return "frame-boss";
    if(role === "Elite") return "frame-elite";
    if(role === "Grinder") return "frame-grinder";
    return "frame-starter";
  }

  // ---------- API ----------
  function getToken(){ return localStorage.getItem(TOKEN_KEY) || ""; }
  function setToken(t){ localStorage.setItem(TOKEN_KEY, t); }
  function clearToken(){ localStorage.removeItem(TOKEN_KEY); }

  async function api(path, opts={}){
    const headers = Object.assign({ "Content-Type":"application/json" }, opts.headers||{});
    const t = getToken();
    if(t) headers.Authorization = "Bearer " + t;

    const res = await fetch(API_BASE + path, { ...opts, headers });
    const data = await res.json().catch(()=>({}));
    if(!res.ok) throw new Error(data.error || "Request failed");
    return data;
  }

  async function refreshState(){
    if(!getToken()){
      sessionUser = null;
      db = { requests:[], tx:[] };
      renderAll();
      return;
    }
    const st = await api("/api/state");
    sessionUser = st.user;
    db.tx = st.tx || [];
    db.requests = st.requests || [];
    renderAll();
  }

  async function loadLeaderboard(){
    const r = await api("/api/leaderboard");
    lb = r.list || [];
    renderLeaderboard();
  }

  async function loadPosts(){
    const r = await api("/api/posts", { method:"GET", headers:{} });
    posts = r.list || [];
    renderPostsGrid();
  }

  async function loadCurrentPost(){
    if(!currentPostId) return;
    const r = await api("/api/posts/" + currentPostId, { method:"GET", headers:{} });
    renderFullPost(r.post, r.comments || []);
  }

  // ---------- Views ----------
  function switchView(v){
    view = v;
    ["dash","wallet","send","requests","leaderboard","blogs","profile"].forEach(x=>{
      $("view_"+x).classList.remove("show");
      $("nav_"+x).classList.remove("active");
    });
    $("view_"+v).classList.add("show");
    $("nav_"+v).classList.add("active");

    if(v === "leaderboard") loadLeaderboard().catch(()=>{});
    if(v === "blogs") loadPosts().catch(()=>{});

    renderAll();
  }

  // ---------- Auth ----------
  function openAuth(registerMode=false){
    $("authErr").textContent = "";
    $("authUser").value = "";
    $("authPass").value = "";
    $("authTitle").textContent = registerMode ? "Register" : "Login";
    $("authSub").textContent = registerMode
      ? "Create your account. Balance starts at 0 üíé."
      : "Sign in to access your balance and profile.";
    $("authActionBtn").textContent = registerMode ? "Register" : "Login";
    $("authActionBtn").onclick = registerMode ? register : login;
    $("authModal").style.display = "flex";
  }
  function closeAuth(){ $("authModal").style.display = "none"; }

  async function register(){
    const u = norm($("authUser").value);
    const p = $("authPass").value || "";
    $("authErr").textContent = "";
    if(!u || !p){ $("authErr").textContent = "Enter username + password."; return; }

    try{
      await api("/api/register", { method:"POST", body: JSON.stringify({ username:u, password:p }) });
      const loginRes = await api("/api/login", { method:"POST", body: JSON.stringify({ username:u, password:p }) });
      setToken(loginRes.token);
      closeAuth();
      await refreshState();
    }catch(err){ $("authErr").textContent = err.message; }
  }

  async function login(){
    const u = norm($("authUser").value);
    const p = $("authPass").value || "";
    $("authErr").textContent = "";
    if(!u || !p){ $("authErr").textContent = "Enter username + password."; return; }

    try{
      const loginRes = await api("/api/login", { method:"POST", body: JSON.stringify({ username:u, password:p }) });
      setToken(loginRes.token);
      closeAuth();
      await refreshState();
    }catch(err){ $("authErr").textContent = err.message; }
  }

  async function logout(){
    try{ await api("/api/logout", { method:"POST" }); } catch {}
    clearToken();
    sessionUser = null;
    db = { requests:[], tx:[] };
    currentPostId = "";
    renderAll();
    switchView("dash");
  }

  // ---------- Requests ----------
  function openReq(type){
    pendingType = type;
    $("reqTitle").textContent = (type === "deposit" ? "Deposit Request" : "Withdraw Request");
    $("reqAmt").value = "";
    $("reqErr").textContent = "";
    $("reqModal").style.display = "flex";
  }
  function closeReq(){ $("reqModal").style.display = "none"; }

  async function submitReq(){
    $("reqErr").textContent = "";
    if(!sessionUser){ $("reqErr").textContent = "Register/Login first."; return; }
    const amt = parseAmount($("reqAmt").value);
    if(!Number.isFinite(amt) || amt <= 0){ $("reqErr").textContent = "Invalid amount."; return; }

    try{
      await api("/api/request", { method:"POST", body: JSON.stringify({ type: pendingType, amount: amt }) });
      closeReq();
      await refreshState();
    }catch(err){ $("reqErr").textContent = err.message; }
  }

  async function approveReq(id){
    try{
      await api(`/api/admin/request/${id}/approve`, { method:"POST", body: "{}" });
      await refreshState();
      if(view === "leaderboard") loadLeaderboard().catch(()=>{});
    }catch(e){ alert(e.message); }
  }
  async function declineReq(id){
    try{
      await api(`/api/admin/request/${id}/decline`, { method:"POST", body: "{}" });
      await refreshState();
    }catch(e){ alert(e.message); }
  }

  // ---------- Send ----------
  async function sendGems(){
    $("sendErr").textContent = "";
    if(!sessionUser){ $("sendErr").textContent = "Register/Login first."; return; }

    const to = norm($("sendTo").value);
    const amt = parseAmount($("sendAmt").value);

    if(!to){ $("sendErr").textContent = "Enter a recipient username."; return; }
    if(!Number.isFinite(amt) || amt <= 0){ $("sendErr").textContent = "Invalid amount."; return; }

    try{
      await api("/api/send", { method:"POST", body: JSON.stringify({ to, amount: amt }) });
      $("sendTo").value = "";
      $("sendAmt").value = "";
      await refreshState();
      switchView("dash");
    }catch(err){ $("sendErr").textContent = err.message; }
  }

  // ---------- Image compress helper (fix avatar & cover crashes) ----------
  function compressImageToDataURL(file, maxW=900, quality=0.72){
    return new Promise((resolve, reject)=>{
      const img = new Image();
      const reader = new FileReader();
      reader.onload = () => { img.src = reader.result; };
      reader.onerror = reject;
      img.onload = () => {
        const scale = Math.min(1, maxW / img.width);
        const w = Math.floor(img.width * scale);
        const h = Math.floor(img.height * scale);
        const canvas = document.createElement("canvas");
        canvas.width = w; canvas.height = h;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, w, h);
        resolve(canvas.toDataURL("image/jpeg", quality));
      };
      img.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  // ---------- Avatar ----------
  async function saveAvatar(){
    if(!sessionUser){ alert("Register/Login first."); return; }
    const file = $("avatarInput").files[0];
    if(!file){ alert("Choose an image first."); return; }

    try{
      const dataUrl = await compressImageToDataURL(file, 420, 0.75);
      await api("/api/avatar", { method:"POST", body: JSON.stringify({ avatarDataUrl: dataUrl }) });
      await refreshState();
      alert("Avatar saved ‚úÖ");
      if(view === "leaderboard") loadLeaderboard().catch(()=>{});
    }catch(err){
      alert(err.message || "Avatar failed");
    }
  }

  // ---------- Time ----------
  function timeAgo(ts){
    const mins = Math.floor((Date.now()-ts)/60000);
    if(mins < 1) return "Just now";
    if(mins < 60) return mins + " min ago";
    const hrs = Math.floor(mins/60);
    if(hrs < 24) return hrs + "h ago";
    const d = Math.floor(hrs/24);
    return d + "d ago";
  }
  function fmtDate(ts){
    const d = new Date(ts);
    return d.toLocaleDateString(undefined, { year:"numeric", month:"long", day:"numeric" });
  }

  // ---------- Render: Profile top panel ----------
  function renderProfilePanel(){
    const avatarBox = $("avatarBox");
    const balText = $("balText");
    const dashBal = $("dashBal");
    const dashRole = $("dashRole");

    if(!sessionUser){
      $("pName").textContent = "Guest";
      $("sideUser").textContent = "Not signed in";
      $("welcomeTitle").textContent = "Welcome to Orion üíé";
      $("welcomeSub").textContent = "Register first to create your bank profile.";
      $("logoutBtn").style.display = "none";
      $("adminPill").style.display = "none";
      $("newPostBtn").style.display = "none";

      avatarBox.className = "avatar placeholder frame-starter";
      avatarBox.innerHTML = "";

      $("rolePill").className = "pill orange";
      $("rolePill").textContent = "Role: ‚Äî";
      $("idPill").textContent = "ID: ‚Äî";

      balText.textContent = "0 üíé";
      dashBal.textContent = "0 üíé";
      dashRole.textContent = "‚Äî";
      return;
    }

    const bal = sessionUser.balance || 0;
    const role = sessionUser.role || roleFromBalance(bal);
    const badge = roleBadge(role);

    $("pName").textContent = sessionUser.username;
    $("sideUser").textContent = `${sessionUser.username} ‚Ä¢ ID ${sessionUser.id}`;
    $("welcomeTitle").textContent = `Hey ${sessionUser.username} üëã`;
    $("welcomeSub").textContent = "Backend connected ‚Ä¢ JSON saving enabled.";
    $("logoutBtn").style.display = "block";

    $("idPill").textContent = "ID: " + sessionUser.id;
    $("rolePill").className = badge.cls;
    $("rolePill").textContent = "Role: " + badge.txt;

    $("adminPill").style.display = sessionUser.isAdmin ? "inline-flex" : "none";
    $("newPostBtn").style.display = sessionUser.isAdmin ? "inline-block" : "none";
    $("editPostBtn").style.display = (sessionUser.isAdmin && currentPostId) ? "inline-block" : "none";

    balText.textContent = `${fmt(bal)} üíé`;
    dashBal.textContent = `${fmt(bal)} üíé`;
    dashRole.textContent = role;

    const frame = frameClass(role);

    if(sessionUser.avatarDataUrl){
      avatarBox.className = `avatar ${frame}`;
      avatarBox.innerHTML = `<img alt="avatar" src="${sessionUser.avatarDataUrl}">`;
    }else{
      avatarBox.className = `avatar placeholder ${frame}`;
      avatarBox.innerHTML = "";
    }
  }

  // ---------- Render: Tx ----------
  function renderTx(){
    const list = $("txList");
    list.innerHTML = "";
    const tx = (db.tx || []).slice(0,6);

    if(tx.length === 0){
      $("txEmpty").style.display = "block";
      return;
    }
    $("txEmpty").style.display = "none";

    tx.forEach(t=>{
      const div = document.createElement("div");
      div.className = "item";

      let icon = "üßæ";
      let top = t.kind || "Activity";
      let sub = timeAgo(t.time || Date.now());
      let amt = `<div class="iAmt">‚Äî</div>`;

      if(t.kind === "send"){
        icon = "üì§";
        top = `Sent to @${t.to}`;
        sub = `From @${t.from} ‚Ä¢ ${timeAgo(t.time)}`;
        amt = `<div class="iAmt neg">- ${fmt(t.amount)} üíé</div>`;
      }
      if(t.kind === "deposit_approved"){
        icon = "‚ûï";
        top = `Deposit approved for @${t.from}`;
        sub = timeAgo(t.time);
        amt = `<div class="iAmt pos">+ ${fmt(t.amount)} üíé</div>`;
      }
      if(t.kind === "withdraw_approved"){
        icon = "‚ûñ";
        top = `Withdraw approved for @${t.from}`;
        sub = timeAgo(t.time);
        amt = `<div class="iAmt neg">- ${fmt(t.amount)} üíé</div>`;
      }

      div.innerHTML = `
        <div class="iIcon">${icon}</div>
        <div class="iMain">
          <div class="iTop">${top}</div>
          <div class="iSub">${sub}</div>
        </div>
        ${amt}
      `;
      list.appendChild(div);
    });
  }

  // ---------- Render: Requests ----------
  function renderRequests(){
    const myReqList = $("myReqList");
    const allReqList = $("allReqList");
    myReqList.innerHTML = "";
    allReqList.innerHTML = "";

    const my = sessionUser ? (db.requests || []).filter(r => r.user === sessionUser.username) : [];
    const all = db.requests || [];

    $("myReqEmpty").style.display = my.length ? "none" : "block";
    $("allReqEmpty").style.display = all.length ? "none" : "block";

    const makeItem = (r) => {
      const div = document.createElement("div");
      div.className = "item";
      const icon = r.type === "deposit" ? "‚ûï" : "‚ûñ";
      const amtClass = r.type === "deposit" ? "pos" : "neg";

      const adminBtns = (sessionUser && sessionUser.isAdmin && r.status === "pending")
        ? `
          <div style="display:flex;gap:8px">
            <button class="btn green" style="padding:10px 12px;border-radius:14px;box-shadow:none" onclick="approveReq('${r.id}')">Approve</button>
            <button class="btn red" style="padding:10px 12px;border-radius:14px;box-shadow:none" onclick="declineReq('${r.id}')">Decline</button>
          </div>
        `
        : "";

      div.innerHTML = `
        <div class="iIcon">${icon}</div>
        <div class="iMain">
          <div class="iTop">@${r.user} ‚Ä¢ ${fmt(r.amount)} üíé</div>
          <div class="iSub">${String(r.status||"pending").toUpperCase()} ‚Ä¢ ${timeAgo(r.time)}</div>
        </div>
        <div class="iAmt ${amtClass}">${r.type === "deposit" ? "+" : "-"} ${fmt(r.amount)} üíé</div>
        ${adminBtns}
      `;
      return div;
    };

    my.slice(0,12).forEach(r => myReqList.appendChild(makeItem(r)));
    all.slice(0,30).forEach(r => allReqList.appendChild(makeItem(r)));
  }

  // ---------- Render: Leaderboard ----------
  function renderLeaderboard(){
    const podium = $("podium");
    const list = $("lbList");
    podium.innerHTML = "";
    list.innerHTML = "";

    // Top 3 slots with vacancies
    const top3 = [lb[1], lb[0], lb[2]]; // center as #1
    const labels = ["#2", "#1", "#3"];

    top3.forEach((u, i)=>{
      const card = document.createElement("div");
      card.className = "pod";
      if(!u){
        card.innerHTML = `
          <div class="rankTag">${labels[i]}</div>
          <div class="pPic"></div>
          <div class="pName">-------------</div>
          <div class="pBal">-------------</div>
          <div class="panelSub">Vacant</div>
        `;
      }else{
        const role = u.role || roleFromBalance(u.balance||0);
        card.innerHTML = `
          <div class="rankTag">${labels[i]}</div>
          <div class="pPic"><img src="${u.avatarDataUrl || ""}" onerror="this.style.display='none'"></div>
          <div class="pName">${u.username}</div>
          <div class="pBal">${fmt(u.balance)} üíé</div>
          <div class="panelSub">${role}</div>
        `;
      }
      podium.appendChild(card);
    });

    // rest list
    const rest = lb.slice(3);
    if(rest.length === 0){
      const empty = document.createElement("div");
      empty.className = "panelSub";
      empty.style.marginTop = "10px";
      empty.textContent = "No more users yet.";
      list.appendChild(empty);
      return;
    }

    rest.forEach((u, idx)=>{
      const rank = idx + 4;
      const row = document.createElement("div");
      row.className = "lbRow";
      const role = u.role || roleFromBalance(u.balance||0);
      row.innerHTML = `
        <div class="lbN">${rank}</div>
        <div class="lbPic"><img src="${u.avatarDataUrl || ""}" onerror="this.style.display='none'"></div>
        <div class="lbMain">
          <div class="lbName">${u.username}</div>
          <div class="lbMeta">${role} ‚Ä¢ ID ${u.id}</div>
        </div>
        <div class="lbBal">${fmt(u.balance)} üíé</div>
      `;
      list.appendChild(row);
    });
  }

  // ---------- Blogs: grid ----------
  function renderPostsGrid(){
    const grid = $("blogGrid");
    grid.innerHTML = "";

    $("blogEmpty").style.display = posts.length ? "none" : "block";

    posts.forEach(p=>{
      const card = document.createElement("div");
      card.className = "blogCard";
      card.onclick = ()=> openPost(p.id);
      card.innerHTML = `
        <div class="blogCover">${p.coverImage ? `<img src="${p.coverImage}">` : ""}</div>
        <div class="blogBody">
          <h3 class="blogTitle">${escapeHtml(p.title)}</h3>
          <div class="blogMeta">
            <span>üìÖ ${fmtDate(p.createdAt)}</span>
            <span>üë§ ${escapeHtml(p.author || "Admin")}</span>
          </div>
          <div class="blogPreview">${escapeHtml(p.preview || "‚Äî")}</div>
          <button class="blogReadBtn">Read More ‚Üí</button>
        </div>
      `;
      grid.appendChild(card);
    });
  }

  function backToBlogs(){
    $("blogsHomePanel").style.display = "block";
    $("blogReadPanel").style.display = "none";
    $("editorPanel").style.display = "none";
    currentPostId = "";
    renderProfilePanel();
  }

  async function openPost(id){
    currentPostId = id;
    $("blogsHomePanel").style.display = "none";
    $("editorPanel").style.display = "none";
    $("blogReadPanel").style.display = "block";
    await loadCurrentPost();
    renderProfilePanel();
  }

  function ytIdFromUrl(url){
    url = String(url||"");
    const m1 = url.match(/[?&]v=([a-zA-Z0-9_-]{6,})/);
    if(m1) return m1[1];
    const m2 = url.match(/youtu\.be\/([a-zA-Z0-9_-]{6,})/);
    if(m2) return m2[1];
    const m3 = url.match(/youtube\.com\/shorts\/([a-zA-Z0-9_-]{6,})/);
    if(m3) return m3[1];
    return "";
  }

  function renderFullPost(post, comments){
    const wrap = $("blogReadContent");
    wrap.innerHTML = "";

    const cover = document.createElement("div");
    cover.className = "blogFullCover";
    cover.innerHTML = post.coverImage ? `<img src="${post.coverImage}">` : "";
    wrap.appendChild(cover);

    const title = document.createElement("div");
    title.className = "blogFullTitle";
    title.textContent = post.title;
    wrap.appendChild(title);

    const meta = document.createElement("div");
    meta.className = "blogFullMeta";
    meta.innerHTML = `<span>üìÖ ${fmtDate(post.createdAt)}</span><span>üë§ ${escapeHtml(post.author || "Admin")}</span>`;
    wrap.appendChild(meta);

    (post.blocks || []).forEach(b=>{
      const box = document.createElement("div");
      box.className = "blogBlock";

      if(b.type === "text"){
        const style = b.style || "p";
        if(style === "h2"){
          box.innerHTML = `<h2>${escapeHtml(b.text||"")}</h2>`;
        }else if(style === "quote"){
          box.innerHTML = `<div class="quote">${escapeHtml(b.text||"")}</div>`;
        }else{
          box.innerHTML = `<p>${escapeHtml(b.text||"")}</p>`;
        }
      }

      if(b.type === "image"){
        box.innerHTML = `<img src="${b.src}" onerror="this.style.display='none'">`;
      }

      if(b.type === "youtube"){
        const id = ytIdFromUrl(b.url);
        box.innerHTML = id
          ? `<div class="ytWrap"><iframe src="https://www.youtube.com/embed/${id}" allowfullscreen></iframe></div>`
          : `<div class="panelSub">Invalid YouTube link</div>`;
      }

      wrap.appendChild(box);
    });

    // Comments
    const cl = $("commentList");
    cl.innerHTML = "";
    $("commentEmpty").style.display = comments.length ? "none" : "block";
    comments.slice().reverse().forEach(c=>{
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div class="iIcon">üí¨</div>
        <div class="iMain">
          <div class="iTop">@${escapeHtml(c.user)} ‚Ä¢ ${timeAgo(c.time)}</div>
          <div class="iSub">${escapeHtml(c.text)}</div>
        </div>
      `;
      cl.appendChild(div);
    });

    $("commentText").value = "";
    $("commentErr").textContent = "";
    renderProfilePanel();
  }

  async function postComment(){
    $("commentErr").textContent = "";
    if(!sessionUser){ $("commentErr").textContent = "Login first."; return; }
    const text = norm($("commentText").value);
    if(!text){ $("commentErr").textContent = "Write something."; return; }
    try{
      await api(`/api/posts/${currentPostId}/comment`, { method:"POST", body: JSON.stringify({ text }) });
      await loadCurrentPost();
    }catch(e){
      $("commentErr").textContent = e.message;
    }
  }

  // ---------- Admin Editor ----------
  function openEditor(){
    if(!sessionUser || !sessionUser.isAdmin){ alert("Admin only"); return; }

    editingPostId = "";
    editorBlocks = [];
    editorCoverDataUrl = "";
    $("edTitle").value = "";
    $("edCoverFile").value = "";

    $("blogsHomePanel").style.display = "none";
    $("blogReadPanel").style.display = "none";
    $("editorPanel").style.display = "block";

    renderEditorBlocks();
  }

  async function editCurrentPost(){
    if(!sessionUser || !sessionUser.isAdmin) return;
    if(!currentPostId) return;

    const r = await api("/api/posts/" + currentPostId, { method:"GET", headers:{} });
    const p = r.post;

    editingPostId = p.id;
    editorBlocks = (p.blocks || []).map(x=>JSON.parse(JSON.stringify(x)));
    editorCoverDataUrl = p.coverImage || "";
    $("edTitle").value = p.title || "";
    $("edCoverFile").value = "";

    $("blogsHomePanel").style.display = "none";
    $("blogReadPanel").style.display = "none";
    $("editorPanel").style.display = "block";
    renderEditorBlocks();
  }

  function closeEditor(){
    $("editorPanel").style.display = "none";
    $("blogsHomePanel").style.display = "block";
  }

  function clearEditor(){
    if(!confirm("Clear editor?")) return;
    editingPostId = "";
    editorBlocks = [];
    editorCoverDataUrl = "";
    $("edTitle").value = "";
    $("edCoverFile").value = "";
    renderEditorBlocks();
  }

  function renderEditorBlocks(){
    const wrap = $("edBlocks");
    wrap.innerHTML = "";

    if(editorBlocks.length === 0){
      const hint = document.createElement("div");
      hint.className = "panelSub";
      hint.style.marginTop = "10px";
      hint.textContent = "No blocks yet. Tap Aa / Image / YouTube to add content.";
      wrap.appendChild(hint);
      return;
    }

    editorBlocks.forEach((b, i)=>{
      const box = document.createElement("div");
      box.className = "blogBlock";

      const top = document.createElement("div");
      top.style.display = "flex";
      top.style.justifyContent = "space-between";
      top.style.alignItems = "center";
      top.style.gap = "10px";
      top.innerHTML = `<div style="font-weight:1000">${b.type.toUpperCase()}</div>
        <div style="display:flex;gap:8px">
          <button class="btn gray" style="padding:10px 12px;border-radius:14px;box-shadow:none" onclick="moveBlock(${i},-1)">‚Üë</button>
          <button class="btn gray" style="padding:10px 12px;border-radius:14px;box-shadow:none" onclick="moveBlock(${i},1)">‚Üì</button>
          <button class="btn red" style="padding:10px 12px;border-radius:14px;box-shadow:none" onclick="deleteBlock(${i})">‚úï</button>
        </div>`;
      box.appendChild(top);

      const content = document.createElement("div");
      content.style.marginTop = "10px";

      if(b.type === "text"){
        content.innerHTML = `
          <div class="row2">
            <div>
              <label>Style</label>
              <select id="style_${i}" style="width:100%;border-radius:16px;padding:12px;border:1px solid rgba(0,0,0,.12);font-weight:1000"
                onchange="setTextStyle(${i}, this.value)">
                <option value="p" ${b.style==="p"?"selected":""}>Paragraph</option>
                <option value="h2" ${b.style==="h2"?"selected":""}>Heading</option>
                <option value="quote" ${b.style==="quote"?"selected":""}>Quote</option>
              </select>
            </div>
            <div></div>
          </div>
          <label>Text</label>
          <textarea oninput="setText(${i}, this.value)">${escapeHtml(b.text||"")}</textarea>
        `;
      }

      if(b.type === "image"){
        content.innerHTML = `
          <div class="panelSub">Image preview</div>
          <img src="${b.src}" onerror="this.style.display='none'">
        `;
      }

      if(b.type === "youtube"){
        content.innerHTML = `
          <label>YouTube URL</label>
          <input value="${escapeHtml(b.url||"")}" oninput="setYouTube(${i}, this.value)">
          <div class="panelSub">Paste a YouTube link or youtu.be link</div>
        `;
      }

      box.appendChild(content);
      wrap.appendChild(box);
    });
  }

  function moveBlock(i, dir){
    const j = i + dir;
    if(j < 0 || j >= editorBlocks.length) return;
    const tmp = editorBlocks[i];
    editorBlocks[i] = editorBlocks[j];
    editorBlocks[j] = tmp;
    renderEditorBlocks();
  }
  function deleteBlock(i){
    editorBlocks.splice(i,1);
    renderEditorBlocks();
  }
  function setText(i, v){ editorBlocks[i].text = v; }
  function setTextStyle(i, v){ editorBlocks[i].style = v; }
  function setYouTube(i, v){ editorBlocks[i].url = v; }

  // Insert tools (like your bottom bar)
  function insertTextBlock(){
    openSimple("Add Text", "Write your text. Choose style after.", "", (val)=>{
      editorBlocks.push({ type:"text", style:"p", text: val });
      renderEditorBlocks();
    });
  }

  function insertImageBlock(){
    // Use file picker inline
    const inp = document.createElement("input");
    inp.type = "file";
    inp.accept = "image/*";
    inp.onchange = async () => {
      const file = inp.files[0];
      if(!file) return;
      try{
        const dataUrl = await compressImageToDataURL(file, 1100, 0.72);
        editorBlocks.push({ type:"image", src: dataUrl });
        renderEditorBlocks();
      }catch(e){
        alert("Image failed");
      }
    };
    inp.click();
  }

  function insertYouTubeBlock(){
    openSimple("YouTube", "Paste a YouTube link (watch?v= or youtu.be)", "", (val)=>{
      editorBlocks.push({ type:"youtube", url: val.trim() });
      renderEditorBlocks();
    });
  }

  function previewPost(){
    const title = norm($("edTitle").value) || "Untitled";
    const fake = {
      id: "preview",
      title,
      coverImage: editorCoverDataUrl,
      createdAt: Date.now(),
      author: sessionUser ? sessionUser.username : "Admin",
      blocks: editorBlocks
    };
    renderFullPost(fake, []);
    $("editorPanel").style.display = "none";
    $("blogsHomePanel").style.display = "none";
    $("blogReadPanel").style.display = "block";
    currentPostId = ""; // preview only
    $("editPostBtn").style.display = "none";
  }

  async function publishPost(){
    if(!sessionUser || !sessionUser.isAdmin){ alert("Admin only"); return; }
    const title = norm($("edTitle").value);
    if(!title){ alert("Title required"); return; }

    // cover file optional
    const f = $("edCoverFile").files[0];
    if(f){
      editorCoverDataUrl = await compressImageToDataURL(f, 1200, 0.72);
    }

    const payload = {
      title,
      coverImage: editorCoverDataUrl || "",
      blocks: editorBlocks
    };

    try{
      if(editingPostId){
        await api("/api/admin/posts/" + editingPostId, { method:"PUT", body: JSON.stringify(payload) });
      }else{
        await api("/api/admin/posts", { method:"POST", body: JSON.stringify(payload) });
      }
      alert("Published ‚úÖ");
      editingPostId = "";
      editorBlocks = [];
      editorCoverDataUrl = "";
      $("edTitle").value = "";
      $("edCoverFile").value = "";
      $("editorPanel").style.display = "none";
      $("blogsHomePanel").style.display = "block";
      await loadPosts();
    }catch(e){
      alert(e.message);
    }
  }

  // ---------- Simple modal ----------
  function openSimple(title, sub, value, onOk){
    $("simpleTitle").textContent = title;
    $("simpleSub").textContent = sub;
    $("simpleValue").value = value || "";
    $("simpleErr").textContent = "";
    $("simpleModal").style.display = "flex";
    $("simpleOk").onclick = ()=>{
      const v = $("simpleValue").value;
      $("simpleModal").style.display = "none";
      onOk(v);
    };
  }
  function closeSimple(){ $("simpleModal").style.display = "none"; }

  // ---------- Helpers ----------
  function escapeHtml(s){
    return String(s||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  async function refreshAll(){
    try{
      await refreshState();
      await loadLeaderboard();
      await loadPosts();
    }catch(e){}
  }

  function renderAll(){
    renderProfilePanel();
    renderTx();
    renderRequests();
    $("modeText").textContent = getToken() ? "Backend Mode" : "Guest Mode";
    $("statusPill").textContent = sessionUser ? "Online UI" : "Guest UI";
  }

  // Expose onclick handlers
  window.switchView = switchView;

  window.openAuth = openAuth;
  window.closeAuth = closeAuth;
  window.register = register;
  window.login = login;
  window.logout = logout;

  window.openReq = openReq;
  window.closeReq = closeReq;
  window.submitReq = submitReq;

  window.sendGems = sendGems;
  window.saveAvatar = saveAvatar;

  window.approveReq = approveReq;
  window.declineReq = declineReq;

  window.refreshAll = refreshAll;

  window.loadPosts = loadPosts;
  window.openEditor = openEditor;
  window.closeEditor = closeEditor;
  window.clearEditor = clearEditor;
  window.insertTextBlock = insertTextBlock;
  window.insertImageBlock = insertImageBlock;
  window.insertYouTubeBlock = insertYouTubeBlock;
  window.previewPost = previewPost;
  window.publishPost = publishPost;
  window.backToBlogs = backToBlogs;
  window.postComment = postComment;
  window.editCurrentPost = editCurrentPost;
  window.loadCurrentPost = loadCurrentPost;

  window.moveBlock = moveBlock;
  window.deleteBlock = deleteBlock;
  window.setText = setText;
  window.setTextStyle = setTextStyle;
  window.setYouTube = setYouTube;

  window.closeSimple = closeSimple;

  // Init
  (async function init(){
    renderAll();
    switchView("dash");
    // token already cleared on open => logged out
    // still load public stuff:
    try{ await loadLeaderboard(); }catch(e){}
    try{ await loadPosts(); }catch(e){}
  })();
</script>

</body>
</html>